<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ExpeDatSSMRunDocumet.index &mdash; DCinema Distribution AWS Resources 1.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            DCinema Distribution AWS Resources
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../template.html">Cloudformation Template</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Lambda Function</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">DCinema Distribution AWS Resources</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ExpeDatSSMRunDocumet.index</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ExpeDatSSMRunDocumet.index</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This function is used to send command to instance using boto3.client(&#39;ssm&#39;) and return job id and instance ids</span>

<span class="sd">Functions:</span>
<span class="sd">    - lambda_handler: The main function of the Lambda function. This function is triggered by an API Gateway endpoint. The function uses the AWS Systems Manager (SSM) API to query the status of the SSM Agent on the managed instances.</span>
<span class="sd">    - retry_with_backoff: Retries a function with exponential backoff.</span>
<span class="sd">    - get_instance_id: Gets the instance id of the managed instance.</span>
<span class="sd">    - get_connection_status: Gets the connection status of the theater box.</span>
<span class="sd">    - send_command : send command to instance using boto3.client(&#39;ssm&#39;) and return job id and instance ids</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="c1"># initialize tracer, metrics and logger</span>
<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">botocore</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Tracer</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Metrics</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.metrics</span> <span class="kn">import</span> <span class="n">MetricUnit</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Logger</span>
<span class="n">tracer</span> <span class="o">=</span> <span class="n">Tracer</span><span class="p">()</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="n">Metrics</span><span class="p">()</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">()</span>

<span class="c1"># initialize boto3 client and resource</span>
<span class="n">dynamodb</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s2">&quot;dynamodb&quot;</span><span class="p">)</span>
<span class="n">dynamodb_table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DYNAMODB_TABLE&#39;</span><span class="p">)</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">dynamodb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">dynamodb_table</span><span class="p">)</span>
<span class="n">ssm_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;ssm&quot;</span><span class="p">)</span>
<span class="n">s3</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span>

<span class="c1"># initialize environment variables</span>
<span class="n">sns_topic</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SNS_TOPIC&#39;</span><span class="p">)</span>
<span class="n">ssmServiceRoleArn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SSM_SERVICE_ROLE_ARN&#39;</span><span class="p">)</span>
<span class="n">documeName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SSM_DOCUMENT_NAME&#39;</span><span class="p">)</span>
<span class="n">hash_document</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HASH_DOCUMENT&#39;</span><span class="p">]</span>
<span class="n">default_destination_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DEFAULT_PATH&#39;</span><span class="p">)</span>
<span class="n">s3_bucket</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;S3_BUCKET&#39;</span><span class="p">)</span>
<span class="n">server_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SERVER_ID&#39;</span><span class="p">)</span>
<span class="n">api_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;API_GATEWAY_ENDPOINT&#39;</span><span class="p">)</span>
<span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># use hash.py and convert it into basq64 string</span>


<div class="viewcode-block" id="encode_file_to_base64"><a class="viewcode-back" href="../../ExpeDatSSMRunDocumet.html#ExpeDatSSMRunDocumet.index.encode_file_to_base64">[docs]</a><span class="k">def</span> <span class="nf">encode_file_to_base64</span><span class="p">(</span><span class="n">file_location</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_location</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">encoded_bytes</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">encoded_string</span> <span class="o">=</span> <span class="n">encoded_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">encoded_string</span></div>


<span class="c1"># hash_file = encode_file_to_base64(&#39;helpers/hash.py&#39;)</span>
<span class="c1"># logparser_file = encode_file_to_base64(&#39;helpers/logparser.py&#39;)</span>


<div class="viewcode-block" id="check_s3_file"><a class="viewcode-back" href="../../ExpeDatSSMRunDocumet.html#ExpeDatSSMRunDocumet.index.check_s3_file">[docs]</a><span class="k">def</span> <span class="nf">check_s3_file</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="c1"># check if file exists in s3</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">s3</span><span class="o">.</span><span class="n">head_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="retry_with_backoff"><a class="viewcode-back" href="../../ExpeDatSSMRunDocumet.html#ExpeDatSSMRunDocumet.index.retry_with_backoff">[docs]</a><span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_method</span><span class="p">(</span><span class="n">capture_response</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">retry_with_backoff</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retry the given function with exponential backoff and jitter.</span>

<span class="sd">    Args:</span>
<span class="sd">        function (callable): The function to retry.</span>
<span class="sd">        *args: Positional arguments to pass to the function.</span>
<span class="sd">        **kwargs: Keyword arguments to pass to the function.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The result of the function.</span>

<span class="sd">    Raises:</span>
<span class="sd">        botocore.exceptions.ClientError: If the maximum number of retries is exceeded.</span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; retry_with_backoff(ssm_client.send_command, InstanceIds=instance_ids, DocumentName=documeName, Parameters=parameters)</span>
<span class="sd">        {&#39;Command&#39;: {&#39;CommandId&#39;: &#39;command_id&#39;, &#39;DocumentName&#39;: &#39;AWS-RunShellScript&#39;, &#39;Comment&#39;: &#39;string&#39;, &#39;ExpiresAfter&#39;: datetime(2015, 1, 1), &#39;Parameters&#39;: {&#39;commands&#39;: [&#39;ls -l&#39;]}, &#39;InstanceIds&#39;: [&#39;m-1234567890abcdef0&#39;], &#39;Targets&#39;: [{&#39;Key&#39;: &#39;tag:Name&#39;, &#39;Values&#39;: [&#39;string&#39;]}], &#39;RequestedDateTime&#39;: datetime(2015, 1, 1), &#39;Status&#39;: &#39;Pending&#39;|&#39;InProgress&#39;|&#39;Success&#39;|&#39;Cancelled&#39;|&#39;Failed&#39;|&#39;TimedOut&#39;|&#39;Cancelling&#39;, &#39;StatusDetails&#39;: &#39;string&#39;, &#39;OutputS3Region&#39;: &#39;string&#39;, &#39;OutputS3BucketName&#39;: &#39;string&#39;, &#39;OutputS3KeyPrefix&#39;: &#39;string&#39;, &#39;MaxConcurrency&#39;: &#39;string&#39;, &#39;MaxErrors&#39;: &#39;string&#39;, &#39;TargetCount&#39;: 123, &#39;CompletedCount&#39;: 123, &#39;ErrorCount&#39;: 123, &#39;DeliveryTimedOutCount&#39;: 123, &#39;ServiceRole&#39;: &#39;string&#39;, &#39;NotificationConfig&#39;: {&#39;NotificationArn&#39;: &#39;string&#39;, &#39;NotificationEvents&#39;: [&#39;All&#39;|&#39;InProgress&#39;|&#39;Success&#39;|&#39;TimedOut&#39;|&#39;Cancelled&#39;|&#39;Failed&#39;], &#39;NotificationType&#39;: &#39;Command&#39;|&#39;Invocation&#39;}, &#39;CloudWatchOutputConfig&#39;: {&#39;CloudWatchLogGroupName&#39;: &#39;string&#39;, &#39;CloudWatchOutputEnabled&#39;: True|False}}, &#39;ResponseMetadata&#39;: {&#39;RequestId&#39;: &#39;request_id&#39;, &#39;HTTPStatusCode&#39;: 200, &#39;HTTPHeaders&#39;: {&#39;x-amzn-requestid&#39;: &#39;request_id&#39;, &#39;content-type&#39;: &#39;application/x-amz-json-1.1&#39;, &#39;content-length&#39;: &#39;1234&#39;, &#39;date&#39;: &#39;date&#39;}, &#39;RetryAttempts&#39;: 0}}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">max_retries</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">base_wait_time</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">retry_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_code</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;Error&quot;</span><span class="p">][</span><span class="s2">&quot;Code&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">error_code</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ThrottlingException&quot;</span><span class="p">,</span> <span class="s2">&quot;RequestLimitExceeded&quot;</span><span class="p">,</span> <span class="s2">&quot;InternalFailure&quot;</span><span class="p">]:</span>
                <span class="n">retry_count</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">retry_count</span> <span class="o">&gt;</span> <span class="n">max_retries</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>

                <span class="n">wait_time</span> <span class="o">=</span> <span class="n">base_wait_time</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">retry_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait_time</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span></div>


<div class="viewcode-block" id="get_last_two_folders"><a class="viewcode-back" href="../../ExpeDatSSMRunDocumet.html#ExpeDatSSMRunDocumet.index.get_last_two_folders">[docs]</a><span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_method</span><span class="p">(</span><span class="n">capture_response</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_last_two_folders</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the last two folders of the given path.</span>

<span class="sd">    Args:</span>
<span class="sd">        path (str): The path.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The last two folders of the path.</span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; get_last_two_folders(&quot;/a/b/c/d/e&quot;)</span>
<span class="sd">        &quot;/c/d/e&quot;</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path_components</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path_components</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># path has only two folders, so return the whole path</span>
        <span class="k">return</span> <span class="n">path</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># path has more than two folders, so return the last two</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">path_components</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
        <span class="k">return</span> <span class="n">folder</span></div>


<span class="c1"># function to get connection status of instance and return online or offline status</span>
<div class="viewcode-block" id="get_connection_status"><a class="viewcode-back" href="../../ExpeDatSSMRunDocumet.html#ExpeDatSSMRunDocumet.index.get_connection_status">[docs]</a><span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_method</span><span class="p">(</span><span class="n">capture_response</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_connection_status</span><span class="p">(</span><span class="n">instance_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the connection status of a managed instance.</span>

<span class="sd">    This function retrieves the connection status for a given instance by using the AWS Systems Manager API.</span>

<span class="sd">    Args:</span>
<span class="sd">        instance_id (str): The ID of the instance.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the connection status of the instance. The keys are the instance IDs, and the values</span>
<span class="sd">        are the connection status strings. If an error occurs, the dictionary will be empty.</span>

<span class="sd">        str: If an error occurs, a string containing the error message.</span>

<span class="sd">    Raises:</span>
<span class="sd">        None</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; get_connection_status(&quot;m-1234567890abcdef0&quot;)</span>
<span class="sd">        {&quot;m-1234567890abcdef0&quot;: &quot;connected&quot;}, None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># dictionary with instance_id as key and connection status as value</span>
    <span class="n">connection_status</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">instance_id</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">ssm_client</span><span class="o">.</span><span class="n">get_connection_status</span><span class="p">(</span><span class="n">Target</span><span class="o">=</span><span class="n">instance</span><span class="p">)</span>
            <span class="n">connection_status</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;Status&quot;</span><span class="p">]</span>
            <span class="n">tracer</span><span class="o">.</span><span class="n">put_annotation</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;connection_status&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;Status&quot;</span><span class="p">])</span>
            <span class="n">tracer</span><span class="o">.</span><span class="n">put_annotation</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;instance_id&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">instance</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">connection_status</span><span class="p">,</span> <span class="kc">None</span></div>


<span class="c1"># function to fetch instance id from dynamodb table using theater_id and return instance id for each theater</span>
<div class="viewcode-block" id="get_instance_id"><a class="viewcode-back" href="../../ExpeDatSSMRunDocumet.html#ExpeDatSSMRunDocumet.index.get_instance_id">[docs]</a><span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_method</span><span class="p">(</span><span class="n">capture_response</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_instance_id</span><span class="p">(</span><span class="n">client_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the instance ID for a given client.</span>

<span class="sd">    Args:</span>
<span class="sd">        client_id (str): The ID of the client.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict or None: A dictionary containing the instance ID for the given client ID, or None if an error occurred.</span>
<span class="sd">        str or None: An error message if applicable, or None if no errors occurred.</span>

<span class="sd">    Raises:</span>
<span class="sd">        botocore.exceptions.ClientError: If there was an issue with the client&#39;s request.</span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; get_instance_id(&quot;PVR-001&quot;, table)</span>
<span class="sd">        {&quot;1234567890&quot;: &quot;m-1234567890abcdef0&quot;}, None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">instance_id</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dictionary with client_id as key and instance_id as value</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span><span class="n">Key</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;TheaterId&quot;</span><span class="p">:</span> <span class="n">client_id</span><span class="p">})</span>
        <span class="k">if</span> <span class="s2">&quot;Item&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
            <span class="n">tracer</span><span class="o">.</span><span class="n">put_annotation</span><span class="p">(</span>
                <span class="n">key</span><span class="o">=</span><span class="s2">&quot;client_id&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;Item&quot;</span><span class="p">][</span><span class="s2">&quot;TheaterId&quot;</span><span class="p">])</span>
            <span class="n">tracer</span><span class="o">.</span><span class="n">put_annotation</span><span class="p">(</span>
                <span class="n">key</span><span class="o">=</span><span class="s2">&quot;instance_id&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;Item&quot;</span><span class="p">][</span><span class="s2">&quot;InstanceId&quot;</span><span class="p">])</span>

            <span class="n">instance_id</span><span class="p">[</span><span class="n">client_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;Item&quot;</span><span class="p">][</span><span class="s2">&quot;InstanceId&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Client ID </span><span class="si">{</span><span class="n">client_id</span><span class="si">}</span><span class="s2"> not found&quot;</span>
    <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">instance_id</span><span class="p">,</span> <span class="kc">None</span></div>

<span class="c1"># function to send command to instance using boto3.client(&#39;ssm&#39;) and return job id and instance ids</span>


<div class="viewcode-block" id="send_command"><a class="viewcode-back" href="../../ExpeDatSSMRunDocumet.html#ExpeDatSSMRunDocumet.index.send_command">[docs]</a><span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_method</span><span class="p">(</span><span class="n">capture_response</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">send_command</span><span class="p">(</span><span class="n">instance_id</span><span class="p">,</span> <span class="n">source_path</span><span class="p">,</span> <span class="n">sns_topic</span><span class="p">,</span> <span class="n">ssmServiceRoleArn</span><span class="p">,</span> <span class="n">documeName</span><span class="p">,</span> <span class="n">client_id</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sends a command to the specified instance, copying files from the source_path to the instance&#39;s default</span>
<span class="sd">    destination path. </span>

<span class="sd">    Args:</span>
<span class="sd">        instance_id (str): The ID of the instance to send the command to.</span>
<span class="sd">        source_path (str): The source path for the files to be copied.</span>
<span class="sd">        sns_topic (str): The SNS topic ARN.</span>
<span class="sd">        ssmServiceRoleArn (str): The ARN of the service role used to send the command.</span>
<span class="sd">        documeName (str): The name of the SSM document used to execute the command.</span>
<span class="sd">        client_id (str): The ID of the client.</span>
<span class="sd">        max_retries (int): The maximum number of times to retry sending the command if throttling errors occur.</span>
<span class="sd">        delay (int): The delay in seconds between retry attempts, which increases with each retry attempt.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the job ID of the command, the instance ID of the target instance,</span>
<span class="sd">        and the status of the command.</span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; send_command(&quot;i-1234567890abcdef0&quot;, &quot;/mnt/efs/1234567890&quot;, &quot;arn:aws:sns:us-east-1:1234567890:my-topic&quot;, &quot;arn:aws:iam::1234567890:role/SSMServiceRole&quot;, &quot;AWS-RunShellScript&quot;, &quot;1234567890&quot;)</span>
<span class="sd">        {&quot;job_id&quot;: &quot;1234567890&quot;, &quot;instance_id&quot;: &quot;m-1234567890abcdef0&quot;, &quot;status&quot;: &quot;InProgress&quot;}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># only include last 2 folder path from source path</span>
    <span class="n">source_folder</span> <span class="o">=</span> <span class="n">get_last_two_folders</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span>
    <span class="c1"># Split source_folder into individual folder names</span>
    <span class="n">folder_names</span> <span class="o">=</span> <span class="n">source_folder</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="c1"># add the end of the source folder to the destination path</span>
    <span class="n">dest_folder</span> <span class="o">=</span> <span class="n">default_destination_path</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_names</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">ssm_client</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span>
                <span class="n">InstanceIds</span><span class="o">=</span><span class="p">[</span><span class="n">instance_id</span><span class="p">],</span>
                <span class="n">DocumentName</span><span class="o">=</span><span class="n">documeName</span><span class="p">,</span>
                <span class="n">DocumentVersion</span><span class="o">=</span><span class="s2">&quot;$LATEST&quot;</span><span class="p">,</span>
                <span class="n">ServiceRoleArn</span><span class="o">=</span><span class="n">ssmServiceRoleArn</span><span class="p">,</span>
                <span class="n">NotificationConfig</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;NotificationArn&quot;</span><span class="p">:</span> <span class="n">sns_topic</span><span class="p">,</span>
                    <span class="s2">&quot;NotificationEvents&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;All&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="s2">&quot;NotificationType&quot;</span><span class="p">:</span> <span class="s2">&quot;Invocation&quot;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">TimeoutSeconds</span><span class="o">=</span><span class="mi">3600</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                <span class="n">Comment</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Copy from </span><span class="si">{</span><span class="n">source_folder</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">client_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">Parameters</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;SourcePath&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">source_path</span><span class="p">],</span>
                    <span class="s2">&quot;DestinationPath&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">dest_folder</span><span class="p">],</span>
                    <span class="s2">&quot;ClientId&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">client_id</span><span class="p">],</span>
                    <span class="s2">&quot;APIGatewayUrl&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">api_url</span><span class="p">],</span>
                    <span class="s2">&quot;GenerateHash&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">hash_file</span><span class="p">],</span>
                    <span class="s2">&quot;LogParser&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">logparser_file</span><span class="p">],</span>
                    <span class="s2">&quot;Date&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">date</span><span class="p">]</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Command sent to instance </span><span class="si">{</span><span class="n">instance_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">tracer</span><span class="o">.</span><span class="n">put_annotation</span><span class="p">(</span>
                <span class="n">key</span><span class="o">=</span><span class="s2">&quot;job_id&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;Command&quot;</span><span class="p">][</span><span class="s2">&quot;CommandId&quot;</span><span class="p">])</span>
            <span class="n">tracer</span><span class="o">.</span><span class="n">put_annotation</span><span class="p">(</span>
                <span class="n">key</span><span class="o">=</span><span class="s2">&quot;instance_id&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;Command&quot;</span><span class="p">][</span><span class="s2">&quot;InstanceIds&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">tracer</span><span class="o">.</span><span class="n">put_metadata</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;JobId&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;Command&quot;</span><span class="p">][</span><span class="s2">&quot;CommandId&quot;</span><span class="p">],</span>
                <span class="s2">&quot;InstanceId&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;Command&quot;</span><span class="p">][</span><span class="s2">&quot;InstanceIds&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;Status&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;Command&quot;</span><span class="p">][</span><span class="s2">&quot;Status&quot;</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_code</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;Error&#39;</span><span class="p">][</span><span class="s1">&#39;Code&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">error_code</span> <span class="o">==</span> <span class="s1">&#39;ThrottlingException&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Request throttled, retrying in </span><span class="si">{</span><span class="n">delay</span><span class="si">}</span><span class="s2"> seconds...&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                <span class="n">delay</span> <span class="o">*=</span> <span class="mi">2</span>  <span class="c1"># exponential backoff</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error sending command: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">)}</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Max retries exceeded, unable to send command to instance </span><span class="si">{</span><span class="n">instance_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="s2">&quot;Max retries exceeded&quot;</span><span class="p">)}</span></div>


<div class="viewcode-block" id="generate_hash_server"><a class="viewcode-back" href="../../ExpeDatSSMRunDocumet.html#ExpeDatSSMRunDocumet.index.generate_hash_server">[docs]</a><span class="k">def</span> <span class="nf">generate_hash_server</span><span class="p">(</span><span class="n">server_id</span><span class="p">,</span> <span class="n">source_path</span><span class="p">,</span> <span class="n">ssmServiceRoleArn</span><span class="p">,</span> <span class="n">hash_document</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a hash for the server using SSM run command.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: A hash for the server.</span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; generate_hash_server()</span>
<span class="sd">        &quot;1234567890abcdef0&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">folder_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">source_path</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">ssm_client</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span>
            <span class="n">InstanceIds</span><span class="o">=</span><span class="p">[</span><span class="n">server_id</span><span class="p">],</span>
            <span class="n">DocumentName</span><span class="o">=</span><span class="n">hash_document</span><span class="p">,</span>
            <span class="n">DocumentVersion</span><span class="o">=</span><span class="s2">&quot;$LATEST&quot;</span><span class="p">,</span>
            <span class="n">ServiceRoleArn</span><span class="o">=</span><span class="n">ssmServiceRoleArn</span><span class="p">,</span>

            <span class="n">TimeoutSeconds</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span>
            <span class="n">Comment</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Generate hash file for </span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s2"> on server&quot;</span><span class="p">,</span>
            <span class="n">Parameters</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;SourcePath&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">source_path</span><span class="p">],</span>
                <span class="s2">&quot;APIURL&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">api_url</span><span class="p">],</span>
                <span class="s2">&quot;GenerateHash&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">hash_file</span><span class="p">],</span>
                <span class="s2">&quot;Date&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">date</span><span class="p">]</span>
            <span class="p">},</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_code</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;Error&#39;</span><span class="p">][</span><span class="s1">&#39;Code&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">error_code</span> <span class="o">==</span> <span class="s1">&#39;ThrottlingException&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Request throttled, retrying in </span><span class="si">{</span><span class="n">delay</span><span class="si">}</span><span class="s2"> seconds...&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
            <span class="n">delay</span> <span class="o">*=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error sending command: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">)}</span></div>


<span class="c1"># main lambda handler function</span>
<div class="viewcode-block" id="lambda_handler"><a class="viewcode-back" href="../../ExpeDatSSMRunDocumet.html#ExpeDatSSMRunDocumet.index.lambda_handler">[docs]</a><span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_lambda_handler</span><span class="p">(</span><span class="n">capture_response</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nd">@logger</span><span class="o">.</span><span class="n">inject_lambda_context</span>
<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Lambda handler function acts as the entry point.</span>

<span class="sd">    Args:</span>
<span class="sd">        event (dict): The event data passed to the function.</span>
<span class="sd">        context (LambdaContext): The context object passed to the function.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the response status code and body.</span>

<span class="sd">    Raises:</span>
<span class="sd">        Exception: If an unexpected error occurs.</span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; lambda_handler({&quot;body&quot;: {&quot;ClientId&quot;: &quot;1234567890&quot;, &quot;SourcePath&quot;: &quot;/mnt/efs/1234567890/2020&quot;, &quot;DestinationPath&quot;: &quot;/mnt/efs/1234567890/2020&quot;}}, {})</span>
<span class="sd">        {&quot;statusCode&quot;: 200, &quot;body&quot;: {&quot;JobId&quot;: &quot;1234567890&quot;, &quot;InstanceId&quot;: &quot;m-1234567890abcdef0&quot;, &quot;Status&quot;: &quot;Pending&quot;}}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">])</span>
    <span class="n">client_id</span> <span class="o">=</span> <span class="n">body</span><span class="p">[</span><span class="s2">&quot;ClientId&quot;</span><span class="p">]</span>
    <span class="n">source_path</span> <span class="o">=</span> <span class="n">body</span><span class="p">[</span><span class="s2">&quot;SourcePath&quot;</span><span class="p">]</span>
    <span class="n">folder_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">source_path</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">))</span>
    <span class="n">server_hash_key</span> <span class="o">=</span> <span class="s1">&#39;FolderIntegrity/Server/</span><span class="si">{date}</span><span class="s1">/</span><span class="si">{folder_name}</span><span class="s1">/source.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">,</span>
        <span class="n">folder_name</span><span class="o">=</span><span class="n">folder_name</span>
    <span class="p">)</span>
    <span class="c1"># destination_path = body[&quot;DestinationPath&quot;]</span>
    <span class="c1"># get instance_id from dynamodb table</span>
    <span class="n">instance_id</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">get_instance_id</span><span class="p">(</span><span class="n">client_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting instance ID: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">error</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">client_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">instance_id</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Client ID </span><span class="si">{</span><span class="n">client_id</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;InstanceId&quot;</span><span class="p">:</span> <span class="n">client_id</span><span class="p">,</span> <span class="s2">&quot;ClientStatus&quot;</span><span class="p">:</span> <span class="s2">&quot;unidentified&quot;</span><span class="p">}}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># get online and offline instance</span>
    <span class="n">connection_status</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">get_connection_status</span><span class="p">(</span><span class="n">instance_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting connection status: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">error</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">send_command_with_retry</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">source_path</span><span class="p">,</span> <span class="n">sns_topic</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">documeName</span><span class="p">,</span> <span class="n">client_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">retry_with_backoff</span><span class="p">(</span><span class="n">send_command</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">source_path</span><span class="p">,</span> <span class="n">sns_topic</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">documeName</span><span class="p">,</span> <span class="n">client_id</span><span class="p">)</span>
    <span class="c1"># check in s3 if the hash file exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_s3_file</span><span class="p">(</span><span class="n">s3_bucket</span><span class="p">,</span> <span class="n">server_hash_key</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hash file for </span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s2"> does not exist on server&quot;</span><span class="p">)</span>
        <span class="c1"># generate hash file on server</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">generate_hash_server</span><span class="p">(</span>
            <span class="n">server_id</span><span class="p">,</span> <span class="n">source_path</span><span class="p">,</span> <span class="n">ssmServiceRoleArn</span><span class="p">,</span> <span class="n">hash_document</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hash file for </span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s2"> generated on server&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">connection_status</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">connection_status</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;connected&quot;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">send_command_with_retry</span><span class="p">(</span>
                    <span class="n">instance</span><span class="p">,</span> <span class="n">source_path</span><span class="p">,</span> <span class="n">sns_topic</span><span class="p">,</span> <span class="n">ssmServiceRoleArn</span><span class="p">,</span> <span class="n">documeName</span><span class="p">,</span> <span class="n">client_id</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">append_keys</span><span class="p">(</span><span class="n">client_id</span><span class="o">=</span><span class="n">client_id</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Command sent to instance </span><span class="si">{</span><span class="n">instance</span><span class="si">}</span><span class="s2"> successfully&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Instance </span><span class="si">{</span><span class="n">instance</span><span class="si">}</span><span class="s2"> is offline&quot;</span><span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;InstanceId&quot;</span><span class="p">:</span> <span class="n">instance</span><span class="p">,</span>
                    <span class="s2">&quot;ClientStatus&quot;</span><span class="p">:</span> <span class="s2">&quot;Offline&quot;</span><span class="p">,</span>
                <span class="p">}</span>
    <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error sending command: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">)}</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">)}</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Prime Focus.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>