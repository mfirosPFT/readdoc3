<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SSMAgentActivation.index &mdash; DCinema Distribution AWS Resources 1.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            DCinema Distribution AWS Resources
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../template.html">Cloudformation Template</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Lambda Function</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">DCinema Distribution AWS Resources</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">SSMAgentActivation.index</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for SSMAgentActivation.index</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This function creates activation code and id for SSM agent and stores it in SSM parameter store. It also updates the activation code and id in SSM parameter store if the activation code is not expired and the registration limit is not reached. It also adds theater id as tags to the instance.</span>

<span class="sd">Functions:</span>
<span class="sd">    - create_activation: This function creates activation code and id for SSM agent and stores it in SSM parameter store.</span>
<span class="sd">    - update_ssm: This function updates the activation code and id in SSM parameter store if the activation code is not expired and the registration limit is not reached.</span>
<span class="sd">    - add_tags: This function adds theater id as tags to the instance.</span>
<span class="sd">    - update_table: This function updates the instance information in dynamodb table.</span>
<span class="sd">    - get_activation_code_id: This function gets the activation code and id from SSM parameter store.</span>
<span class="sd">    - lambda_handler: This function is the entry point for the lambda function.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Tracer</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Metrics</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.metrics</span> <span class="kn">import</span> <span class="n">MetricUnit</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Logger</span>

<span class="c1"># initialize powertools</span>
<span class="n">tracer</span> <span class="o">=</span> <span class="n">Tracer</span><span class="p">()</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="n">Metrics</span><span class="p">()</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">()</span>

<span class="c1"># initialize boto3 client and resource</span>
<span class="n">ssm_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;ssm&quot;</span><span class="p">)</span>
<span class="n">dynamodb</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s2">&quot;dynamodb&quot;</span><span class="p">)</span>

<span class="c1"># initialize environment variables</span>
<span class="n">region</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;AWS_REGION&#39;</span><span class="p">)</span>
<span class="n">role</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SSM_ROLE&#39;</span><span class="p">)</span>
<span class="n">dynamodb_table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DYNAMODB_TABLE_ACTIVATIONS&#39;</span><span class="p">)</span>
<span class="n">project</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PROJECT_NAME&#39;</span><span class="p">)</span>
<span class="n">parameter</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SSM_PARAMETER&#39;</span><span class="p">)</span>
<span class="n">install_dependencies</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;INSTALL_DEPENDENCIES&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="install_deps"><a class="viewcode-back" href="../../SSMAgentActivation.html#SSMAgentActivation.index.install_deps">[docs]</a><span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_method</span><span class="p">(</span><span class="n">capture_response</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">install_deps</span><span class="p">(</span><span class="n">instance_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function installs dependencies on the instance.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        instance_id (str): Instance id of the instance</span>

<span class="sd">    Returns:</span>
<span class="sd">        response (dict): Response from SSM command</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; response = install_deps(instance_id)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">ssm_client</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span>
            <span class="n">InstanceIds</span><span class="o">=</span><span class="p">[</span><span class="n">instance_id</span><span class="p">],</span>
            <span class="n">DocumentName</span><span class="o">=</span><span class="n">install_dependencies</span><span class="p">,</span>
            <span class="n">DocumentVersion</span><span class="o">=</span><span class="s2">&quot;$LATEST&quot;</span><span class="p">,</span>
            <span class="n">TimeoutSeconds</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>
            <span class="n">Comment</span><span class="o">=</span><span class="s2">&quot;Installing dependencies&quot;</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">e</span></div>


<div class="viewcode-block" id="create_activation"><a class="viewcode-back" href="../../SSMAgentActivation.html#SSMAgentActivation.index.create_activation">[docs]</a><span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_method</span><span class="p">(</span><span class="n">capture_response</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create_activation</span><span class="p">(</span><span class="n">registration_limit</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function creates activation code and id for SSM agent and stores it in SSM parameter store.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        registration_limit (int): Registration limit for the activation code</span>

<span class="sd">    Returns:</span>
<span class="sd">        activation_code (str): Activation code for SSM agent</span>
<span class="sd">        activation_id (str): Activation id for SSM agent</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; activation_code, activation_id = create_activation(10)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">ssm_client</span><span class="o">.</span><span class="n">create_activation</span><span class="p">(</span>
            <span class="n">Description</span><span class="o">=</span><span class="s2">&quot;ExpeDat SSM Agent Activation&quot;</span><span class="p">,</span>
            <span class="n">DefaultInstanceName</span><span class="o">=</span><span class="s2">&quot;TheaterBoxDCinema&quot;</span><span class="p">,</span>
            <span class="n">IamRole</span><span class="o">=</span><span class="n">role</span><span class="p">,</span>
            <span class="n">RegistrationLimit</span><span class="o">=</span><span class="n">registration_limit</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">e</span>

    <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;ActivationCode&quot;</span><span class="p">],</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;ActivationId&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="update_ssm"><a class="viewcode-back" href="../../SSMAgentActivation.html#SSMAgentActivation.index.update_ssm">[docs]</a><span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_method</span><span class="p">(</span><span class="n">capture_response</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">update_ssm</span><span class="p">(</span><span class="n">activation_code</span><span class="p">,</span> <span class="n">activation_id</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">registration_limit</span><span class="p">,</span> <span class="n">expiration</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function updates the activation code and id in SSM parameter store if the activation code is not expired and the registration limit is not reached.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        activation_code (str): Activation code for SSM agent</span>
<span class="sd">        activation_id (str): Activation id for SSM agent</span>
<span class="sd">        count (int): Active count for the activation code</span>
<span class="sd">        registration_limit (int): Registration limit for the activation code</span>
<span class="sd">        expiration (str): Expiration date for the activation code</span>

<span class="sd">    Returns:</span>
<span class="sd">        response (dict): Response from SSM parameter store</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; response = update_ssm(activation_code, activation_id, count, registration_limit, expiration)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">ssm_client</span><span class="o">.</span><span class="n">put_parameter</span><span class="p">(</span>
            <span class="n">Name</span><span class="o">=</span><span class="n">parameter</span><span class="p">,</span>
            <span class="n">Value</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
                <span class="s2">&quot;ActivationId&quot;</span><span class="p">:</span> <span class="n">activation_id</span><span class="p">,</span>
                <span class="s2">&quot;ActivationCode&quot;</span><span class="p">:</span> <span class="n">activation_code</span><span class="p">,</span>
                <span class="s2">&quot;Expiration&quot;</span><span class="p">:</span> <span class="n">expiration</span><span class="p">,</span>
                <span class="s2">&quot;ActiveCount&quot;</span><span class="p">:</span> <span class="n">count</span><span class="p">,</span>
                <span class="s2">&quot;RegistrationLimit&quot;</span><span class="p">:</span> <span class="n">registration_limit</span>
            <span class="p">}),</span>
            <span class="n">Type</span><span class="o">=</span><span class="s2">&quot;String&quot;</span><span class="p">,</span>
            <span class="n">Overwrite</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">return</span> <span class="n">response</span></div>


<div class="viewcode-block" id="add_tags"><a class="viewcode-back" href="../../SSMAgentActivation.html#SSMAgentActivation.index.add_tags">[docs]</a><span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_method</span><span class="p">(</span><span class="n">capture_response</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_tags</span><span class="p">(</span><span class="n">instance_id</span><span class="p">,</span> <span class="n">theater_id</span><span class="p">,</span> <span class="n">theater_name</span><span class="p">,</span> <span class="n">theater_email</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function adds theater id as tags to the instance.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        instance_id (str): Instance id of the instance</span>
<span class="sd">        theater_id (str): Theater id of the instance</span>

<span class="sd">    Returns:</span>
<span class="sd">        response (dict): Response from SSM parameter store</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; response = add_tags(instance_id, theater_id)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">ssm_client</span><span class="o">.</span><span class="n">add_tags_to_resource</span><span class="p">(</span>
            <span class="n">ResourceType</span><span class="o">=</span><span class="s2">&quot;ManagedInstance&quot;</span><span class="p">,</span>
            <span class="n">ResourceId</span><span class="o">=</span><span class="n">instance_id</span><span class="p">,</span>
            <span class="n">Tags</span><span class="o">=</span><span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;Key&quot;</span><span class="p">:</span> <span class="s2">&quot;TheaterId&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Value&quot;</span><span class="p">:</span> <span class="n">theater_id</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;Key&quot;</span><span class="p">:</span> <span class="s2">&quot;TheaterName&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Value&quot;</span><span class="p">:</span> <span class="n">theater_name</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;Key&quot;</span><span class="p">:</span> <span class="s2">&quot;UpdatedOn&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Value&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>

                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;Key&quot;</span><span class="p">:</span> <span class="s2">&quot;TheaterEmail&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Value&quot;</span><span class="p">:</span> <span class="n">theater_email</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;Key&quot;</span><span class="p">:</span> <span class="s2">&quot;Project&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Value&quot;</span><span class="p">:</span> <span class="n">project</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">return</span> <span class="n">response</span></div>


<div class="viewcode-block" id="update_table"><a class="viewcode-back" href="../../SSMAgentActivation.html#SSMAgentActivation.index.update_table">[docs]</a><span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_method</span><span class="p">(</span><span class="n">capture_response</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">update_table</span><span class="p">(</span><span class="n">theater_id</span><span class="p">,</span> <span class="n">theater_name</span><span class="p">,</span> <span class="n">theater_email</span><span class="p">,</span> <span class="n">instance_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function adds theater id&#39;s tags to the theater table.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        instance_id (str): Instance id of the instance</span>
<span class="sd">        theater_id (str): Theater id of the instance</span>

<span class="sd">    Returns:</span>
<span class="sd">        response (dict): Response from SSM parameter store</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; response = add_tags(instance_id, theater_id, theater_name, theater_email)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">dynamodb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DYNAMODB_TABLE_THEATER&#39;</span><span class="p">))</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;TheaterId&#39;</span><span class="p">:</span> <span class="n">theater_id</span><span class="p">,</span>
                <span class="s1">&#39;TheaterName&#39;</span><span class="p">:</span> <span class="n">theater_name</span><span class="p">,</span>
                <span class="s1">&#39;TheaterEmail&#39;</span><span class="p">:</span> <span class="n">theater_email</span><span class="p">,</span>
                <span class="s1">&#39;InstanceId&#39;</span><span class="p">:</span> <span class="n">instance_id</span><span class="p">,</span>
                <span class="s1">&#39;UpdatedOn&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>

            <span class="p">}</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">return</span> <span class="n">response</span></div>


<div class="viewcode-block" id="get_activation_code_id"><a class="viewcode-back" href="../../SSMAgentActivation.html#SSMAgentActivation.index.get_activation_code_id">[docs]</a><span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_method</span><span class="p">(</span><span class="n">capture_response</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_activation_code_id</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function gets activation code and id from SSM parameter store if the activation code is not expired and the registration limit is not reached. If the activation code is expired or the registration limit is reached, it creates a new activation code and id and stores it in SSM parameter store.</span>

<span class="sd">    Returns:</span>
<span class="sd">        activation_code (str): Activation code for SSM agent</span>
<span class="sd">        activation_id (str): Activation id for SSM agent</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; activation_code, activation_id = get_activation_code_id()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">ssm_client</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span>
            <span class="n">Name</span><span class="o">=</span><span class="n">parameter</span><span class="p">,</span>
            <span class="n">WithDecryption</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;Parameter&quot;</span><span class="p">][</span><span class="s2">&quot;Value&quot;</span><span class="p">])</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ActiveCount&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">registration_limit</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;RegistrationLimit&quot;</span><span class="p">]</span>
        <span class="n">expiration_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
            <span class="n">item</span><span class="p">[</span><span class="s2">&quot;Expiration&quot;</span><span class="p">],</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">expiration_date</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">registration_limit</span><span class="p">:</span>
                <span class="n">ssm_client</span><span class="o">.</span><span class="n">put_parameter</span><span class="p">(</span>
                    <span class="n">Name</span><span class="o">=</span><span class="n">parameter</span><span class="p">,</span>
                    <span class="n">Value</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
                        <span class="s2">&quot;ActivationId&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;ActivationId&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;ActivationCode&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;ActivationCode&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;Expiration&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;Expiration&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;ActiveCount&quot;</span><span class="p">:</span> <span class="n">count</span><span class="p">,</span>
                        <span class="s2">&quot;RegistrationLimit&quot;</span><span class="p">:</span> <span class="n">registration_limit</span>
                    <span class="p">}),</span>
                    <span class="n">Type</span><span class="o">=</span><span class="s2">&quot;String&quot;</span><span class="p">,</span>
                    <span class="n">Overwrite</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updated ActiveCount in ssm parameter&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;ActivationCode&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;ActivationId&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">activation_code</span><span class="p">,</span> <span class="n">activation_id</span> <span class="o">=</span> <span class="n">create_activation</span><span class="p">(</span>
                    <span class="n">registration_limit</span><span class="p">)</span>
                <span class="n">expiration</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span>
                              <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">28</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">update_ssm</span><span class="p">(</span><span class="n">activation_code</span><span class="p">,</span> <span class="n">activation_id</span><span class="p">,</span>
                           <span class="mi">0</span><span class="p">,</span> <span class="n">registration_limit</span><span class="p">,</span> <span class="n">expiration</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created new activation code and id&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">activation_code</span><span class="p">,</span> <span class="n">activation_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">activation_code</span><span class="p">,</span> <span class="n">activation_id</span> <span class="o">=</span> <span class="n">create_activation</span><span class="p">(</span>
                <span class="n">registration_limit</span><span class="p">)</span>
            <span class="n">expiration</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">28</span><span class="p">)</span>
                          <span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">update_ssm</span><span class="p">(</span><span class="n">activation_code</span><span class="p">,</span> <span class="n">activation_id</span><span class="p">,</span>
                       <span class="mi">0</span><span class="p">,</span> <span class="n">registration_limit</span><span class="p">,</span> <span class="n">expiration</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created new activation code and id&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">activation_code</span><span class="p">,</span> <span class="n">activation_id</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">e</span></div>


<div class="viewcode-block" id="lambda_handler"><a class="viewcode-back" href="../../SSMAgentActivation.html#SSMAgentActivation.index.lambda_handler">[docs]</a><span class="nd">@logger</span><span class="o">.</span><span class="n">inject_lambda_context</span><span class="p">(</span><span class="n">log_event</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_lambda_handler</span>
<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is the entry point for the lambda function. It checks the api path and calls the respective function.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        event (dict): Event data passed to the lambda function</span>
<span class="sd">        context (LambdaContext): Lambda context object</span>

<span class="sd">    Returns:</span>
<span class="sd">        response (dict): Response from the function</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check api path to see if the request is for activation code and id or to add theater id as tags to the instance</span>
    <span class="n">event_path</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">event_path</span> <span class="o">==</span> <span class="s2">&quot;/addtags&quot;</span><span class="p">:</span>
        <span class="c1"># add theater id as tags to the instance</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">])</span>
        <span class="n">instance_id</span> <span class="o">=</span> <span class="n">body</span><span class="p">[</span><span class="s2">&quot;machine_id&quot;</span><span class="p">]</span>
        <span class="n">theater_id</span> <span class="o">=</span> <span class="n">body</span><span class="p">[</span><span class="s2">&quot;theater_id&quot;</span><span class="p">]</span>
        <span class="n">theater_name</span> <span class="o">=</span> <span class="n">body</span><span class="p">[</span><span class="s2">&quot;theater_name&quot;</span><span class="p">]</span>
        <span class="n">theater_email</span> <span class="o">=</span> <span class="n">body</span><span class="p">[</span><span class="s2">&quot;theater_email&quot;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tag_response</span> <span class="o">=</span> <span class="n">add_tags</span><span class="p">(</span><span class="n">instance_id</span><span class="p">,</span> <span class="n">theater_id</span><span class="p">,</span>
                                    <span class="n">theater_name</span><span class="p">,</span> <span class="n">theater_email</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Added tags to the instance&quot;</span><span class="p">)</span>

            <span class="c1"># add theater id, name and instance id to dynamodb table</span>
            <span class="n">table_response</span> <span class="o">=</span> <span class="n">update_table</span><span class="p">(</span>
                <span class="n">theater_id</span><span class="p">,</span> <span class="n">theater_name</span><span class="p">,</span> <span class="n">theater_email</span><span class="p">,</span> <span class="n">instance_id</span><span class="p">)</span>

            <span class="c1"># run install dependencies ssm run document on the instance</span>
            <span class="n">ssm_response</span> <span class="o">=</span> <span class="n">install_deps</span><span class="p">(</span><span class="n">instance_id</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Ran install dependencies ssm run document&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;Message&quot;</span><span class="p">:</span> <span class="s2">&quot;TheaterId tag added successfully to the instance&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;TheaterId&quot;</span><span class="p">:</span> <span class="n">theater_id</span><span class="p">,</span>
                        <span class="s2">&quot;InstanceId&quot;</span><span class="p">:</span> <span class="n">instance_id</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">),</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
                <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;Message&quot;</span><span class="p">:</span> <span class="s2">&quot;Error adding tags to the instance&quot;</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="p">}</span>

    <span class="c1"># get activation code and id</span>
    <span class="k">elif</span> <span class="n">event_path</span> <span class="o">==</span> <span class="s2">&quot;/ssmactivation&quot;</span><span class="p">:</span>
        <span class="n">activation_code</span><span class="p">,</span> <span class="n">activation_id</span> <span class="o">=</span> <span class="n">get_activation_code_id</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
            <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;ActivationId&quot;</span><span class="p">:</span> <span class="n">activation_id</span><span class="p">,</span>
                    <span class="s2">&quot;ActivationCode&quot;</span><span class="p">:</span> <span class="n">activation_code</span><span class="p">,</span>
                    <span class="s2">&quot;Region&quot;</span><span class="p">:</span> <span class="n">region</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">404</span><span class="p">,</span>
            <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;Message&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid path&quot;</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="p">}</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Prime Focus.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>