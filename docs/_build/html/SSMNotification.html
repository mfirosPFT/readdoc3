<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SSMNotification Documentation &mdash; DCinema Distribution AWS Resources 1.0.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="DashboardFunction Documentation" href="DashboardFunction.html" />
    <link rel="prev" title="ExpeDatSSMInvocationQuery Documentation" href="ExpeDatSSMInvocationQuery.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            DCinema Distribution AWS Resources
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="template.html">Cloudformation Template</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="modules.html">Lambda Function</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="ExpeDatSSMRunDocumet.html">ExpeDatSSMRunDocumet Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="ExpeDatSSMInvocationQuery.html">ExpeDatSSMInvocationQuery Documentation</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">SSMNotification Documentation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#code">Code</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="DashboardFunction.html">DashboardFunction Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="CustomAuthorizer.html">CustomAuthorizer Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="SSMAgentActivation.html">SSMAgentActivation Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="SSMInstallScriptGenerator.html">SSMInstallScriptGenerator Documentation</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">DCinema Distribution AWS Resources</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="modules.html">Lambda Function</a></li>
      <li class="breadcrumb-item active">SSMNotification Documentation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/SSMNotification.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="module-SSMNotification.index">
<span id="ssmnotification-documentation"></span><h1>SSMNotification Documentation<a class="headerlink" href="#module-SSMNotification.index" title="Permalink to this headline"></a></h1>
<p>This function is triggered by SNS topic when SSM document execution is completed, failed or timed out.
This function will fetch the instance id from the SNS message and fetch the theater details from dynamodb table using instance id.
This function will fetch the SSM document execution details from SSM using command id.
This function will send an email to the theater email id with the SSM document execution details.
This function will store the SSM document execution details in dynamodb table.</p>
<dl class="simple">
<dt>Functions:</dt><dd><ul class="simple">
<li><p>lambda_handler: The main function of the Lambda function. This function is triggered by an SNS topic. The function uses the AWS Systems Manager (SSM) API to query the status of the SSM Agent on the EC2 instances.</p></li>
<li><p>verify_email_identity: Verifies the email identity.</p></li>
<li><p>get_instance_details: Gets the theater details from dynamodb table using instance id.</p></li>
<li><p>get_command_details: Gets the SSM document execution details from SSM using command id.</p></li>
<li><p>send_notification: Sends an email to the theater email id with the SSM document execution details.</p></li>
<li><p>store_status_in_dynamodb: Stores the SSM document execution details in dynamodb table.</p></li>
<li><p>clean_data: Cleans the SSM document execution details.</p></li>
</ul>
</dd>
</dl>
<dl class="py function">
<dt class="sig sig-object py" id="SSMNotification.index.clean_data">
<span class="sig-prename descclassname"><span class="pre">SSMNotification.index.</span></span><span class="sig-name descname"><span class="pre">clean_data</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">command_details</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">message</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/SSMNotification/index.html#clean_data"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#SSMNotification.index.clean_data" title="Permalink to this definition"></a></dt>
<dd><p>Clean the SSM document execution details.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>command_details</strong> (<em>dict</em>) – SSM document execution details.</p></li>
<li><p><strong>message</strong> (<em>dict</em>) – SNS message.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><ul class="simple">
<li><p><em>str</em> – Folder name.</p></li>
<li><p><em>str</em> – Info.</p></li>
<li><p><em>str</em> – Start time.</p></li>
<li><p><em>str</em> – End time.</p></li>
<li><p><em>str</em> – Current time.</p></li>
<li><p><em>str</em> – Status.</p></li>
<li><p><em>str</em> – Command id.</p></li>
<li><p><em>str</em> – Output.</p></li>
<li><p><em>str</em> – Error.</p></li>
</ul>
</p>
</dd>
</dl>
<p class="rubric">Examples</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">clean_data</span><span class="p">(</span><span class="n">command_details</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
<span class="go">(&#39;folder_name&#39;, &#39;info&#39;, &#39;start_time&#39;, &#39;end_time&#39;, &#39;current_time&#39;, &#39;status&#39;, &#39;command_id&#39;, &#39;output&#39;, &#39;error&#39;)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="SSMNotification.index.download_csv">
<span class="sig-prename descclassname"><span class="pre">SSMNotification.index.</span></span><span class="sig-name descname"><span class="pre">download_csv</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">bucket</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">key</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/SSMNotification/index.html#download_csv"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#SSMNotification.index.download_csv" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="SSMNotification.index.extract_info">
<span class="sig-prename descclassname"><span class="pre">SSMNotification.index.</span></span><span class="sig-name descname"><span class="pre">extract_info</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">log</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/SSMNotification/index.html#extract_info"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#SSMNotification.index.extract_info" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="SSMNotification.index.format_time">
<span class="sig-prename descclassname"><span class="pre">SSMNotification.index.</span></span><span class="sig-name descname"><span class="pre">format_time</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">time_sec</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/SSMNotification/index.html#format_time"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#SSMNotification.index.format_time" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="SSMNotification.index.get_command_details">
<span class="sig-prename descclassname"><span class="pre">SSMNotification.index.</span></span><span class="sig-name descname"><span class="pre">get_command_details</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">command_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">instance_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ssm_client</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/SSMNotification/index.html#get_command_details"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#SSMNotification.index.get_command_details" title="Permalink to this definition"></a></dt>
<dd><p>Fetch command details from SSM run command history using command id.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>command_id</strong> (<em>str</em>) – Command id.</p></li>
<li><p><strong>instance_id</strong> (<em>str</em>) – Instance id.</p></li>
<li><p><strong>ssm_client</strong> (<em>boto3.client</em>) – SSM client.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><ul class="simple">
<li><p><em>dict</em> – SSM command details.</p></li>
<li><p><em>str</em> – Error message if command details are not fetched from SSM run command history.</p></li>
</ul>
</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="SSMNotification.index.get_instance_details">
<span class="sig-prename descclassname"><span class="pre">SSMNotification.index.</span></span><span class="sig-name descname"><span class="pre">get_instance_details</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">instance_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">table</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/SSMNotification/index.html#get_instance_details"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#SSMNotification.index.get_instance_details" title="Permalink to this definition"></a></dt>
<dd><p>Fetch instance id from dynamodb table using theater_id and return instance id for each theater.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>instance_id</strong> (<em>str</em>) – Instance id.</p></li>
<li><p><strong>table</strong> (<em>str</em>) – DynamoDB table name.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><ul class="simple">
<li><p><em>list</em> – List of instance ids.</p></li>
<li><p><em>str</em> – Error message if instance id is not fetched from dynamodb table.</p></li>
</ul>
</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="SSMNotification.index.lambda_handler">
<span class="sig-prename descclassname"><span class="pre">SSMNotification.index.</span></span><span class="sig-name descname"><span class="pre">lambda_handler</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">event</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">context</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/SSMNotification/index.html#lambda_handler"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#SSMNotification.index.lambda_handler" title="Permalink to this definition"></a></dt>
<dd><p>Lambda handler function.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>event</strong> (<em>dict</em>) – Event data.</p></li>
<li><p><strong>context</strong> (<em>object</em>) – Lambda Context runtime methods and attributes.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><ul class="simple">
<li><p><em>dict</em> – Response.</p></li>
<li><p><em>str</em> – Error message if any.</p></li>
</ul>
</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="SSMNotification.index.send_notification">
<span class="sig-prename descclassname"><span class="pre">SSMNotification.index.</span></span><span class="sig-name descname"><span class="pre">send_notification</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">email</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">theaterName</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">command_details</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">message</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">theater_id</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/SSMNotification/index.html#send_notification"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#SSMNotification.index.send_notification" title="Permalink to this definition"></a></dt>
<dd><p>Send notification to the user using SES.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>email</strong> (<em>str</em>) – Email address.</p></li>
<li><p><strong>theaterName</strong> (<em>str</em>) – Theater name.</p></li>
<li><p><strong>command_details</strong> (<em>dict</em>) – SSM command details.</p></li>
<li><p><strong>message</strong> (<em>dict</em>) – SSM command message.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><ul class="simple">
<li><p><em>dict</em> – SNS response.</p></li>
<li><p><em>str</em> – Error message if notification is not sent.</p></li>
</ul>
</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="SSMNotification.index.store_status_in_dynamodb">
<span class="sig-prename descclassname"><span class="pre">SSMNotification.index.</span></span><span class="sig-name descname"><span class="pre">store_status_in_dynamodb</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">command_details</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">theater_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">message</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/SSMNotification/index.html#store_status_in_dynamodb"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#SSMNotification.index.store_status_in_dynamodb" title="Permalink to this definition"></a></dt>
<dd><p>Store the status of the SSM document execution in dynamodb table.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>command_details</strong> (<em>dict</em>) – SSM document execution details.</p></li>
<li><p><strong>theater_id</strong> (<em>str</em>) – Theater id.</p></li>
<li><p><strong>message</strong> (<em>dict</em>) – SNS message.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><ul class="simple">
<li><p><em>bool</em> – True if status is stored in dynamodb table else False.</p></li>
<li><p><em>str</em> – Error message if status is not stored in dynamodb table.</p></li>
</ul>
</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="SSMNotification.index.verify_email_identity">
<span class="sig-prename descclassname"><span class="pre">SSMNotification.index.</span></span><span class="sig-name descname"><span class="pre">verify_email_identity</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">email_from</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ses_client</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/SSMNotification/index.html#verify_email_identity"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#SSMNotification.index.verify_email_identity" title="Permalink to this definition"></a></dt>
<dd><p>SES , create new using the environment variable EMAIL_FROM if not present. Else, use the existing one.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>email_from</strong> (<em>str</em>) – Email address.</p></li>
<li><p><strong>ses_client</strong> (<em>boto3.client</em>) – SES client.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><ul class="simple">
<li><p><em>str</em> – Email address.</p></li>
<li><p><em>str</em> – Error message if email address is not verified.</p></li>
</ul>
</p>
</dd>
</dl>
</dd></dl>

<section id="code">
<h2>Code<a class="headerlink" href="#code" title="Permalink to this headline"></a></h2>
<p>This section defines the code that is used.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  2</span><span class="sd">This function is triggered by SNS topic when SSM document execution is completed, failed or timed out.</span>
<span class="linenos">  3</span><span class="sd">This function will fetch the instance id from the SNS message and fetch the theater details from dynamodb table using instance id.</span>
<span class="linenos">  4</span><span class="sd">This function will fetch the SSM document execution details from SSM using command id.</span>
<span class="linenos">  5</span><span class="sd">This function will send an email to the theater email id with the SSM document execution details.</span>
<span class="linenos">  6</span><span class="sd">This function will store the SSM document execution details in dynamodb table.</span>
<span class="linenos">  7</span>
<span class="linenos">  8</span><span class="sd">Functions:</span>
<span class="linenos">  9</span><span class="sd">    - lambda_handler: The main function of the Lambda function. This function is triggered by an SNS topic. The function uses the AWS Systems Manager (SSM) API to query the status of the SSM Agent on the EC2 instances.</span>
<span class="linenos"> 10</span><span class="sd">    - verify_email_identity: Verifies the email identity.</span>
<span class="linenos"> 11</span><span class="sd">    - get_instance_details: Gets the theater details from dynamodb table using instance id.</span>
<span class="linenos"> 12</span><span class="sd">    - get_command_details: Gets the SSM document execution details from SSM using command id.</span>
<span class="linenos"> 13</span><span class="sd">    - send_notification: Sends an email to the theater email id with the SSM document execution details.</span>
<span class="linenos"> 14</span><span class="sd">    - store_status_in_dynamodb: Stores the SSM document execution details in dynamodb table.</span>
<span class="linenos"> 15</span><span class="sd">    - clean_data: Cleans the SSM document execution details.</span>
<span class="linenos"> 16</span>
<span class="linenos"> 17</span>
<span class="linenos"> 18</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 19</span><span class="kn">import</span> <span class="nn">json</span>
<span class="linenos"> 20</span><span class="kn">import</span> <span class="nn">os</span>
<span class="linenos"> 21</span><span class="kn">import</span> <span class="nn">re</span>
<span class="linenos"> 22</span><span class="kn">import</span> <span class="nn">csv</span>
<span class="linenos"> 23</span><span class="kn">import</span> <span class="nn">io</span>
<span class="linenos"> 24</span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="linenos"> 25</span><span class="kn">import</span> <span class="nn">botocore</span>
<span class="linenos"> 26</span><span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Logger</span>
<span class="linenos"> 27</span><span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Tracer</span>
<span class="linenos"> 28</span><span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Metrics</span>
<span class="linenos"> 29</span><span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">Environment</span><span class="p">,</span> <span class="n">FileSystemLoader</span>
<span class="linenos"> 30</span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="linenos"> 31</span><span class="kn">import</span> <span class="nn">time</span>
<span class="linenos"> 32</span><span class="kn">import</span> <span class="nn">pytz</span>
<span class="linenos"> 33</span><span class="c1"># from exit_codes import get_error_message</span>
<span class="linenos"> 34</span><span class="kn">import</span> <span class="nn">base64</span>
<span class="linenos"> 35</span><span class="kn">from</span> <span class="nn">email.mime.multipart</span> <span class="kn">import</span> <span class="n">MIMEMultipart</span>
<span class="linenos"> 36</span><span class="kn">from</span> <span class="nn">email.mime.text</span> <span class="kn">import</span> <span class="n">MIMEText</span>
<span class="linenos"> 37</span><span class="kn">from</span> <span class="nn">email.mime.image</span> <span class="kn">import</span> <span class="n">MIMEImage</span>
<span class="linenos"> 38</span>
<span class="linenos"> 39</span><span class="c1"># initialize tracer, metrics and loggers</span>
<span class="linenos"> 40</span><span class="n">tracer</span> <span class="o">=</span> <span class="n">Tracer</span><span class="p">()</span>
<span class="linenos"> 41</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">Metrics</span><span class="p">()</span>
<span class="linenos"> 42</span><span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">()</span>
<span class="linenos"> 43</span>
<span class="linenos"> 44</span><span class="c1"># initialize boto3 client and resource</span>
<span class="linenos"> 45</span><span class="n">dynamodb</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s2">&quot;dynamodb&quot;</span><span class="p">)</span>
<span class="linenos"> 46</span><span class="n">dynamodb_table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DYNAMODB_TABLE&#39;</span><span class="p">)</span>
<span class="linenos"> 47</span><span class="c1"># dynamodb_table_index = os.environ.get(&#39;DYNAMODB_TABLE_INDEX&#39;)</span>
<span class="linenos"> 48</span><span class="n">dynamodb_table_index</span> <span class="o">=</span> <span class="s2">&quot;InstanceIdIndex&quot;</span>
<span class="linenos"> 49</span><span class="n">emailfrom</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;EMAIL_FROM&#39;</span><span class="p">)</span>
<span class="linenos"> 50</span><span class="n">table</span> <span class="o">=</span> <span class="n">dynamodb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">dynamodb_table</span><span class="p">)</span>
<span class="linenos"> 51</span><span class="n">ssm_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;ssm&quot;</span><span class="p">)</span>
<span class="linenos"> 52</span><span class="n">ses_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;ses&quot;</span><span class="p">)</span>
<span class="linenos"> 53</span><span class="n">status_table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;STATUS_TABLE&#39;</span><span class="p">)</span>
<span class="linenos"> 54</span><span class="n">s3_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;s3&quot;</span><span class="p">)</span>
<span class="linenos"> 55</span><span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos"> 56</span><span class="n">s3_bucket</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;S3_BUCKET&#39;</span><span class="p">)</span>
<span class="linenos"> 57</span><span class="c1"># Read the first image file</span>
<span class="linenos"> 58</span><span class="c1"># with open(&#39;template/images/logo.png&#39;, &#39;rb&#39;) as f1:</span>
<span class="linenos"> 59</span><span class="c1">#     img_data1 = f1.read()</span>
<span class="linenos"> 60</span>
<span class="linenos"> 61</span><span class="c1"># # Read the second image file</span>
<span class="linenos"> 62</span><span class="c1"># with open(&#39;template/images/header.png&#39;, &#39;rb&#39;) as f2:</span>
<span class="linenos"> 63</span><span class="c1">#     img_data2 = f2.read()</span>
<span class="linenos"> 64</span>
<span class="linenos"> 65</span><span class="c1"># initialize environment variables</span>
<span class="linenos"> 66</span><span class="n">role</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Role&#39;</span><span class="p">)</span>
<span class="linenos"> 67</span><span class="n">documeName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SSM_DOCUMENT_NAME&#39;</span><span class="p">)</span>
<span class="linenos"> 68</span>
<span class="linenos"> 69</span><span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span><span class="n">loader</span><span class="o">=</span><span class="n">FileSystemLoader</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span>
<span class="linenos"> 70</span><span class="n">ist_tz</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="s1">&#39;Asia/Kolkata&#39;</span><span class="p">)</span>
<span class="linenos"> 71</span>
<span class="linenos"> 72</span><span class="c1"># function to store status of the SSM document execution in dynamodb table</span>
<span class="linenos"> 73</span>
<span class="linenos"> 74</span>
<span class="linenos"> 75</span><span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_method</span><span class="p">(</span><span class="n">capture_response</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos"> 76</span><span class="k">def</span> <span class="nf">store_status_in_dynamodb</span><span class="p">(</span><span class="n">command_details</span><span class="p">,</span> <span class="n">theater_id</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<span class="linenos"> 77</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 78</span><span class="sd">    Store the status of the SSM document execution in dynamodb table.</span>
<span class="linenos"> 79</span>
<span class="linenos"> 80</span><span class="sd">    Parameters</span>
<span class="linenos"> 81</span><span class="sd">    ----------</span>
<span class="linenos"> 82</span><span class="sd">    command_details : dict</span>
<span class="linenos"> 83</span><span class="sd">        SSM document execution details.</span>
<span class="linenos"> 84</span><span class="sd">    theater_id : str</span>
<span class="linenos"> 85</span><span class="sd">        Theater id.</span>
<span class="linenos"> 86</span><span class="sd">    message : dict</span>
<span class="linenos"> 87</span><span class="sd">        SNS message.</span>
<span class="linenos"> 88</span>
<span class="linenos"> 89</span><span class="sd">    Returns</span>
<span class="linenos"> 90</span><span class="sd">    -------</span>
<span class="linenos"> 91</span><span class="sd">    bool</span>
<span class="linenos"> 92</span><span class="sd">        True if status is stored in dynamodb table else False.</span>
<span class="linenos"> 93</span><span class="sd">    str</span>
<span class="linenos"> 94</span><span class="sd">        Error message if status is not stored in dynamodb table.</span>
<span class="linenos"> 95</span>
<span class="linenos"> 96</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 97</span>
<span class="linenos"> 98</span>    <span class="n">dtable</span> <span class="o">=</span> <span class="n">dynamodb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">status_table</span><span class="p">)</span>
<span class="linenos"> 99</span>    <span class="n">folder_name</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">current_time</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">command_id</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">source_path</span><span class="p">,</span> <span class="n">dest_path</span><span class="p">,</span> <span class="n">source_hash</span><span class="p">,</span> <span class="n">dest_hash</span> <span class="o">=</span> <span class="n">clean_data</span><span class="p">(</span>
<span class="linenos">100</span>        <span class="n">command_details</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
<span class="linenos">101</span>    <span class="n">created_on</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
<span class="linenos">102</span>    <span class="n">item</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">103</span>        <span class="s2">&quot;TheaterId&quot;</span><span class="p">:</span> <span class="n">theater_id</span><span class="p">,</span>
<span class="linenos">104</span>        <span class="s2">&quot;JobId&quot;</span><span class="p">:</span> <span class="n">command_id</span><span class="p">,</span>
<span class="linenos">105</span>        <span class="s2">&quot;Status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
<span class="linenos">106</span>        <span class="s2">&quot;StartTime&quot;</span><span class="p">:</span> <span class="n">start_time</span><span class="p">,</span>
<span class="linenos">107</span>        <span class="s2">&quot;CreatedOn&quot;</span><span class="p">:</span> <span class="n">created_on</span><span class="p">,</span>
<span class="linenos">108</span>        <span class="s2">&quot;FolderName&quot;</span><span class="p">:</span> <span class="n">folder_name</span><span class="p">,</span>
<span class="linenos">109</span>        <span class="s2">&quot;SourcePath&quot;</span><span class="p">:</span> <span class="n">source_path</span><span class="p">,</span>
<span class="linenos">110</span>        <span class="s2">&quot;DestinationPath&quot;</span><span class="p">:</span> <span class="n">dest_path</span><span class="p">,</span>
<span class="linenos">111</span>    <span class="p">}</span>
<span class="linenos">112</span>
<span class="linenos">113</span>    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;Success&quot;</span><span class="p">:</span>
<span class="linenos">114</span>        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;EndTime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">end_time</span>
<span class="linenos">115</span>        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;Info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>
<span class="linenos">116</span>        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;Output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span>
<span class="linenos">117</span>        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;SourceHash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_hash</span>
<span class="linenos">118</span>        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;DestinationHash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dest_hash</span>
<span class="linenos">119</span>    <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;Failed&quot;</span><span class="p">:</span>
<span class="linenos">120</span>        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;EndTime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">end_time</span>
<span class="linenos">121</span>        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;Error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error</span>
<span class="linenos">122</span>    <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;TimedOut&quot;</span><span class="p">:</span>
<span class="linenos">123</span>        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;EndTime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_time</span>
<span class="linenos">124</span>        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;Error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error</span>
<span class="linenos">125</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">126</span>        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;TTL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">created_on</span> <span class="o">+</span> <span class="mi">86400</span>
<span class="linenos">127</span>
<span class="linenos">128</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">129</span>        <span class="n">dtable</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span><span class="n">Item</span><span class="o">=</span><span class="n">item</span><span class="p">)</span>
<span class="linenos">130</span>    <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">131</span>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
<span class="linenos">132</span>        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
<span class="linenos">133</span>    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">None</span>
<span class="linenos">134</span>
<span class="linenos">135</span>
<span class="linenos">136</span><span class="c1"># def extract_info(text):</span>
<span class="linenos">137</span><span class="c1">#     last_line = text.strip().split(&#39;\n&#39;)[-1]</span>
<span class="linenos">138</span><span class="c1">#     if last_line[0] == &#39;F&#39;:</span>
<span class="linenos">139</span><span class="c1">#         info = last_line.split(&#39;\t&#39;)[-2]</span>
<span class="linenos">140</span><span class="c1">#         return info</span>
<span class="linenos">141</span><span class="c1">#     return None</span>
<span class="linenos">142</span><span class="k">def</span> <span class="nf">format_time</span><span class="p">(</span><span class="n">time_sec</span><span class="p">):</span>
<span class="linenos">143</span>    <span class="k">if</span> <span class="n">time_sec</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">:</span>
<span class="linenos">144</span>        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{:.1f}</span><span class="s1"> seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_sec</span><span class="p">)</span>
<span class="linenos">145</span>    <span class="k">elif</span> <span class="n">time_sec</span> <span class="o">&lt;</span> <span class="mi">3600</span><span class="p">:</span>
<span class="linenos">146</span>        <span class="nb">min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time_sec</span> <span class="o">//</span> <span class="mi">60</span><span class="p">)</span>
<span class="linenos">147</span>        <span class="n">sec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time_sec</span> <span class="o">%</span> <span class="mi">60</span><span class="p">)</span>
<span class="linenos">148</span>        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> minutes </span><span class="si">{}</span><span class="s1"> seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span> <span class="n">sec</span><span class="p">)</span>
<span class="linenos">149</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">150</span>        <span class="n">hour</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time_sec</span> <span class="o">//</span> <span class="mi">3600</span><span class="p">)</span>
<span class="linenos">151</span>        <span class="nb">min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">time_sec</span> <span class="o">%</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">//</span> <span class="mi">60</span><span class="p">)</span>
<span class="linenos">152</span>        <span class="n">sec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">time_sec</span> <span class="o">%</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">%</span> <span class="mi">60</span><span class="p">)</span>
<span class="linenos">153</span>        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> hours </span><span class="si">{}</span><span class="s1"> minutes </span><span class="si">{}</span><span class="s1"> seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="nb">min</span><span class="p">,</span> <span class="n">sec</span><span class="p">)</span>
<span class="linenos">154</span>
<span class="linenos">155</span>
<span class="linenos">156</span><span class="k">def</span> <span class="nf">extract_info</span><span class="p">(</span><span class="n">log</span><span class="p">):</span>
<span class="linenos">157</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">158</span>        <span class="c1"># Total number of files: 40</span>
<span class="linenos">159</span>        <span class="c1"># Total size of files (in GB): 40.80000000000002</span>
<span class="linenos">160</span>        <span class="c1"># Total time taken (in seconds): 20568.0</span>
<span class="linenos">161</span>        <span class="c1"># Best speed (in Mbps): 46.1</span>
<span class="linenos">162</span>        <span class="c1"># Average speed (in Mbps): 23.575249999999997</span>
<span class="linenos">163</span>        <span class="c1"># Destination Path: /tmp/DCinema/downloads/TestPackaged40GB</span>
<span class="linenos">164</span>        <span class="c1"># Source Path: /ldc1/dc-storage/DCinemaTest/TestPackage40GB</span>
<span class="linenos">165</span>
<span class="linenos">166</span>        <span class="n">pattern_size</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;Total size of files \(in ([A-Za-z]+)\): ([0-9.]+)&#39;</span>
<span class="linenos">167</span>        <span class="n">pattern_num_files</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;Total number of files: (.+)&#39;</span>
<span class="linenos">168</span>        <span class="n">pattern_time_taken</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;Total time taken \(in seconds\): (.+)&#39;</span>
<span class="linenos">169</span>        <span class="n">pattern_speed</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;Best speed \(in Mbps\): (.+)&#39;</span>
<span class="linenos">170</span>        <span class="n">pattern_avg_speed</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;Average speed \(in Mbps\): (.+)&#39;</span>
<span class="linenos">171</span>        <span class="n">pattern_dest_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;Destination Path: (.+)&#39;</span>
<span class="linenos">172</span>        <span class="n">pattern_source_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;Source Path: (.+)&#39;</span>
<span class="linenos">173</span>        <span class="n">pattern_source_hash</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;Server Key: (.+)&#39;</span>
<span class="linenos">174</span>        <span class="n">pattern_dest_hash</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;Client Key: (.+)&#39;</span>
<span class="linenos">175</span>
<span class="linenos">176</span>        <span class="n">size_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern_size</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
<span class="linenos">177</span>        <span class="k">if</span> <span class="n">size_match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">178</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid log format: cannot extract file size&#39;</span><span class="p">)</span>
<span class="linenos">179</span>        <span class="n">num_files_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern_num_files</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
<span class="linenos">180</span>        <span class="k">if</span> <span class="n">num_files_match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">181</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos">182</span>                <span class="s1">&#39;Invalid log format: cannot extract number of files&#39;</span><span class="p">)</span>
<span class="linenos">183</span>
<span class="linenos">184</span>        <span class="n">time_taken_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern_time_taken</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
<span class="linenos">185</span>        <span class="k">if</span> <span class="n">time_taken_match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">186</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid log format: cannot extract time taken&#39;</span><span class="p">)</span>
<span class="linenos">187</span>        <span class="n">speed_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern_speed</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
<span class="linenos">188</span>        <span class="k">if</span> <span class="n">speed_match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">189</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid log format: cannot extract best speed&#39;</span><span class="p">)</span>
<span class="linenos">190</span>        <span class="n">avg_speed_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern_avg_speed</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
<span class="linenos">191</span>        <span class="k">if</span> <span class="n">avg_speed_match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">192</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos">193</span>                <span class="s1">&#39;Invalid log format: cannot extract average speed&#39;</span><span class="p">)</span>
<span class="linenos">194</span>        <span class="n">source_path_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern_source_path</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
<span class="linenos">195</span>        <span class="k">if</span> <span class="n">source_path_match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">196</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos">197</span>                <span class="s1">&#39;Invalid log format: cannot extract source path&#39;</span><span class="p">)</span>
<span class="linenos">198</span>        <span class="n">dest_path_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern_dest_path</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
<span class="linenos">199</span>        <span class="k">if</span> <span class="n">dest_path_match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">200</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos">201</span>                <span class="s1">&#39;Invalid log format: cannot extract destination path&#39;</span><span class="p">)</span>
<span class="linenos">202</span>        <span class="n">source_hash_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern_source_hash</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
<span class="linenos">203</span>        <span class="k">if</span> <span class="n">source_hash_match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">204</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos">205</span>                <span class="s1">&#39;Invalid log format: cannot extract source hash&#39;</span><span class="p">)</span>
<span class="linenos">206</span>        <span class="n">dest_hash_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern_dest_hash</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
<span class="linenos">207</span>        <span class="k">if</span> <span class="n">dest_hash_match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">208</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos">209</span>                <span class="s1">&#39;Invalid log format: cannot extract destination hash&#39;</span><span class="p">)</span>
<span class="linenos">210</span>
<span class="linenos">211</span>        <span class="n">size_unit</span> <span class="o">=</span> <span class="n">size_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">212</span>        <span class="n">size_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">size_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="linenos">213</span>        <span class="k">if</span> <span class="n">size_unit</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;kb&#39;</span><span class="p">:</span>
<span class="linenos">214</span>            <span class="n">size_val</span> <span class="o">/=</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">2</span>
<span class="linenos">215</span>        <span class="k">elif</span> <span class="n">size_unit</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;mb&#39;</span><span class="p">:</span>
<span class="linenos">216</span>            <span class="n">size_val</span> <span class="o">/=</span> <span class="mi">1024</span>
<span class="linenos">217</span>        <span class="k">elif</span> <span class="n">size_unit</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;gb&#39;</span><span class="p">:</span>
<span class="linenos">218</span>            <span class="k">pass</span>
<span class="linenos">219</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">220</span>            <span class="k">return</span> <span class="kc">None</span>
<span class="linenos">221</span>
<span class="linenos">222</span>        <span class="n">num_files</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_files_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="linenos">223</span>        <span class="n">time_taken</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">time_taken_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="linenos">224</span>        <span class="n">speed</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">speed_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="linenos">225</span>        <span class="n">avg_speed</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">avg_speed_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="linenos">226</span>        <span class="n">source_path</span> <span class="o">=</span> <span class="n">source_path_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">227</span>        <span class="n">dest_path</span> <span class="o">=</span> <span class="n">dest_path_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">228</span>        <span class="n">source_hash</span> <span class="o">=</span> <span class="n">source_hash_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">229</span>        <span class="n">dest_hash</span> <span class="o">=</span> <span class="n">dest_hash_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">230</span>
<span class="linenos">231</span>        <span class="k">return</span> <span class="n">size_val</span><span class="p">,</span> <span class="n">num_files</span><span class="p">,</span> <span class="n">time_taken</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">avg_speed</span><span class="p">,</span> <span class="n">source_path</span><span class="p">,</span> <span class="n">dest_path</span><span class="p">,</span> <span class="n">source_hash</span><span class="p">,</span> <span class="n">dest_hash</span>
<span class="linenos">232</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">233</span>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="linenos">234</span>        <span class="k">return</span> <span class="kc">None</span>
<span class="linenos">235</span>
<span class="linenos">236</span>
<span class="linenos">237</span><span class="k">def</span> <span class="nf">clean_data</span><span class="p">(</span><span class="n">command_details</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<span class="linenos">238</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">239</span><span class="sd">    Clean the SSM document execution details.</span>
<span class="linenos">240</span>
<span class="linenos">241</span><span class="sd">    Parameters</span>
<span class="linenos">242</span><span class="sd">    ----------</span>
<span class="linenos">243</span><span class="sd">    command_details : dict</span>
<span class="linenos">244</span><span class="sd">        SSM document execution details.</span>
<span class="linenos">245</span><span class="sd">    message : dict</span>
<span class="linenos">246</span><span class="sd">        SNS message.</span>
<span class="linenos">247</span>
<span class="linenos">248</span><span class="sd">    Returns</span>
<span class="linenos">249</span><span class="sd">    -------</span>
<span class="linenos">250</span><span class="sd">    str</span>
<span class="linenos">251</span><span class="sd">        Folder name.</span>
<span class="linenos">252</span><span class="sd">    str</span>
<span class="linenos">253</span><span class="sd">        Info.</span>
<span class="linenos">254</span><span class="sd">    str</span>
<span class="linenos">255</span><span class="sd">        Start time.</span>
<span class="linenos">256</span><span class="sd">    str</span>
<span class="linenos">257</span><span class="sd">        End time.</span>
<span class="linenos">258</span><span class="sd">    str</span>
<span class="linenos">259</span><span class="sd">        Current time.</span>
<span class="linenos">260</span><span class="sd">    str</span>
<span class="linenos">261</span><span class="sd">        Status.</span>
<span class="linenos">262</span><span class="sd">    str</span>
<span class="linenos">263</span><span class="sd">        Command id.</span>
<span class="linenos">264</span><span class="sd">    str</span>
<span class="linenos">265</span><span class="sd">        Output.</span>
<span class="linenos">266</span><span class="sd">    str</span>
<span class="linenos">267</span><span class="sd">        Error.</span>
<span class="linenos">268</span>
<span class="linenos">269</span><span class="sd">    Examples</span>
<span class="linenos">270</span><span class="sd">    --------</span>
<span class="linenos">271</span><span class="sd">    &gt;&gt;&gt; clean_data(command_details, message)</span>
<span class="linenos">272</span><span class="sd">    (&#39;folder_name&#39;, &#39;info&#39;, &#39;start_time&#39;, &#39;end_time&#39;, &#39;current_time&#39;, &#39;status&#39;, &#39;command_id&#39;, &#39;output&#39;, &#39;error&#39;)</span>
<span class="linenos">273</span>
<span class="linenos">274</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">275</span>    <span class="n">folder_name</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">276</span>    <span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">277</span>    <span class="n">end_time</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">278</span>    <span class="n">source_path</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">279</span>    <span class="n">dest_path</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">280</span>    <span class="n">source_hash</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">281</span>    <span class="n">dest_hash</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">282</span>    <span class="n">output</span> <span class="o">=</span> <span class="n">command_details</span><span class="p">[</span><span class="s2">&quot;StandardOutputContent&quot;</span><span class="p">]</span>
<span class="linenos">283</span>    <span class="n">comments</span> <span class="o">=</span> <span class="n">command_details</span><span class="p">[</span><span class="s2">&quot;Comment&quot;</span><span class="p">]</span>
<span class="linenos">284</span>    <span class="n">error</span> <span class="o">=</span> <span class="n">command_details</span><span class="p">[</span><span class="s2">&quot;StandardErrorContent&quot;</span><span class="p">]</span>
<span class="linenos">285</span>
<span class="linenos">286</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span>
<span class="linenos">287</span>    <span class="n">command_id</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="s2">&quot;commandId&quot;</span><span class="p">]</span>
<span class="linenos">288</span>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="s2">&quot;requestedDateTime&quot;</span><span class="p">]</span>
<span class="linenos">289</span>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
<span class="linenos">290</span>        <span class="n">start_time</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">Z&quot;</span><span class="p">)</span>
<span class="linenos">291</span>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">start_time</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">pytz</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span>
<span class="linenos">292</span>        <span class="n">ist_tz</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %I:%M:%S %p %Z&quot;</span><span class="p">)</span>
<span class="linenos">293</span>    <span class="c1"># Get the current UTC time</span>
<span class="linenos">294</span>    <span class="n">now_utc</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<span class="linenos">295</span>
<span class="linenos">296</span>    <span class="c1"># Convert UTC time to Indian Standard Time</span>
<span class="linenos">297</span>
<span class="linenos">298</span>    <span class="n">now_ist</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">utc</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">now_utc</span><span class="p">)</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">ist_tz</span><span class="p">)</span>
<span class="linenos">299</span>    <span class="n">current_time</span> <span class="o">=</span> <span class="n">now_ist</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %I:%M:%S %p %Z&quot;</span><span class="p">)</span>
<span class="linenos">300</span>
<span class="linenos">301</span>    <span class="k">if</span> <span class="n">command_details</span><span class="p">[</span><span class="s2">&quot;ExecutionEndDateTime&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">command_details</span><span class="p">[</span><span class="s2">&quot;ExecutionEndDateTime&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
<span class="linenos">302</span>        <span class="n">end_time</span> <span class="o">=</span> <span class="n">command_details</span><span class="p">[</span><span class="s2">&quot;ExecutionEndDateTime&quot;</span><span class="p">]</span>
<span class="linenos">303</span>        <span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
<span class="linenos">304</span>            <span class="n">end_time</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">Z&quot;</span><span class="p">)</span>
<span class="linenos">305</span>        <span class="n">end_time</span> <span class="o">=</span> <span class="n">end_time</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">pytz</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span>
<span class="linenos">306</span>            <span class="n">ist_tz</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %I:%M:%S %p %Z&quot;</span><span class="p">)</span>
<span class="linenos">307</span>
<span class="linenos">308</span>    <span class="k">if</span> <span class="n">output</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">output</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span><span class="p">:</span>
<span class="linenos">309</span>        <span class="c1"># print(output)</span>
<span class="linenos">310</span>        <span class="n">data</span> <span class="o">=</span> <span class="n">extract_info</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<span class="linenos">311</span>        <span class="n">source_path</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
<span class="linenos">312</span>        <span class="n">dest_path</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
<span class="linenos">313</span>        <span class="n">source_hash</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
<span class="linenos">314</span>        <span class="n">dest_hash</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
<span class="linenos">315</span>        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
<span class="linenos">316</span>            <span class="n">info</span> <span class="o">=</span> <span class="s2">&quot;Total size of files: </span><span class="si">{:.2f}</span><span class="s2"> GB, Total number of files: </span><span class="si">{}</span><span class="s2">, Total time taken: </span><span class="si">{}</span><span class="s2">, Best speed: </span><span class="si">{:.2f}</span><span class="s2"> Mbps, Average speed: </span><span class="si">{:.2f}</span><span class="s2"> Mbps&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<span class="linenos">317</span>                <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">format_time</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
<span class="linenos">318</span>
<span class="linenos">319</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">320</span>            <span class="n">info</span> <span class="o">=</span> <span class="s2">&quot;No information available&quot;</span>
<span class="linenos">321</span>
<span class="linenos">322</span>    <span class="k">if</span> <span class="n">comments</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">comments</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span><span class="p">:</span>
<span class="linenos">323</span>        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Copy from (\S+) to&#39;</span><span class="p">,</span> <span class="n">comments</span><span class="p">)</span>
<span class="linenos">324</span>        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
<span class="linenos">325</span>            <span class="n">folder_name</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">326</span>
<span class="linenos">327</span>    <span class="k">return</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">current_time</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">command_id</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">source_path</span><span class="p">,</span> <span class="n">dest_path</span><span class="p">,</span> <span class="n">source_hash</span><span class="p">,</span> <span class="n">dest_hash</span>
<span class="linenos">328</span>
<span class="linenos">329</span>
<span class="linenos">330</span><span class="c1"># function to fetch instance id from dynamodb table using theater_id and return instance id for each theater</span>
<span class="linenos">331</span>
<span class="linenos">332</span>
<span class="linenos">333</span><span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_method</span><span class="p">(</span><span class="n">capture_response</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos">334</span><span class="k">def</span> <span class="nf">get_instance_details</span><span class="p">(</span><span class="n">instance_id</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
<span class="linenos">335</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">336</span><span class="sd">    Fetch instance id from dynamodb table using theater_id and return instance id for each theater.</span>
<span class="linenos">337</span>
<span class="linenos">338</span><span class="sd">    Parameters</span>
<span class="linenos">339</span><span class="sd">    ----------</span>
<span class="linenos">340</span><span class="sd">    instance_id : str</span>
<span class="linenos">341</span><span class="sd">        Instance id.</span>
<span class="linenos">342</span><span class="sd">    table : str</span>
<span class="linenos">343</span><span class="sd">        DynamoDB table name.</span>
<span class="linenos">344</span>
<span class="linenos">345</span><span class="sd">    Returns</span>
<span class="linenos">346</span><span class="sd">    -------</span>
<span class="linenos">347</span><span class="sd">    list</span>
<span class="linenos">348</span><span class="sd">        List of instance ids.</span>
<span class="linenos">349</span><span class="sd">    str</span>
<span class="linenos">350</span><span class="sd">        Error message if instance id is not fetched from dynamodb table.</span>
<span class="linenos">351</span>
<span class="linenos">352</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">353</span>
<span class="linenos">354</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">355</span>        <span class="n">response</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
<span class="linenos">356</span>            <span class="n">TableName</span><span class="o">=</span><span class="n">dynamodb_table</span><span class="p">,</span>
<span class="linenos">357</span>            <span class="n">IndexName</span><span class="o">=</span><span class="n">dynamodb_table_index</span><span class="p">,</span>
<span class="linenos">358</span>            <span class="n">KeyConditionExpression</span><span class="o">=</span><span class="s2">&quot;InstanceId  = :instance_id&quot;</span><span class="p">,</span>
<span class="linenos">359</span>            <span class="n">ExpressionAttributeValues</span><span class="o">=</span><span class="p">{</span>
<span class="linenos">360</span>                <span class="s2">&quot;:instance_id&quot;</span><span class="p">:</span> <span class="n">instance_id</span>
<span class="linenos">361</span>            <span class="p">}</span>
<span class="linenos">362</span>        <span class="p">)</span>
<span class="linenos">363</span>        <span class="n">tracer</span><span class="o">.</span><span class="n">put_annotation</span><span class="p">(</span>
<span class="linenos">364</span>            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;theater_id&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;Items&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;TheaterId&quot;</span><span class="p">])</span>
<span class="linenos">365</span>        <span class="n">tracer</span><span class="o">.</span><span class="n">put_annotation</span><span class="p">(</span>
<span class="linenos">366</span>            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;theater_name&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;Items&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;TheaterName&quot;</span><span class="p">])</span>
<span class="linenos">367</span>        <span class="n">tracer</span><span class="o">.</span><span class="n">put_annotation</span><span class="p">(</span>
<span class="linenos">368</span>            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;theater_email&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;Items&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;TheaterEmail&quot;</span><span class="p">])</span>
<span class="linenos">369</span>    <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">370</span>        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
<span class="linenos">371</span>    <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;Items&quot;</span><span class="p">],</span> <span class="kc">None</span>
<span class="linenos">372</span>
<span class="linenos">373</span>
<span class="linenos">374</span><span class="c1"># function to fetch command details from SSM run command history using command id</span>
<span class="linenos">375</span><span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_method</span><span class="p">(</span><span class="n">capture_response</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos">376</span><span class="k">def</span> <span class="nf">get_command_details</span><span class="p">(</span><span class="n">command_id</span><span class="p">,</span> <span class="n">instance_id</span><span class="p">,</span> <span class="n">ssm_client</span><span class="p">):</span>
<span class="linenos">377</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">378</span><span class="sd">    Fetch command details from SSM run command history using command id.</span>
<span class="linenos">379</span>
<span class="linenos">380</span><span class="sd">    Parameters</span>
<span class="linenos">381</span><span class="sd">    ----------</span>
<span class="linenos">382</span><span class="sd">    command_id : str</span>
<span class="linenos">383</span><span class="sd">        Command id.</span>
<span class="linenos">384</span><span class="sd">    instance_id : str</span>
<span class="linenos">385</span><span class="sd">        Instance id.</span>
<span class="linenos">386</span><span class="sd">    ssm_client : boto3.client</span>
<span class="linenos">387</span><span class="sd">        SSM client.</span>
<span class="linenos">388</span>
<span class="linenos">389</span><span class="sd">    Returns</span>
<span class="linenos">390</span><span class="sd">    -------</span>
<span class="linenos">391</span><span class="sd">    dict</span>
<span class="linenos">392</span><span class="sd">        SSM command details.</span>
<span class="linenos">393</span><span class="sd">    str</span>
<span class="linenos">394</span><span class="sd">        Error message if command details are not fetched from SSM run command history.</span>
<span class="linenos">395</span>
<span class="linenos">396</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">397</span>
<span class="linenos">398</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">399</span>        <span class="n">response</span> <span class="o">=</span> <span class="n">ssm_client</span><span class="o">.</span><span class="n">get_command_invocation</span><span class="p">(</span>
<span class="linenos">400</span>            <span class="n">CommandId</span><span class="o">=</span><span class="n">command_id</span><span class="p">,</span>
<span class="linenos">401</span>            <span class="n">InstanceId</span><span class="o">=</span><span class="n">instance_id</span>
<span class="linenos">402</span>        <span class="p">)</span>
<span class="linenos">403</span>
<span class="linenos">404</span>        <span class="n">tracer</span><span class="o">.</span><span class="n">put_annotation</span><span class="p">(</span>
<span class="linenos">405</span>            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;command_id&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;CommandId&quot;</span><span class="p">])</span>
<span class="linenos">406</span>        <span class="n">tracer</span><span class="o">.</span><span class="n">put_annotation</span><span class="p">(</span>
<span class="linenos">407</span>            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;Status&quot;</span><span class="p">])</span>
<span class="linenos">408</span>        <span class="n">tracer</span><span class="o">.</span><span class="n">put_annotation</span><span class="p">(</span>
<span class="linenos">409</span>            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;detailed_status&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;StatusDetails&quot;</span><span class="p">])</span>
<span class="linenos">410</span>        <span class="n">tracer</span><span class="o">.</span><span class="n">put_annotation</span><span class="p">(</span>
<span class="linenos">411</span>            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;StandardOutputContent&quot;</span><span class="p">])</span>
<span class="linenos">412</span>        <span class="n">tracer</span><span class="o">.</span><span class="n">put_annotation</span><span class="p">(</span>
<span class="linenos">413</span>            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;StandardErrorContent&quot;</span><span class="p">])</span>
<span class="linenos">414</span>    <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">415</span>        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
<span class="linenos">416</span>    <span class="k">return</span> <span class="n">response</span><span class="p">,</span> <span class="kc">None</span>
<span class="linenos">417</span>
<span class="linenos">418</span>
<span class="linenos">419</span><span class="k">def</span> <span class="nf">download_csv</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="linenos">420</span>    <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="linenos">421</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">422</span>        <span class="n">response</span> <span class="o">=</span> <span class="n">s3_client</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
<span class="linenos">423</span>        <span class="n">csv_content</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Body&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="linenos">424</span>        <span class="n">csv_file</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">csv_content</span><span class="p">)</span>
<span class="linenos">425</span>        <span class="n">csv_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span>
<span class="linenos">426</span>
<span class="linenos">427</span>        <span class="c1"># Modify the CSV by extracting only the last folder and the filename</span>
<span class="linenos">428</span>        <span class="n">modified_csv</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">429</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_reader</span><span class="p">:</span>
<span class="linenos">430</span>            <span class="n">path_parts</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="linenos">431</span>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path_parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
<span class="linenos">432</span>                <span class="n">filename</span> <span class="o">=</span> <span class="n">path_parts</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">path_parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">433</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">434</span>                <span class="n">filename</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">435</span>            <span class="n">modified_row</span> <span class="o">=</span> <span class="p">[</span><span class="n">filename</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
<span class="linenos">436</span>            <span class="n">modified_csv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">modified_row</span><span class="p">)</span>
<span class="linenos">437</span>
<span class="linenos">438</span>        <span class="k">return</span> <span class="n">modified_csv</span>
<span class="linenos">439</span>    <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">440</span>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="linenos">441</span>        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
<span class="linenos">442</span>
<span class="linenos">443</span>
<span class="linenos">444</span><span class="c1"># function to send notification to the user using SNS topic</span>
<span class="linenos">445</span>
<span class="linenos">446</span>
<span class="linenos">447</span><span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_method</span><span class="p">(</span><span class="n">capture_response</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos">448</span><span class="k">def</span> <span class="nf">send_notification</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">theaterName</span><span class="p">,</span> <span class="n">command_details</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">theater_id</span><span class="p">):</span>
<span class="linenos">449</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">450</span><span class="sd">    Send notification to the user using SES.</span>
<span class="linenos">451</span>
<span class="linenos">452</span><span class="sd">    Parameters</span>
<span class="linenos">453</span><span class="sd">    ----------</span>
<span class="linenos">454</span><span class="sd">    email : str</span>
<span class="linenos">455</span><span class="sd">        Email address.</span>
<span class="linenos">456</span>
<span class="linenos">457</span><span class="sd">    theaterName : str</span>
<span class="linenos">458</span><span class="sd">        Theater name.</span>
<span class="linenos">459</span>
<span class="linenos">460</span><span class="sd">    command_details : dict</span>
<span class="linenos">461</span><span class="sd">        SSM command details.</span>
<span class="linenos">462</span>
<span class="linenos">463</span><span class="sd">    message : dict</span>
<span class="linenos">464</span><span class="sd">        SSM command message.</span>
<span class="linenos">465</span>
<span class="linenos">466</span><span class="sd">    Returns</span>
<span class="linenos">467</span><span class="sd">    -------</span>
<span class="linenos">468</span><span class="sd">    dict</span>
<span class="linenos">469</span><span class="sd">        SNS response.</span>
<span class="linenos">470</span><span class="sd">    str</span>
<span class="linenos">471</span><span class="sd">        Error message if notification is not sent.</span>
<span class="linenos">472</span>
<span class="linenos">473</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">474</span>
<span class="linenos">475</span>    <span class="n">folder_name</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">current_time</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">command_id</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">source_path</span><span class="p">,</span> <span class="n">dest_path</span><span class="p">,</span> <span class="n">source_hash</span><span class="p">,</span> <span class="n">dest_hash</span> <span class="o">=</span> <span class="n">clean_data</span><span class="p">(</span>
<span class="linenos">476</span>        <span class="n">command_details</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
<span class="linenos">477</span>    <span class="c1"># extract date from start time in format YYYY-MM-DD</span>
<span class="linenos">478</span>    <span class="n">date</span> <span class="o">=</span> <span class="n">start_time</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">479</span>    <span class="n">template</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">480</span>    <span class="n">client_csv</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">481</span>    <span class="n">server_csv</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">482</span>    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;Success&#39;</span><span class="p">:</span>
<span class="linenos">483</span>        <span class="n">template</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s1">&#39;template/email_template_success.html&#39;</span><span class="p">)</span>
<span class="linenos">484</span>
<span class="linenos">485</span>        <span class="c1"># Download the client and server CSV files from S3</span>
<span class="linenos">486</span>        <span class="n">client_csv</span> <span class="o">=</span> <span class="n">download_csv</span><span class="p">(</span><span class="n">s3_bucket</span><span class="p">,</span> <span class="n">source_hash</span><span class="p">)</span>
<span class="linenos">487</span>        <span class="n">server_csv</span> <span class="o">=</span> <span class="n">download_csv</span><span class="p">(</span><span class="n">s3_bucket</span><span class="p">,</span> <span class="n">dest_hash</span><span class="p">)</span>
<span class="linenos">488</span>
<span class="linenos">489</span>        <span class="n">logMsg</span> <span class="o">=</span> <span class="s2">&quot;Success on &quot;</span> <span class="o">+</span> <span class="n">theaterName</span> <span class="o">+</span> <span class="s2">&quot;  &quot;</span> <span class="o">+</span> <span class="n">info</span>
<span class="linenos">490</span>        <span class="n">logger</span><span class="o">.</span><span class="n">append_keys</span><span class="p">(</span><span class="n">command_id</span><span class="o">=</span><span class="n">command_id</span><span class="p">)</span>
<span class="linenos">491</span>        <span class="n">logger</span><span class="o">.</span><span class="n">append_keys</span><span class="p">(</span><span class="n">theaterName</span><span class="o">=</span><span class="n">theaterName</span><span class="p">)</span>
<span class="linenos">492</span>        <span class="n">logger</span><span class="o">.</span><span class="n">append_keys</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">)</span>
<span class="linenos">493</span>        <span class="n">logger</span><span class="o">.</span><span class="n">append_keys</span><span class="p">(</span><span class="n">source_path</span><span class="o">=</span><span class="n">source_path</span><span class="p">)</span>
<span class="linenos">494</span>        <span class="n">logger</span><span class="o">.</span><span class="n">append_keys</span><span class="p">(</span><span class="n">dest_path</span><span class="o">=</span><span class="n">dest_path</span><span class="p">)</span>
<span class="linenos">495</span>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">logMsg</span><span class="p">)</span>
<span class="linenos">496</span>
<span class="linenos">497</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">498</span>        <span class="n">template</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s1">&#39;template/email_template.html&#39;</span><span class="p">)</span>
<span class="linenos">499</span>
<span class="linenos">500</span>        <span class="n">logger</span><span class="o">.</span><span class="n">append_keys</span><span class="p">(</span><span class="n">command_id</span><span class="o">=</span><span class="n">command_id</span><span class="p">)</span>
<span class="linenos">501</span>        <span class="n">logger</span><span class="o">.</span><span class="n">append_keys</span><span class="p">(</span><span class="n">theaterName</span><span class="o">=</span><span class="n">theaterName</span><span class="p">)</span>
<span class="linenos">502</span>        <span class="n">logger</span><span class="o">.</span><span class="n">append_keys</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">)</span>
<span class="linenos">503</span>    <span class="n">html</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">theaterName</span><span class="o">=</span><span class="n">theaterName</span><span class="p">,</span> <span class="n">folder_name</span><span class="o">=</span><span class="n">folder_name</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">,</span>
<span class="linenos">504</span>                           <span class="n">command_id</span><span class="o">=</span><span class="n">command_id</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="o">=</span><span class="n">end_time</span><span class="p">,</span> <span class="n">current_time</span><span class="o">=</span><span class="n">current_time</span><span class="p">)</span>
<span class="linenos">505</span>
<span class="linenos">506</span>    <span class="c1"># Create a MIME multipart message object</span>
<span class="linenos">507</span>    <span class="n">msg</span> <span class="o">=</span> <span class="n">MIMEMultipart</span><span class="p">()</span>
<span class="linenos">508</span>    <span class="n">html_part</span> <span class="o">=</span> <span class="n">MIMEText</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">)</span>
<span class="linenos">509</span>    <span class="n">msg</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">html_part</span><span class="p">)</span>
<span class="linenos">510</span>
<span class="linenos">511</span>    <span class="c1"># Add the first image as an attachment to the message object</span>
<span class="linenos">512</span>    <span class="n">img_part1</span> <span class="o">=</span> <span class="n">MIMEImage</span><span class="p">(</span><span class="n">img_data1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;logo.png&#39;</span><span class="p">)</span>
<span class="linenos">513</span>    <span class="n">img_part1</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">,</span>
<span class="linenos">514</span>                         <span class="s1">&#39;attachment&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;logo.png&#39;</span><span class="p">)</span>
<span class="linenos">515</span>    <span class="n">img_part1</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s1">&#39;Content-ID&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;logo&gt;&#39;</span><span class="p">)</span>
<span class="linenos">516</span>    <span class="n">msg</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">img_part1</span><span class="p">)</span>
<span class="linenos">517</span>
<span class="linenos">518</span>    <span class="c1"># Add the second image as an attachment to the message object</span>
<span class="linenos">519</span>    <span class="n">img_part2</span> <span class="o">=</span> <span class="n">MIMEImage</span><span class="p">(</span><span class="n">img_data2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;header.png&#39;</span><span class="p">)</span>
<span class="linenos">520</span>    <span class="n">img_part2</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">,</span>
<span class="linenos">521</span>                         <span class="s1">&#39;attachment&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;header.png&#39;</span><span class="p">)</span>
<span class="linenos">522</span>    <span class="n">img_part2</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s1">&#39;Content-ID&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;header&gt;&#39;</span><span class="p">)</span>
<span class="linenos">523</span>    <span class="n">msg</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">img_part2</span><span class="p">)</span>
<span class="linenos">524</span>
<span class="linenos">525</span>    <span class="c1"># attach both csv files to the email</span>
<span class="linenos">526</span>    <span class="k">if</span> <span class="n">client_csv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">server_csv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">527</span>        <span class="c1"># join rows with &#39;,&#39; and lines with &#39;\r&#39;</span>
<span class="linenos">528</span>        <span class="n">client_csv_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">client_csv</span><span class="p">])</span>
<span class="linenos">529</span>        <span class="n">server_csv_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">server_csv</span><span class="p">])</span>
<span class="linenos">530</span>
<span class="linenos">531</span>        <span class="c1"># create MIMEText objects with the CSV data</span>
<span class="linenos">532</span>        <span class="n">csv_part1</span> <span class="o">=</span> <span class="n">MIMEText</span><span class="p">(</span><span class="n">client_csv_str</span><span class="p">,</span> <span class="n">_subtype</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">)</span>
<span class="linenos">533</span>        <span class="n">csv_part1</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">,</span>
<span class="linenos">534</span>                             <span class="s1">&#39;attachment&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;client-hash.csv&#39;</span><span class="p">)</span>
<span class="linenos">535</span>
<span class="linenos">536</span>        <span class="n">csv_part2</span> <span class="o">=</span> <span class="n">MIMEText</span><span class="p">(</span><span class="n">server_csv_str</span><span class="p">,</span> <span class="n">_subtype</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">)</span>
<span class="linenos">537</span>        <span class="n">csv_part2</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">,</span>
<span class="linenos">538</span>                             <span class="s1">&#39;attachment&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;server-hash.csv&#39;</span><span class="p">)</span>
<span class="linenos">539</span>
<span class="linenos">540</span>        <span class="c1"># attach MIMEText objects to the email message</span>
<span class="linenos">541</span>        <span class="n">msg</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">csv_part1</span><span class="p">)</span>
<span class="linenos">542</span>        <span class="n">msg</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">csv_part2</span><span class="p">)</span>
<span class="linenos">543</span>
<span class="linenos">544</span>    <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;DCP Delivery Status for &quot;</span> <span class="o">+</span> <span class="n">theaterName</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="n">status</span>
<span class="linenos">545</span>    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subject</span>
<span class="linenos">546</span>    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;From&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;DCinema Distribution Status &lt;&quot;</span> <span class="o">+</span> <span class="n">emailfrom</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span>
<span class="linenos">547</span>    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;To&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">email</span>
<span class="linenos">548</span>
<span class="linenos">549</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">550</span>        <span class="n">response</span> <span class="o">=</span> <span class="n">ses_client</span><span class="o">.</span><span class="n">send_raw_email</span><span class="p">(</span>
<span class="linenos">551</span>            <span class="n">Source</span><span class="o">=</span><span class="n">emailfrom</span><span class="p">,</span>
<span class="linenos">552</span>            <span class="n">Destinations</span><span class="o">=</span><span class="p">[</span><span class="n">email</span><span class="p">],</span>
<span class="linenos">553</span>            <span class="n">RawMessage</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Data&#39;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">as_string</span><span class="p">()}</span>
<span class="linenos">554</span>        <span class="p">)</span>
<span class="linenos">555</span>    <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">556</span>        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
<span class="linenos">557</span>    <span class="k">return</span> <span class="n">response</span><span class="p">,</span> <span class="kc">None</span>
<span class="linenos">558</span>
<span class="linenos">559</span>
<span class="linenos">560</span><span class="c1"># SES , create new using the environment variable EMAIL_FROM if not present. Else, use the existing one.</span>
<span class="linenos">561</span><span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_method</span><span class="p">(</span><span class="n">capture_response</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos">562</span><span class="k">def</span> <span class="nf">verify_email_identity</span><span class="p">(</span><span class="n">email_from</span><span class="p">,</span> <span class="n">ses_client</span><span class="p">):</span>
<span class="linenos">563</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">564</span><span class="sd">    SES , create new using the environment variable EMAIL_FROM if not present. Else, use the existing one.</span>
<span class="linenos">565</span>
<span class="linenos">566</span><span class="sd">    Parameters</span>
<span class="linenos">567</span><span class="sd">    ----------</span>
<span class="linenos">568</span><span class="sd">    email_from : str</span>
<span class="linenos">569</span><span class="sd">        Email address.</span>
<span class="linenos">570</span>
<span class="linenos">571</span><span class="sd">    ses_client : boto3.client</span>
<span class="linenos">572</span><span class="sd">        SES client.</span>
<span class="linenos">573</span>
<span class="linenos">574</span><span class="sd">    Returns</span>
<span class="linenos">575</span><span class="sd">    -------</span>
<span class="linenos">576</span><span class="sd">    str</span>
<span class="linenos">577</span><span class="sd">        Email address.</span>
<span class="linenos">578</span><span class="sd">    str</span>
<span class="linenos">579</span><span class="sd">        Error message if email address is not verified.</span>
<span class="linenos">580</span>
<span class="linenos">581</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">582</span>
<span class="linenos">583</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">584</span>        <span class="n">response</span> <span class="o">=</span> <span class="n">ses_client</span><span class="o">.</span><span class="n">list_identities</span><span class="p">(</span>
<span class="linenos">585</span>            <span class="n">IdentityType</span><span class="o">=</span><span class="s1">&#39;EmailAddress&#39;</span><span class="p">,</span>
<span class="linenos">586</span>            <span class="n">MaxItems</span><span class="o">=</span><span class="mi">123</span>
<span class="linenos">587</span>        <span class="p">)</span>
<span class="linenos">588</span>        <span class="c1"># check if the email address is already exists in the SES, if not then create new one using the environment variable EMAIL_FROM, else use the existing one return email from.</span>
<span class="linenos">589</span>        <span class="k">if</span> <span class="n">email_from</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;Identities&quot;</span><span class="p">]:</span>
<span class="linenos">590</span>            <span class="n">response</span> <span class="o">=</span> <span class="n">ses_client</span><span class="o">.</span><span class="n">verify_email_identity</span><span class="p">(</span>
<span class="linenos">591</span>                <span class="n">EmailAddress</span><span class="o">=</span><span class="n">email_from</span>
<span class="linenos">592</span>            <span class="p">)</span>
<span class="linenos">593</span>            <span class="c1"># wait for the email to be verified</span>
<span class="linenos">594</span>            <span class="n">ses_client</span><span class="o">.</span><span class="n">get_identity_verification_attributes</span><span class="p">(</span>
<span class="linenos">595</span>                <span class="n">Identities</span><span class="o">=</span><span class="p">[</span><span class="n">email_from</span><span class="p">]</span>
<span class="linenos">596</span>            <span class="p">)</span>
<span class="linenos">597</span>            <span class="k">return</span> <span class="n">email_from</span><span class="p">,</span> <span class="kc">None</span>
<span class="linenos">598</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">599</span>            <span class="k">return</span> <span class="n">email_from</span><span class="p">,</span> <span class="kc">None</span>
<span class="linenos">600</span>    <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">601</span>        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
<span class="linenos">602</span>
<span class="linenos">603</span>
<span class="linenos">604</span><span class="c1"># lambda handler function</span>
<span class="linenos">605</span><span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_lambda_handler</span>
<span class="linenos">606</span><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<span class="linenos">607</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">608</span><span class="sd">    Lambda handler function.</span>
<span class="linenos">609</span>
<span class="linenos">610</span><span class="sd">    Parameters</span>
<span class="linenos">611</span><span class="sd">    ----------</span>
<span class="linenos">612</span><span class="sd">    event : dict</span>
<span class="linenos">613</span><span class="sd">        Event data.</span>
<span class="linenos">614</span>
<span class="linenos">615</span><span class="sd">    context : object</span>
<span class="linenos">616</span><span class="sd">        Lambda Context runtime methods and attributes.</span>
<span class="linenos">617</span>
<span class="linenos">618</span><span class="sd">    Returns</span>
<span class="linenos">619</span><span class="sd">    -------</span>
<span class="linenos">620</span><span class="sd">    dict</span>
<span class="linenos">621</span><span class="sd">        Response.</span>
<span class="linenos">622</span><span class="sd">    str</span>
<span class="linenos">623</span><span class="sd">        Error message if any.</span>
<span class="linenos">624</span>
<span class="linenos">625</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">626</span>
<span class="linenos">627</span>    <span class="c1"># fetch instance id from event</span>
<span class="linenos">628</span>    <span class="c1"># fetch command id from event which is an SNSEvent, the body of the event is a json string{&quot;commandId&quot;:&quot;7463d40e-a888-4a09-96da-ed0f42773554&quot;,&quot;documentName&quot;:&quot;DCinema-SSMDocument-tNyLEG2ZHRZy&quot;,&quot;instanceId&quot;:&quot;mi-076b2425febe0914e&quot;,&quot;requestedDateTime&quot;:&quot;2023-02-20T13:22:47.378Z&quot;,&quot;status&quot;:&quot;InProgress&quot;,&quot;detailedStatus&quot;:&quot;InProgress&quot;,&quot;eventTime&quot;:&quot;2023-02-20T13:22:47.406Z&quot;}</span>
<span class="linenos">629</span>    <span class="n">message</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;Records&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;Sns&quot;</span><span class="p">][</span><span class="s2">&quot;Message&quot;</span><span class="p">])</span>
<span class="linenos">630</span>    <span class="n">instance_id</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="s2">&quot;instanceId&quot;</span><span class="p">]</span>
<span class="linenos">631</span>    <span class="n">command_id</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="s2">&quot;commandId&quot;</span><span class="p">]</span>
<span class="linenos">632</span>    <span class="c1"># add to dynamodb table</span>
<span class="linenos">633</span>
<span class="linenos">634</span>    <span class="c1"># verify email from SES</span>
<span class="linenos">635</span>    <span class="n">email_from</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">verify_email_identity</span><span class="p">(</span><span class="n">emailfrom</span><span class="p">,</span> <span class="n">ses_client</span><span class="p">)</span>
<span class="linenos">636</span>    <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
<span class="linenos">637</span>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="linenos">638</span>        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">error</span>
<span class="linenos">639</span>
<span class="linenos">640</span>    <span class="c1"># fetch theater details from dynamodb table using instance id</span>
<span class="linenos">641</span>    <span class="n">theater_details</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">get_instance_details</span><span class="p">(</span><span class="n">instance_id</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
<span class="linenos">642</span>    <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
<span class="linenos">643</span>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="linenos">644</span>        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">error</span>
<span class="linenos">645</span>
<span class="linenos">646</span>    <span class="c1"># use command id to fetch command details from SSM run command history</span>
<span class="linenos">647</span>    <span class="n">command_details</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">get_command_details</span><span class="p">(</span>
<span class="linenos">648</span>        <span class="n">command_id</span><span class="p">,</span> <span class="n">instance_id</span><span class="p">,</span> <span class="n">ssm_client</span><span class="p">)</span>
<span class="linenos">649</span>    <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
<span class="linenos">650</span>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="linenos">651</span>        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">error</span>
<span class="linenos">652</span>    <span class="c1"># store the command details in dynamodb table</span>
<span class="linenos">653</span>
<span class="linenos">654</span>    <span class="c1"># use theater email id to send notification to the user, with the status of the SSM document execution output</span>
<span class="linenos">655</span>    <span class="n">theaterName</span> <span class="o">=</span> <span class="n">theater_details</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;TheaterName&quot;</span><span class="p">]</span>
<span class="linenos">656</span>    <span class="n">email</span> <span class="o">=</span> <span class="n">theater_details</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;TheaterEmail&quot;</span><span class="p">]</span>
<span class="linenos">657</span>    <span class="n">theater_id</span> <span class="o">=</span> <span class="n">theater_details</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;TheaterId&quot;</span><span class="p">]</span>
<span class="linenos">658</span>    <span class="n">res</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">store_status_in_dynamodb</span><span class="p">(</span><span class="n">command_details</span><span class="p">,</span> <span class="n">theater_id</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
<span class="linenos">659</span>    <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
<span class="linenos">660</span>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="linenos">661</span>        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">error</span>
<span class="linenos">662</span>    <span class="n">response</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">send_notification</span><span class="p">(</span>
<span class="linenos">663</span>        <span class="n">email</span><span class="p">,</span> <span class="n">theaterName</span><span class="p">,</span> <span class="n">command_details</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">theater_id</span><span class="p">)</span>
<span class="linenos">664</span>    <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
<span class="linenos">665</span>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="linenos">666</span>        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">error</span>
<span class="linenos">667</span>    <span class="k">return</span> <span class="n">response</span><span class="p">,</span> <span class="kc">None</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="ExpeDatSSMInvocationQuery.html" class="btn btn-neutral float-left" title="ExpeDatSSMInvocationQuery Documentation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="DashboardFunction.html" class="btn btn-neutral float-right" title="DashboardFunction Documentation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Prime Focus.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>