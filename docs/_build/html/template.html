<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cloudformation Template &mdash; DCinema Distribution AWS Resources 1.0.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Lambda Function" href="modules.html" />
    <link rel="prev" title="Welcome to DCinema Distribution AWS documentation!" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            DCinema Distribution AWS Resources
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Cloudformation Template</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#sam-template-anatomy">SAM Template Anatomy</a></li>
<li class="toctree-l2"><a class="reference internal" href="#architecture">Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="#globals">Globals</a></li>
<li class="toctree-l2"><a class="reference internal" href="#conditions">Conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#parameters">Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#resources">Resources</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#api-gateway">API Gateway</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#api-gateway-secret-key">API Gateway Secret Key</a></li>
<li class="toctree-l4"><a class="reference internal" href="#main-api-gateway-endpoint">Main API Gateway Endpoint</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ssmactivationapi">SSMActivationApi</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ssminstallscriptgeneratorapi">SSMInstallScriptGeneratorApi</a></li>
<li class="toctree-l4"><a class="reference internal" href="#statemachineapi">StateMachineApi</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#lambda-functions">Lambda Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#custom-authorizer">Custom Authorizer</a></li>
<li class="toctree-l4"><a class="reference internal" href="#expedatssmrundocumet">ExpeDatSSMRunDocumet</a></li>
<li class="toctree-l4"><a class="reference internal" href="#expedatssminvocationquery">ExpeDatSSMInvocationQuery</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ssmagentactivation">SSMAgentActivation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ssmnotification">SSMNotification</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ssminstallscriptgenerator">SSMInstallScriptGenerator</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dashboardfunction">DashboardFunction</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#sns-topic">SNS Topic</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#snsnotificationtopic">SNSNotificationTopic</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#ssm-document">SSM Document</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#ssmdocument">SSMDocument</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#ssm-parameters-store">SSM Parameters Store</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#expedatuserparametername">ExpeDatUserParameterName</a></li>
<li class="toctree-l4"><a class="reference internal" href="#expedatpassparametername">ExpeDatPassParameterName</a></li>
<li class="toctree-l4"><a class="reference internal" href="#expedatserverparametername">ExpeDatServerParameterName</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ssmactivationparameter">SSMActivationParameter</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#dynamodb-table">DynamoDB Table</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#dynamodbtabletheater">DynamoDBTableTheater</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dynamodbtablestatus">DynamoDBTableStatus</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#cloudwatch-dashboard">Cloudwatch Dashboard</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#cloudwatchdashboard">CloudwatchDashboard</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#step-functions">Step Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#statemachineexpresssync">StateMachineExpressSync</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#iam-role">IAM Role</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#customauthorizerrole">CustomAuthorizerRole</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ssmnotificationrole">SSMNotificationRole</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ssminstallscriptgeneratorrole">SSMInstallScriptGeneratorRole</a></li>
<li class="toctree-l4"><a class="reference internal" href="#expedatssmrundocumetrole">ExpeDatSSMRunDocumetRole</a></li>
<li class="toctree-l4"><a class="reference internal" href="#expedatssminvocationqueryrole">ExpeDatSSMInvocationQueryRole</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ssmagentactivationrole">SSMAgentActivationRole</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ssmagentrole">SSMAgentRole</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ssmsnspublishrole">SSMSNSPublishRole</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dashboardfunctionrole">DashboardFunctionRole</a></li>
<li class="toctree-l4"><a class="reference internal" href="#statemachineapirole">StateMachineApiRole</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#outputs">Outputs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="modules.html">Lambda Function</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">DCinema Distribution AWS Resources</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Cloudformation Template</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/template.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="cloudformation-template">
<h1>Cloudformation Template<a class="headerlink" href="#cloudformation-template" title="Permalink to this headline"></a></h1>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#sam-template-anatomy" id="id37">SAM Template Anatomy</a></p></li>
<li><p><a class="reference internal" href="#architecture" id="id38">Architecture</a></p></li>
<li><p><a class="reference internal" href="#globals" id="id39">Globals</a></p></li>
<li><p><a class="reference internal" href="#conditions" id="id40">Conditions</a></p></li>
<li><p><a class="reference internal" href="#parameters" id="id41">Parameters</a></p></li>
<li><p><a class="reference internal" href="#resources" id="id42">Resources</a></p>
<ul>
<li><p><a class="reference internal" href="#api-gateway" id="id43">API Gateway</a></p>
<ul>
<li><p><a class="reference internal" href="#api-gateway-secret-key" id="id44">API Gateway Secret Key</a></p></li>
<li><p><a class="reference internal" href="#main-api-gateway-endpoint" id="id45">Main API Gateway Endpoint</a></p></li>
<li><p><a class="reference internal" href="#ssmactivationapi" id="id46">SSMActivationApi</a></p></li>
<li><p><a class="reference internal" href="#ssminstallscriptgeneratorapi" id="id47">SSMInstallScriptGeneratorApi</a></p></li>
<li><p><a class="reference internal" href="#statemachineapi" id="id48">StateMachineApi</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#lambda-functions" id="id49">Lambda Functions</a></p>
<ul>
<li><p><a class="reference internal" href="#custom-authorizer" id="id50">Custom Authorizer</a></p></li>
<li><p><a class="reference internal" href="#expedatssmrundocumet" id="id51">ExpeDatSSMRunDocumet</a></p></li>
<li><p><a class="reference internal" href="#expedatssminvocationquery" id="id52">ExpeDatSSMInvocationQuery</a></p></li>
<li><p><a class="reference internal" href="#ssmagentactivation" id="id53">SSMAgentActivation</a></p></li>
<li><p><a class="reference internal" href="#ssmnotification" id="id54">SSMNotification</a></p></li>
<li><p><a class="reference internal" href="#ssminstallscriptgenerator" id="id55">SSMInstallScriptGenerator</a></p></li>
<li><p><a class="reference internal" href="#dashboardfunction" id="id56">DashboardFunction</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#sns-topic" id="id57">SNS Topic</a></p>
<ul>
<li><p><a class="reference internal" href="#snsnotificationtopic" id="id58">SNSNotificationTopic</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#ssm-document" id="id59">SSM Document</a></p>
<ul>
<li><p><a class="reference internal" href="#ssmdocument" id="id60">SSMDocument</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#ssm-parameters-store" id="id61">SSM Parameters Store</a></p>
<ul>
<li><p><a class="reference internal" href="#expedatuserparametername" id="id62">ExpeDatUserParameterName</a></p></li>
<li><p><a class="reference internal" href="#expedatpassparametername" id="id63">ExpeDatPassParameterName</a></p></li>
<li><p><a class="reference internal" href="#expedatserverparametername" id="id64">ExpeDatServerParameterName</a></p></li>
<li><p><a class="reference internal" href="#ssmactivationparameter" id="id65">SSMActivationParameter</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#dynamodb-table" id="id66">DynamoDB Table</a></p>
<ul>
<li><p><a class="reference internal" href="#dynamodbtabletheater" id="id67">DynamoDBTableTheater</a></p></li>
<li><p><a class="reference internal" href="#dynamodbtablestatus" id="id68">DynamoDBTableStatus</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#cloudwatch-dashboard" id="id69">Cloudwatch Dashboard</a></p>
<ul>
<li><p><a class="reference internal" href="#cloudwatchdashboard" id="id70">CloudwatchDashboard</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#step-functions" id="id71">Step Functions</a></p>
<ul>
<li><p><a class="reference internal" href="#statemachineexpresssync" id="id72">StateMachineExpressSync</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#iam-role" id="id73">IAM Role</a></p>
<ul>
<li><p><a class="reference internal" href="#customauthorizerrole" id="id74">CustomAuthorizerRole</a></p></li>
<li><p><a class="reference internal" href="#ssmnotificationrole" id="id75">SSMNotificationRole</a></p></li>
<li><p><a class="reference internal" href="#ssminstallscriptgeneratorrole" id="id76">SSMInstallScriptGeneratorRole</a></p></li>
<li><p><a class="reference internal" href="#expedatssmrundocumetrole" id="id77">ExpeDatSSMRunDocumetRole</a></p></li>
<li><p><a class="reference internal" href="#expedatssminvocationqueryrole" id="id78">ExpeDatSSMInvocationQueryRole</a></p></li>
<li><p><a class="reference internal" href="#ssmagentactivationrole" id="id79">SSMAgentActivationRole</a></p></li>
<li><p><a class="reference internal" href="#ssmagentrole" id="id80">SSMAgentRole</a></p></li>
<li><p><a class="reference internal" href="#ssmsnspublishrole" id="id81">SSMSNSPublishRole</a></p></li>
<li><p><a class="reference internal" href="#dashboardfunctionrole" id="id82">DashboardFunctionRole</a></p></li>
<li><p><a class="reference internal" href="#statemachineapirole" id="id83">StateMachineApiRole</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#outputs" id="id84">Outputs</a></p></li>
</ul>
</div>
<div class="toctree-wrapper compound">
</div>
<section id="sam-template-anatomy">
<h2>SAM Template Anatomy<a class="headerlink" href="#sam-template-anatomy" title="Permalink to this headline"></a></h2>
<p>This section describes the anatomy of the SAM template. The SAM template is a YAML file that defines the resources that are created by the template. The resources are defined by their type and properties. The properties are specific to the resource type. For example, the AWS::Serverless::Function resource type has properties that define the function code, runtime, handler, and other function properties.</p>
<p>The following example shows a YAML-formatted template fragment:</p>
<blockquote>
<div><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">Transform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Serverless-2016-10-31</span>

<span class="nt">Globals</span><span class="p">:</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">set of globals</span>

<span class="nt">Description</span><span class="p">:</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">String</span>

<span class="nt">Metadata</span><span class="p">:</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">template metadata</span>

<span class="nt">Parameters</span><span class="p">:</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">set of parameters</span>

<span class="nt">Mappings</span><span class="p">:</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">set of mappings</span>

<span class="nt">Conditions</span><span class="p">:</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">set of conditions</span>

<span class="nt">Resources</span><span class="p">:</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">set of resources</span>

<span class="nt">Outputs</span><span class="p">:</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">set of outputs</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="architecture">
<h2>Architecture<a class="headerlink" href="#architecture" title="Permalink to this headline"></a></h2>
<p>The following diagram shows the architecture of the solution.</p>
<img alt="Architecture" src="_images/template.png" />
<p>A more understandable diagram is shown below.</p>
<img alt="Architecture" src="_images/aws.png" />
</section>
<section id="globals">
<h2>Globals<a class="headerlink" href="#globals" title="Permalink to this headline"></a></h2>
<p>This section defines the global properties that are applied to all resources in the template. For example Tags, Tracing, etc.</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">template.yaml - Globals</span><a class="headerlink" href="#id1" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="nt">Globals</span><span class="p">:</span>
<span class="linenos"> 2</span><span class="w">  </span><span class="nt">Function</span><span class="p">:</span>
<span class="linenos"> 3</span><span class="w">    </span><span class="nt">Timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300</span>
<span class="linenos"> 4</span><span class="w">    </span><span class="nt">MemorySize</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">128</span>
<span class="linenos"> 5</span><span class="w">    </span><span class="nt">Tracing</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Active</span>
<span class="linenos"> 6</span><span class="w">    </span><span class="nt">Tags</span><span class="p">:</span>
<span class="linenos"> 7</span><span class="w">      </span><span class="nt">Project</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::StackName</span>
<span class="linenos"> 8</span><span class="w">      </span><span class="nt">Environment</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prod</span>
<span class="linenos"> 9</span><span class="w">      </span><span class="nt">Owner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mondanthody.firos@primefocus.com</span>
<span class="linenos">10</span><span class="w">      </span><span class="nt">map-migrated</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">d-server-00c79yzv8q8cvz</span>
<span class="linenos">11</span><span class="w">  </span><span class="nt">Api</span><span class="p">:</span>
<span class="linenos">12</span><span class="w">    </span><span class="nt">TracingEnabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
</div>
</section>
<section id="conditions">
<h2>Conditions<a class="headerlink" href="#conditions" title="Permalink to this headline"></a></h2>
<p>This section defines the conditions that are used to control the creation of resources in the template. The conditions are used to control the creation of resources based on the value of a parameter. For example, the following condition creates the Step function only if the DeployStepFunction parameter is set to true.</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">template.yaml - Conditions</span><a class="headerlink" href="#id2" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="nt">Conditions</span><span class="p">:</span>
<span class="linenos">2</span><span class="w">  </span><span class="nt">DeployStepFunction</span><span class="p">:</span><span class="w"> </span><span class="kt">!Equals</span>
<span class="linenos">3</span><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DeployStepFunction</span>
<span class="linenos">4</span><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;true&#39;</span>
<span class="linenos">5</span><span class="nt">Parameters</span><span class="p">:</span>
</pre></div>
</div>
</div>
</section>
<section id="parameters">
<h2>Parameters<a class="headerlink" href="#parameters" title="Permalink to this headline"></a></h2>
<p>This section defines the parameters that can be passed to the template. The parameters are used to configure the resources in the template.</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">template.yaml - Parameters</span><a class="headerlink" href="#id3" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">  </span><span class="nt">ExpedatUser</span><span class="p">:</span>
<span class="linenos"> 2</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">String</span>
<span class="linenos"> 3</span><span class="w">    </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Expedat User</span>
<span class="linenos"> 4</span><span class="w">    </span><span class="nt">Default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">username</span>
<span class="linenos"> 5</span><span class="w">  </span><span class="nt">ExpedatPass</span><span class="p">:</span>
<span class="linenos"> 6</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">String</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Expedat Password</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="nt">Default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">password</span>
<span class="linenos"> 9</span><span class="w">  </span><span class="nt">ExpedatServer</span><span class="p">:</span>
<span class="linenos">10</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">String</span>
<span class="linenos">11</span><span class="w">    </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Expedat Server</span>
<span class="linenos">12</span><span class="w">    </span><span class="nt">Default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server</span>
<span class="linenos">13</span><span class="w">  </span><span class="nt">ExpedatPort</span><span class="p">:</span>
<span class="linenos">14</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">String</span>
<span class="linenos">15</span><span class="w">    </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Expedat Port</span>
<span class="linenos">16</span><span class="w">    </span><span class="nt">Default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">port</span>
<span class="linenos">17</span><span class="w">  </span><span class="nt">DeployStepFunction</span><span class="p">:</span>
<span class="linenos">18</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">String</span>
<span class="linenos">19</span><span class="w">    </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deploy Step Function</span>
<span class="linenos">20</span><span class="w">    </span><span class="nt">Default</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;false&#39;</span>
<span class="linenos">21</span><span class="w">  </span><span class="nt">NotificationEmailFrom</span><span class="p">:</span>
<span class="linenos">22</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">String</span>
<span class="linenos">23</span><span class="w">    </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Notification Email</span>
<span class="linenos">24</span><span class="w">    </span><span class="nt">Default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">email</span>
<span class="linenos">25</span><span class="w">  </span><span class="nt">ExpedatServerId</span><span class="p">:</span>
</pre></div>
</div>
</div>
</section>
<section id="resources">
<h2>Resources<a class="headerlink" href="#resources" title="Permalink to this headline"></a></h2>
<p>This section defines the resources that are created by the template. The resources are defined by their type and properties. The properties are specific to the resource type. For example, the AWS::Serverless::Function resource type has properties that define the function code, runtime, handler, and other function properties.</p>
<section id="api-gateway">
<h3>API Gateway<a class="headerlink" href="#api-gateway" title="Permalink to this headline"></a></h3>
<section id="api-gateway-secret-key">
<h4>API Gateway Secret Key<a class="headerlink" href="#api-gateway-secret-key" title="Permalink to this headline"></a></h4>
<p>This section defines the API Gateway Secret Key. The API Gateway Secret Key is used to secure the API Gateway endpoint. The API Gateway Secret Key is passed to the API Gateway as a header value. The API Gateway Secret Key is used to validate the request before the request is forwarded to the Lambda function.</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">template.yaml - API Gateway Secret Key</span><a class="headerlink" href="#id4" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">    </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Expedat Server ID</span>
<span class="linenos"> 2</span><span class="w">    </span><span class="nt">Default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mi-08c5025fa198fe218</span>
<span class="linenos"> 3</span><span class="w"> </span><span class="w w-Error"> </span><span class="nt">S3Bucket</span><span class="p">:</span>
<span class="linenos"> 4</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">String</span>
<span class="linenos"> 5</span><span class="w">    </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">S3 Bucket</span>
<span class="linenos"> 6</span><span class="w">    </span><span class="nt">Default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mum-pr-dcinema-deployments-s3</span>
<span class="linenos"> 7</span><span class="nt">Resources</span><span class="p">:</span>
<span class="linenos"> 8</span><span class="w">  </span><span class="nt">ApiGatewaySecretKeyResource</span><span class="p">:</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::SecretsManager::Secret</span>
<span class="linenos">10</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">11</span><span class="w">      </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-ApiGatewaySecretKey-${AWS::Region}</span>
<span class="linenos">12</span><span class="w">      </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Random API Key for API Gateway Endpoint</span>
<span class="linenos">13</span><span class="w">      </span><span class="nt">Tags</span><span class="p">:</span>
<span class="linenos">14</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Project</span>
<span class="linenos">15</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::StackName</span>
<span class="linenos">16</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Environment</span>
<span class="linenos">17</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prod</span>
<span class="linenos">18</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Owner</span>
<span class="linenos">19</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mondanthody.firos@primefocus.com</span>
<span class="linenos">20</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">map-migrated</span>
<span class="linenos">21</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">d-server-00c79yzv8q8cvz</span>
<span class="linenos">22</span><span class="w">      </span><span class="nt">GenerateSecretString</span><span class="p">:</span>
<span class="linenos">23</span><span class="w">        </span><span class="nt">SecretStringTemplate</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{&quot;api_key&quot;:</span><span class="nv"> </span><span class="s">&quot;${rand}&quot;}&#39;</span>
</pre></div>
</div>
</div>
</section>
<section id="main-api-gateway-endpoint">
<h4>Main API Gateway Endpoint<a class="headerlink" href="#main-api-gateway-endpoint" title="Permalink to this headline"></a></h4>
<p>This section defines the API Gateway. The API Gateway is used to expose the Lambda function as a REST API endpoint. The API Gateway is configured to use the API Gateway Secret Key to secure the API Gateway endpoint.</p>
<dl class="simple">
<dt>Methods:</dt><dd><ul class="simple">
<li><p>/run</p></li>
<li><p>/query</p></li>
</ul>
</dd>
</dl>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">template.yaml - API Gateway</span><a class="headerlink" href="#id5" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:CreateLogStream</span>
<span class="linenos">  2</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:PutLogEvents</span>
<span class="linenos">  3</span><span class="w">               </span><span class="w w-Error"> </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;*&#39;</span>
<span class="linenos">  4</span><span class="w">             </span><span class="w w-Error"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">  5</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">  6</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">secretsmanager:GetSecretValue</span>
<span class="linenos">  7</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${ApiGatewaySecretKeyResource}*</span>
<span class="linenos">  8</span><span class="w">       </span><span class="w w-Error"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xraysdk</span>
<span class="linenos">  9</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos"> 10</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos"> 11</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos"> 12</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos"> 13</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos"> 14</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xray:PutTraceSegments</span>
<span class="linenos"> 15</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xray:PutTelemetryRecords</span>
<span class="linenos"> 16</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;*&#39;</span>
<span class="linenos"> 17</span><span class="w"> </span><span class="w w-Error"> </span><span class="nt">ApiGatewayEndpoint</span><span class="p">:</span>
<span class="linenos"> 18</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Serverless::Api</span>
<span class="linenos"> 19</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos"> 20</span><span class="w">      </span><span class="nt">StageName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prod</span>
<span class="linenos"> 21</span><span class="w">      </span><span class="nt">TracingEnabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="linenos"> 22</span><span class="w">      </span><span class="nt">Auth</span><span class="p">:</span>
<span class="linenos"> 23</span><span class="w">        </span><span class="nt">DefaultAuthorizer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CustomAuthorizer</span>
<span class="linenos"> 24</span><span class="w">        </span><span class="nt">Authorizers</span><span class="p">:</span>
<span class="linenos"> 25</span><span class="w">          </span><span class="nt">CustomAuthorizer</span><span class="p">:</span>
<span class="linenos"> 26</span><span class="w">            </span><span class="nt">FunctionPayloadType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">REQUEST</span>
<span class="linenos"> 27</span><span class="w">            </span><span class="nt">FunctionArn</span><span class="p">:</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CustomAuthorizer.Arn</span>
<span class="linenos"> 28</span><span class="w">            </span><span class="nt">Identity</span><span class="p">:</span>
<span class="linenos"> 29</span><span class="w">              </span><span class="nt">Headers</span><span class="p">:</span>
<span class="linenos"> 30</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">x-api-key</span>
<span class="linenos"> 31</span><span class="w">              </span><span class="nt">ReauthorizeEvery</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="linenos"> 32</span><span class="w">      </span><span class="nt">Tags</span><span class="p">:</span>
<span class="linenos"> 33</span><span class="w">        </span><span class="nt">Project</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::StackName</span>
<span class="linenos"> 34</span><span class="w">        </span><span class="nt">Environment</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prod</span>
<span class="linenos"> 35</span><span class="w">        </span><span class="nt">Owner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mondanthody.firos@primefocus.com</span>
<span class="linenos"> 36</span><span class="w">      </span><span class="nt">DefinitionBody</span><span class="p">:</span>
<span class="linenos"> 37</span><span class="w">        </span><span class="nt">swagger</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2.0&#39;</span>
<span class="linenos"> 38</span><span class="w">        </span><span class="nt">info</span><span class="p">:</span>
<span class="linenos"> 39</span><span class="w">          </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2018-11-29T23:30:18Z&#39;</span>
<span class="linenos"> 40</span><span class="w">          </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-ExpeDatSSM-API</span>
<span class="linenos"> 41</span><span class="w">        </span><span class="nt">x-amazon-apigateway-request-validators</span><span class="p">:</span>
<span class="linenos"> 42</span><span class="w">          </span><span class="nt">validateRequestBody</span><span class="p">:</span>
<span class="linenos"> 43</span><span class="w">            </span><span class="nt">validateRequestBody</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="linenos"> 44</span><span class="w">            </span><span class="nt">validateRequestParameters</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="linenos"> 45</span><span class="w">        </span><span class="nt">x-amazon-apigateway-request-validator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">validateRequestBody</span>
<span class="linenos"> 46</span><span class="w">        </span><span class="nt">paths</span><span class="p">:</span>
<span class="linenos"> 47</span><span class="w">          </span><span class="nt">/run</span><span class="p">:</span>
<span class="linenos"> 48</span><span class="w">            </span><span class="nt">post</span><span class="p">:</span>
<span class="linenos"> 49</span><span class="w">              </span><span class="nt">x-amazon-apigateway-request-validator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">validateRequestBody</span>
<span class="linenos"> 50</span><span class="w">              </span><span class="nt">consumes</span><span class="p">:</span>
<span class="linenos"> 51</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">application/json</span>
<span class="linenos"> 52</span><span class="w">              </span><span class="nt">produces</span><span class="p">:</span>
<span class="linenos"> 53</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">application/json</span>
<span class="linenos"> 54</span><span class="w">              </span><span class="nt">parameters</span><span class="p">:</span>
<span class="linenos"> 55</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">in</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">body</span>
<span class="linenos"> 56</span><span class="w">                  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">body</span>
<span class="linenos"> 57</span><span class="w">                  </span><span class="nt">required</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="linenos"> 58</span><span class="w">                  </span><span class="nt">schema</span><span class="p">:</span>
<span class="linenos"> 59</span><span class="w">                    </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/RunRequestModel&#39;</span>
<span class="linenos"> 60</span><span class="w">              </span><span class="nt">x-amazon-apigateway-integration</span><span class="p">:</span>
<span class="linenos"> 61</span><span class="w">                </span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ExpeDatSSMRunDocumet.Arn}/invocations</span>
<span class="linenos"> 62</span><span class="w">                </span><span class="nt">passthroughBehavior</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">when_no_match</span>
<span class="linenos"> 63</span><span class="w">                </span><span class="nt">httpMethod</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POST</span>
<span class="linenos"> 64</span><span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws_proxy</span>
<span class="linenos"> 65</span><span class="w">                </span><span class="nt">responses</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="linenos"> 66</span><span class="w">              </span><span class="nt">security</span><span class="p">:</span>
<span class="linenos"> 67</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">CustomAuthorizer</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="linenos"> 68</span><span class="w">          </span><span class="nt">/query</span><span class="p">:</span>
<span class="linenos"> 69</span><span class="w">            </span><span class="nt">post</span><span class="p">:</span>
<span class="linenos"> 70</span><span class="w">              </span><span class="nt">x-amazon-apigateway-request-validator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">validateRequestBody</span>
<span class="linenos"> 71</span><span class="w">              </span><span class="nt">consumes</span><span class="p">:</span>
<span class="linenos"> 72</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">application/json</span>
<span class="linenos"> 73</span><span class="w">              </span><span class="nt">produces</span><span class="p">:</span>
<span class="linenos"> 74</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">application/json</span>
<span class="linenos"> 75</span><span class="w">              </span><span class="nt">parameters</span><span class="p">:</span>
<span class="linenos"> 76</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">in</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">body</span>
<span class="linenos"> 77</span><span class="w">                  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">body</span>
<span class="linenos"> 78</span><span class="w">                  </span><span class="nt">required</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="linenos"> 79</span><span class="w">                  </span><span class="nt">schema</span><span class="p">:</span>
<span class="linenos"> 80</span><span class="w">                    </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/QueryRequestModel&#39;</span>
<span class="linenos"> 81</span><span class="w">              </span><span class="nt">x-amazon-apigateway-integration</span><span class="p">:</span>
<span class="linenos"> 82</span><span class="w">                </span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ExpeDatSSMInvocationQuery.Arn}/invocations</span>
<span class="linenos"> 83</span><span class="w">                </span><span class="nt">passthroughBehavior</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">when_no_match</span>
<span class="linenos"> 84</span><span class="w">                </span><span class="nt">httpMethod</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POST</span>
<span class="linenos"> 85</span><span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws_proxy</span>
<span class="linenos"> 86</span><span class="w">              </span><span class="nt">responses</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="linenos"> 87</span><span class="w">              </span><span class="nt">security</span><span class="p">:</span>
<span class="linenos"> 88</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">CustomAuthorizer</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="linenos"> 89</span><span class="w">          </span><span class="nt">/cancel</span><span class="p">:</span>
<span class="linenos"> 90</span><span class="w">            </span><span class="nt">post</span><span class="p">:</span>
<span class="linenos"> 91</span><span class="w">              </span><span class="nt">x-amazon-apigateway-request-validator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">validateRequestBody</span>
<span class="linenos"> 92</span><span class="w">              </span><span class="nt">consumes</span><span class="p">:</span>
<span class="linenos"> 93</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">application/json</span>
<span class="linenos"> 94</span><span class="w">              </span><span class="nt">produces</span><span class="p">:</span>
<span class="linenos"> 95</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">application/json</span>
<span class="linenos"> 96</span><span class="w">              </span><span class="nt">parameters</span><span class="p">:</span>
<span class="linenos"> 97</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">in</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">body</span>
<span class="linenos"> 98</span><span class="w">                  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">body</span>
<span class="linenos"> 99</span><span class="w">                  </span><span class="nt">required</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="linenos">100</span><span class="w">                  </span><span class="nt">schema</span><span class="p">:</span>
</pre></div>
</div>
</div>
</section>
<section id="ssmactivationapi">
<h4>SSMActivationApi<a class="headerlink" href="#ssmactivationapi" title="Permalink to this headline"></a></h4>
<p>This section defines the API Gateway. The API Gateway is used to expose the Lambda function as a REST API endpoint. The API Gateway is configured to use the API Gateway Secret Key to secure the API Gateway endpoint.</p>
<dl class="simple">
<dt>Methods:</dt><dd><ul class="simple">
<li><p>/ssmactivation</p></li>
<li><p>/addtags</p></li>
</ul>
</dd>
</dl>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">template.yaml - SSMActivationApi</span><a class="headerlink" href="#id6" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">          </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos"> 2</span><span class="w">            </span><span class="nt">Path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/presignedurl</span>
<span class="linenos"> 3</span><span class="w">            </span><span class="nt">Method</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">post</span>
<span class="linenos"> 4</span><span class="w">            </span><span class="nt">RestApiId</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ApiGatewayS3Verify</span>
<span class="linenos"> 5</span><span class="w"> </span><span class="w w-Error"> </span><span class="nt">GeneratedPresignedURLRole</span><span class="p">:</span>
<span class="linenos"> 6</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::IAM::Role</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos"> 8</span><span class="w">      </span><span class="nt">Tags</span><span class="p">:</span>
<span class="linenos"> 9</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Project</span>
<span class="linenos">10</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::StackName</span>
<span class="linenos">11</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Environment</span>
<span class="linenos">12</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prod</span>
<span class="linenos">13</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Owner</span>
<span class="linenos">14</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mondanthody.firos@primefocus.com</span>
<span class="linenos">15</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">map-migrated</span>
<span class="linenos">16</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">d-server-00c79yzv8q8cvz</span>
<span class="linenos">17</span><span class="w">      </span><span class="nt">AssumeRolePolicyDocument</span><span class="p">:</span>
<span class="linenos">18</span><span class="w">        </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos">19</span><span class="w">        </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">20</span><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">21</span><span class="w">            </span><span class="nt">Principal</span><span class="p">:</span>
<span class="linenos">22</span><span class="w">              </span><span class="nt">Service</span><span class="p">:</span>
<span class="linenos">23</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lambda.amazonaws.com</span>
<span class="linenos">24</span><span class="w">            </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">25</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sts:AssumeRole</span>
<span class="linenos">26</span><span class="w">      </span><span class="nt">Policies</span><span class="p">:</span>
<span class="linenos">27</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GeneratedPresignedURLPolicy</span>
<span class="linenos">28</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos">29</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos">30</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
</pre></div>
</div>
</div>
</section>
<section id="ssminstallscriptgeneratorapi">
<h4>SSMInstallScriptGeneratorApi<a class="headerlink" href="#ssminstallscriptgeneratorapi" title="Permalink to this headline"></a></h4>
<p>This section defines the API Gateway. The API Gateway is used to expose the Lambda function as a REST API endpoint.</p>
<dl class="simple">
<dt>Methods:</dt><dd><ul class="simple">
<li><p>/ssminstallscriptgenerator</p></li>
</ul>
</dd>
</dl>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">template.yaml - SSMInstallScriptGeneratorApi</span><a class="headerlink" href="#id7" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:CreateLogGroup</span>
<span class="linenos"> 2</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:CreateLogStream</span>
<span class="linenos"> 3</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:PutLogEvents</span>
<span class="linenos"> 4</span><span class="w">               </span><span class="w w-Error"> </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;*&#39;</span>
<span class="linenos"> 5</span><span class="w">             </span><span class="w w-Error"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos"> 6</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos"> 7</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xray:PutTraceSegments</span>
<span class="linenos"> 8</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xray:PutTelemetryRecords</span>
<span class="linenos"> 9</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;*&#39;</span>
<span class="linenos">10</span><span class="w"> </span><span class="w w-Error"> </span><span class="nt">ValidateTransfer</span><span class="p">:</span>
<span class="linenos">11</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Serverless::Function</span>
<span class="linenos">12</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">13</span><span class="w">      </span><span class="nt">Runtime</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python3.8</span>
<span class="linenos">14</span><span class="w">      </span><span class="nt">CodeUri</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./functions/ValidateTransfer/</span>
<span class="linenos">15</span><span class="w">      </span><span class="nt">Handler</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">index.lambda_handler</span>
<span class="linenos">16</span><span class="w">      </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">This function will validate the transfer of the files from the source to the destination</span>
<span class="linenos">17</span><span class="w">      </span><span class="nt">Role</span><span class="p">:</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ValidateTransferRole.Arn</span>
<span class="linenos">18</span><span class="w">      </span><span class="nt">Layers</span><span class="p">:</span>
<span class="linenos">19</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:lambda:${AWS::Region}:017000801446:layer:AWSLambdaPowertoolsPythonV2:19</span>
<span class="linenos">20</span><span class="w">      </span><span class="nt">Environment</span><span class="p">:</span>
</pre></div>
</div>
</div>
</section>
<section id="statemachineapi">
<h4>StateMachineApi<a class="headerlink" href="#statemachineapi" title="Permalink to this headline"></a></h4>
<p>This section defines the API Gateway. The API Gateway is used to expose the Lambda function as a REST API endpoint. This is optional, depends on deployment of step function.</p>
<dl class="simple">
<dt>Methods:</dt><dd><ul class="simple">
<li><p>/run</p></li>
<li><p>/query</p></li>
</ul>
</dd>
</dl>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">template.yaml - StateMachineApi</span><a class="headerlink" href="#id8" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">String</span>
<span class="linenos"> 2</span><span class="w">            </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Server IP</span>
<span class="linenos"> 3</span><span class="w">            </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mi-08c5025fa198fe218</span>
<span class="linenos"> 4</span><span class="w">         </span><span class="w w-Error"> </span><span class="nt">GenerateHash</span><span class="p">:</span>
<span class="linenos"> 5</span><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">String</span>
<span class="linenos"> 6</span><span class="w">            </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Code</span>
<span class="linenos"> 7</span><span class="w">            </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1234&quot;</span>
<span class="linenos"> 8</span><span class="w">          </span><span class="nt">APIURL</span><span class="p">:</span>
<span class="linenos"> 9</span><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">String</span>
<span class="linenos">10</span><span class="w">            </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">API URL</span>
<span class="linenos">11</span><span class="w">            </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://api.expedat.com/api/v1/ServerHash&quot;</span>
<span class="linenos">12</span><span class="w">          </span><span class="nt">Date</span><span class="p">:</span>
<span class="linenos">13</span><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">String</span>
<span class="linenos">14</span><span class="w">            </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Date</span>
<span class="linenos">15</span><span class="w">            </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2021-09-01&quot;</span>
<span class="linenos">16</span><span class="w">       </span><span class="w w-Error"> </span><span class="nt">mainSteps</span><span class="p">:</span>
<span class="linenos">17</span><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GenerateServerHash</span>
<span class="linenos">18</span><span class="w">            </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws:runShellScript</span>
<span class="linenos">19</span><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span>
<span class="linenos">20</span><span class="w">              </span><span class="nt">runCommand</span><span class="p">:</span>
<span class="linenos">21</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;#!/bin/sh&quot;</span>
<span class="linenos">22</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;set</span><span class="nv"> </span><span class="s">-e&quot;</span>
<span class="linenos">23</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;date=&quot;$(date</span><span class="nv"> </span><span class="s">+%Y%m%d-%H%M%S)&quot;&#39;</span>
<span class="linenos">24</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;export</span><span class="nv"> </span><span class="s">GenerateHash=&quot;{{GenerateHash}}&quot;&#39;</span>
<span class="linenos">25</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;if</span><span class="nv"> </span><span class="s">python3</span><span class="nv"> </span><span class="s">-c</span><span class="nv"> </span><span class="s">\&quot;$(echo</span><span class="nv"> </span><span class="s">$GenerateHash</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">base64</span><span class="nv"> </span><span class="s">-d)\&quot;</span><span class="nv"> </span><span class="s">{{SourcePath}}</span><span class="nv"> </span><span class="s">{{SourcePath}}</span><span class="nv"> </span><span class="s">Server</span><span class="nv"> </span><span class="s">{{APIURL}}</span><span class="nv"> </span><span class="s">{{Date}};</span><span class="nv"> </span><span class="s">then&quot;</span>
<span class="linenos">26</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;</span><span class="nv">  </span><span class="s">echo</span><span class="nv"> </span><span class="s">&quot;Server</span><span class="nv"> </span><span class="s">hash</span><span class="nv"> </span><span class="s">generated</span><span class="nv"> </span><span class="s">successfully&quot;&#39;</span>
<span class="linenos">27</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;else&#39;</span>
<span class="linenos">28</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;</span><span class="nv">  </span><span class="s">echo</span><span class="nv"> </span><span class="s">&quot;Server</span><span class="nv"> </span><span class="s">hash</span><span class="nv"> </span><span class="s">generation</span><span class="nv"> </span><span class="s">failed&quot;&#39;</span>
<span class="linenos">29</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;</span><span class="nv">  </span><span class="s">exit</span><span class="nv"> </span><span class="s">1&#39;</span>
<span class="linenos">30</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;fi&#39;</span>
<span class="linenos">31</span>
<span class="linenos">32</span>
<span class="linenos">33</span><span class="w">              </span>
<span class="linenos">34</span><span class="w">     </span><span class="w w-Error"> </span><span class="nt">DocumentType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Command</span>
<span class="linenos">35</span><span class="w">      </span><span class="nt">DocumentFormat</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">YAML</span>
<span class="linenos">36</span>
<span class="linenos">37</span>
<span class="linenos">38</span><span class="w"> </span><span class="w w-Error"> </span><span class="nt">ExpeDatUserParameterName</span><span class="p">:</span>
<span class="linenos">39</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::SSM::Parameter</span>
<span class="linenos">40</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">41</span><span class="w">      </span><span class="nt">Tags</span><span class="p">:</span>
<span class="linenos">42</span><span class="w">        </span><span class="nt">Project</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::StackName</span>
<span class="linenos">43</span><span class="w">        </span><span class="nt">Environment</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prod</span>
<span class="linenos">44</span><span class="w">        </span><span class="nt">Owner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mondanthody.firos@primefocus.com</span>
<span class="linenos">45</span><span class="w">        </span><span class="nt">Usage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Username</span>
<span class="linenos">46</span><span class="w">        </span><span class="nt">map-migrated</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">d-server-00c79yzv8q8cvz</span>
<span class="linenos">47</span><span class="w">      </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/${AWS::StackName}/expedat/username</span>
<span class="linenos">48</span><span class="w">      </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">String</span>
<span class="linenos">49</span><span class="w">      </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ExpedatUser</span>
<span class="linenos">50</span><span class="w">      </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Expedat User</span>
<span class="linenos">51</span><span class="w">      </span><span class="nt">Tier</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Standard</span>
<span class="linenos">52</span><span class="w">  </span><span class="nt">ExpeDatPassParameterName</span><span class="p">:</span>
<span class="linenos">53</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::SSM::Parameter</span>
<span class="linenos">54</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">55</span><span class="w">      </span><span class="nt">Tags</span><span class="p">:</span>
<span class="linenos">56</span><span class="w">        </span><span class="nt">Project</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::StackName</span>
<span class="linenos">57</span><span class="w">        </span><span class="nt">Environment</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prod</span>
<span class="linenos">58</span><span class="w">        </span><span class="nt">Owner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mondanthody.firos@primefocus.com</span>
<span class="linenos">59</span><span class="w">        </span><span class="nt">Usage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Password</span>
<span class="linenos">60</span><span class="w">        </span><span class="nt">map-migrated</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">d-server-00c79yzv8q8cvz</span>
<span class="linenos">61</span><span class="w">      </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/${AWS::StackName}/expedat/password</span>
<span class="linenos">62</span><span class="w">      </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">String</span>
<span class="linenos">63</span><span class="w">      </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ExpedatPass</span>
<span class="linenos">64</span><span class="w">      </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Expedat Password</span>
<span class="linenos">65</span><span class="w">      </span><span class="nt">Tier</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Standard</span>
<span class="linenos">66</span><span class="w">  </span><span class="nt">ExpeDatServerParameterName</span><span class="p">:</span>
<span class="linenos">67</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::SSM::Parameter</span>
<span class="linenos">68</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">69</span><span class="w">      </span><span class="nt">Tags</span><span class="p">:</span>
<span class="linenos">70</span><span class="w">        </span><span class="nt">Project</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::StackName</span>
<span class="linenos">71</span><span class="w">        </span><span class="nt">Environment</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prod</span>
<span class="linenos">72</span><span class="w">        </span><span class="nt">Owner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mondanthody.firos@primefocus.com</span>
<span class="linenos">73</span><span class="w">        </span><span class="nt">Usage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Server</span>
<span class="linenos">74</span><span class="w">        </span><span class="nt">map-migrated</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">d-server-00c79yzv8q8cvz</span>
<span class="linenos">75</span><span class="w">      </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/${AWS::StackName}/expedat/server</span>
<span class="linenos">76</span><span class="w">      </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">String</span>
<span class="linenos">77</span><span class="w">      </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ExpedatServer</span>
<span class="linenos">78</span><span class="w">      </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Expedat Server</span>
<span class="linenos">79</span><span class="w">      </span><span class="nt">Tier</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Standard</span>
<span class="linenos">80</span><span class="w">  </span><span class="nt">ExpeDatPortParameterName</span><span class="p">:</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="lambda-functions">
<h3>Lambda Functions<a class="headerlink" href="#lambda-functions" title="Permalink to this headline"></a></h3>
<p>This section defines the Lambda function. The Lambda function is used to run the SSM Run document and query the SSM Run document status. Act as Custom Authorizer for API Gateway. Dashboard Function to get the status of the SSM Run document. SSM Agent Activation Function to activate the SSM Agent on the managed instance. SSM Install Script Generator Function to generate the SSM Install Script.</p>
<section id="custom-authorizer">
<h4>Custom Authorizer<a class="headerlink" href="#custom-authorizer" title="Permalink to this headline"></a></h4>
<p>This section defines the Custom Authorizer. The Custom Authorizer is used to validate the API Gateway Secret Key. The Custom Authorizer is configured to use the API Gateway Secret Key to validate the request.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><em>CodeUri</em> below is set to a location of CustomAuthorizer, see <a class="reference internal" href="CustomAuthorizer.html"><span class="doc">CustomAuthorizer Documentation</span></a> for more information.</p>
</div>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text">template.yaml - Custom Authorizer</span><a class="headerlink" href="#id9" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">        </span><span class="nt">GenerateStringKey</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rand</span>
<span class="linenos"> 2</span><span class="w">        </span><span class="nt">PasswordLength</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">40</span>
<span class="linenos"> 3</span><span class="w">        </span><span class="nt">ExcludeCharacters</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;&quot;@/\%:{}$!)-_.([]&lt;&gt;?|`~;#^&amp;*+=,&#39;</span>
<span class="linenos"> 4</span><span class="w">        </span><span class="nt">IncludeSpace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="linenos"> 5</span><span class="w">        </span><span class="nt">RequireEachIncludedType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="linenos"> 6</span><span class="w">   </span><span class="w w-Error"> </span><span class="nt">UpdateReplacePolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Retain</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="nt">DeletionPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Retain</span>
<span class="linenos"> 8</span><span class="w"> </span><span class="w w-Error"> </span><span class="nt">CustomAuthorizer</span><span class="p">:</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Serverless::Function</span>
<span class="linenos">10</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">11</span><span class="w">      </span><span class="nt">Runtime</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python3.8</span>
<span class="linenos">12</span><span class="w">      </span><span class="nt">CodeUri</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./functions/CustomAuthorizer/</span>
<span class="linenos">13</span><span class="w">      </span><span class="nt">Handler</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">index.lambda_handler</span>
</pre></div>
</div>
</div>
</section>
<section id="expedatssmrundocumet">
<h4>ExpeDatSSMRunDocumet<a class="headerlink" href="#expedatssmrundocumet" title="Permalink to this headline"></a></h4>
<p>This section defines the Lambda function that runs the SSM Run document. The Lambda function is configured to use the API Gateway Secret Key to validate the request.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><em>CodeUri</em> below is set to a location of ExpeDatSSMRunDocumet, see <a class="reference internal" href="ExpeDatSSMRunDocumet.html"><span class="doc">ExpeDatSSMRunDocumet Documentation</span></a> for more information.</p>
</div>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-text">template.yaml - ExpeDatSSMRunDocumet</span><a class="headerlink" href="#id10" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">                    </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#/definitions/CancelRequestModel&#39;</span>
<span class="linenos"> 2</span><span class="w">             </span><span class="w w-Error"> </span><span class="nt">x-amazon-apigateway-integration</span><span class="p">:</span>
<span class="linenos"> 3</span><span class="w">                </span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ExpeDatCancelRunDocument.Arn}/invocations</span>
<span class="linenos"> 4</span><span class="w">                </span><span class="nt">passthroughBehavior</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">when_no_match</span>
<span class="linenos"> 5</span><span class="w">                </span><span class="nt">httpMethod</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POST</span>
<span class="linenos"> 6</span><span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws_proxy</span>
<span class="linenos"> 7</span><span class="w">              </span><span class="nt">responses</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="linenos"> 8</span><span class="w">              </span><span class="nt">security</span><span class="p">:</span>
<span class="linenos"> 9</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">CustomAuthorizer</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="linenos">10</span><span class="w">       </span><span class="w w-Error"> </span><span class="nt">securityDefinitions</span><span class="p">:</span>
<span class="linenos">11</span><span class="w">          </span><span class="nt">CustomAuthorizer</span><span class="p">:</span>
<span class="linenos">12</span><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apiKey</span>
<span class="linenos">13</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">x-api-key</span>
<span class="linenos">14</span><span class="w">            </span><span class="nt">in</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">header</span>
<span class="linenos">15</span><span class="w">        </span><span class="nt">definitions</span><span class="p">:</span>
<span class="linenos">16</span><span class="w">          </span><span class="nt">QueryRequestModel</span><span class="p">:</span>
<span class="linenos">17</span><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
<span class="linenos">18</span><span class="w">            </span><span class="nt">properties</span><span class="p">:</span>
<span class="linenos">19</span><span class="w">              </span><span class="nt">ClientId</span><span class="p">:</span>
<span class="linenos">20</span><span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<span class="linenos">21</span><span class="w">              </span><span class="nt">JobId</span><span class="p">:</span>
<span class="linenos">22</span><span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<span class="linenos">23</span><span class="w">            </span><span class="nt">required</span><span class="p">:</span>
<span class="linenos">24</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClientId</span>
<span class="linenos">25</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">JobId</span>
<span class="linenos">26</span><span class="w">          </span><span class="nt">RunRequestModel</span><span class="p">:</span>
<span class="linenos">27</span><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
<span class="linenos">28</span><span class="w">            </span><span class="nt">properties</span><span class="p">:</span>
<span class="linenos">29</span><span class="w">              </span><span class="nt">ClientId</span><span class="p">:</span>
</pre></div>
</div>
</div>
</section>
<section id="expedatssminvocationquery">
<h4>ExpeDatSSMInvocationQuery<a class="headerlink" href="#expedatssminvocationquery" title="Permalink to this headline"></a></h4>
<p>This section defines the Lambda function that queries the SSM Run document status. The Lambda function is configured to use the API Gateway Secret Key to validate the request.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><em>CodeUri</em> below is set to a location of ExpeDatSSMInvocationQuery, see <a class="reference internal" href="ExpeDatSSMInvocationQuery.html"><span class="doc">ExpeDatSSMInvocationQuery Documentation</span></a> for more information.</p>
</div>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text">template.yaml - ExpeDatSSMInvocationQuery</span><a class="headerlink" href="#id11" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<span class="linenos"> 2</span><span class="w">             </span><span class="w w-Error"> </span><span class="nt">SourcePath</span><span class="p">:</span>
<span class="linenos"> 3</span><span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<span class="linenos"> 4</span><span class="w">              </span><span class="nt">DestinationPath</span><span class="p">:</span>
<span class="linenos"> 5</span><span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<span class="linenos"> 6</span><span class="w">           </span><span class="w w-Error"> </span><span class="nt">required</span><span class="p">:</span>
<span class="linenos"> 7</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClientId</span>
<span class="linenos"> 8</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SourcePath</span>
<span class="linenos"> 9</span><span class="w">         </span><span class="w w-Error"> </span><span class="nt">CancelRequestModel</span><span class="p">:</span>
<span class="linenos">10</span><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
<span class="linenos">11</span><span class="w">            </span><span class="nt">properties</span><span class="p">:</span>
<span class="linenos">12</span><span class="w">              </span><span class="nt">ClientId</span><span class="p">:</span>
<span class="linenos">13</span><span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<span class="linenos">14</span><span class="w">              </span><span class="nt">JobId</span><span class="p">:</span>
<span class="linenos">15</span><span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<span class="linenos">16</span><span class="w">            </span><span class="nt">required</span><span class="p">:</span>
<span class="linenos">17</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClientId</span>
<span class="linenos">18</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">JobId</span>
<span class="linenos">19</span><span class="w"> </span><span class="w w-Error"> </span><span class="nt">ExpeDatSSMRunDocumet</span><span class="p">:</span>
<span class="linenos">20</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Serverless::Function</span>
<span class="linenos">21</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">22</span><span class="w">      </span><span class="nt">Runtime</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python3.8</span>
<span class="linenos">23</span><span class="w">      </span><span class="nt">CodeUri</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./functions/ExpeDatSSMRunDocumet/</span>
<span class="linenos">24</span><span class="w">      </span><span class="nt">Handler</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">index.lambda_handler</span>
<span class="linenos">25</span><span class="w">      </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">This function will run a SSM Document on Client machines to copy files from a source to a destination using Expedat</span>
</pre></div>
</div>
</div>
</section>
<section id="ssmagentactivation">
<h4>SSMAgentActivation<a class="headerlink" href="#ssmagentactivation" title="Permalink to this headline"></a></h4>
<p>This section defines the Lambda function that activates the SSM Agent on the managed instance. The Lambda function is configured to use the API Gateway Secret Key to validate the request.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><em>CodeUri</em> below is set to a location of SSMAgentActivation, see <a class="reference internal" href="SSMAgentActivation.html"><span class="doc">SSMAgentActivation Documentation</span></a> for more information.</p>
</div>
<div class="literal-block-wrapper docutils container" id="id12">
<div class="code-block-caption"><span class="caption-text">template.yaml - SSMAgentActivation</span><a class="headerlink" href="#id12" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">      </span><span class="nt">Role</span><span class="p">:</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ExpeDatSSMRunDocumetRole.Arn</span>
<span class="linenos"> 2</span><span class="w">      </span><span class="nt">Layers</span><span class="p">:</span>
<span class="linenos"> 3</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:lambda:${AWS::Region}:017000801446:layer:AWSLambdaPowertoolsPythonV2:19</span>
<span class="linenos"> 4</span><span class="w">      </span><span class="nt">Environment</span><span class="p">:</span>
<span class="linenos"> 5</span><span class="w">        </span><span class="nt">Variables</span><span class="p">:</span>
<span class="linenos"> 6</span><span class="w">          </span><span class="nt">DYNAMODB_TABLE</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DynamoDBTableTheater</span>
<span class="linenos"> 7</span><span class="w">          </span><span class="nt">SSM_DOCUMENT_NAME</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SSMDocument</span>
<span class="linenos"> 8</span><span class="w">          </span><span class="nt">SNS_TOPIC</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SNSNotificationTopic</span>
<span class="linenos"> 9</span><span class="w">          </span><span class="nt">POWERTOOLS_SERVICE_NAME</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ExpeDatSSMRunDocumet</span>
<span class="linenos">10</span><span class="w">          </span><span class="nt">POWERTOOLS_METRICS_NAMESPACE</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ExpeDatSSMRunDocumet</span>
<span class="linenos">11</span><span class="w">          </span><span class="nt">LOG_LEVEL</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">INFO</span>
<span class="linenos">12</span><span class="w">          </span><span class="nt">DEFAULT_PATH</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/DCinema/downloads/</span>
<span class="linenos">13</span><span class="w">          </span><span class="nt">SSM_SERVICE_ROLE_ARN</span><span class="p">:</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SSMSNSPublishRole.Arn</span>
<span class="linenos">14</span><span class="w">          </span><span class="nt">HASH_DOCUMENT</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ServerHashGenerator</span>
<span class="linenos">15</span><span class="w">          </span><span class="nt">SERVER_ID</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ExpedatServerId</span>
<span class="linenos">16</span><span class="w">          </span><span class="nt">S3_BUCKET</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mum-pr-dcinema-deployments-s3</span>
<span class="linenos">17</span><span class="w">          </span><span class="nt">API_GATEWAY_ENDPOINT</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://${ApiGatewayS3Verify}.execute-api.${AWS::Region}.amazonaws.com/Prod</span>
<span class="linenos">18</span><span class="w">      </span><span class="nt">Events</span><span class="p">:</span>
<span class="linenos">19</span><span class="w">        </span><span class="nt">ApiGatewayEndpoint</span><span class="p">:</span>
<span class="linenos">20</span><span class="w">          </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Api</span>
<span class="linenos">21</span><span class="w">          </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">22</span><span class="w">            </span><span class="nt">Path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/run</span>
<span class="linenos">23</span><span class="w">            </span><span class="nt">Method</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">post</span>
<span class="linenos">24</span><span class="w">            </span><span class="nt">RestApiId</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ApiGatewayEndpoint</span>
<span class="linenos">25</span><span class="w">            </span><span class="nt">Auth</span><span class="p">:</span>
<span class="linenos">26</span><span class="w">              </span><span class="nt">Authorizer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CustomAuthorizer</span>
<span class="linenos">27</span><span class="w"> </span><span class="w w-Error"> </span><span class="nt">ExpeDatCancelRunDocument</span><span class="p">:</span>
<span class="linenos">28</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Serverless::Function</span>
<span class="linenos">29</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">30</span><span class="w">      </span><span class="nt">Runtime</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python3.8</span>
<span class="linenos">31</span><span class="w">      </span><span class="nt">CodeUri</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./functions/ExpeDatCancelRunDocument/</span>
<span class="linenos">32</span><span class="w">      </span><span class="nt">Handler</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">index.lambda_handler</span>
<span class="linenos">33</span><span class="w">      </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">This function will cancel a SSM Document on Client machines</span>
</pre></div>
</div>
</div>
</section>
<section id="ssmnotification">
<h4>SSMNotification<a class="headerlink" href="#ssmnotification" title="Permalink to this headline"></a></h4>
<p>This section defines the Lambda function that sends the SSM Run document status notification using SES. The Lambda function is configured to use the API Gateway Secret Key to validate the request.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><em>CodeUri</em> below is set to a location of SSMNotification, see <a class="reference internal" href="SSMNotification.html"><span class="doc">SSMNotification Documentation</span></a> for more information.</p>
</div>
<div class="literal-block-wrapper docutils container" id="id13">
<div class="code-block-caption"><span class="caption-text">template.yaml - SSMNotification</span><a class="headerlink" href="#id13" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">      </span><span class="nt">Role</span><span class="p">:</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ExpeDatCancelRunDocumentRole.Arn</span>
<span class="linenos"> 2</span><span class="w">      </span><span class="nt">Layers</span><span class="p">:</span>
<span class="linenos"> 3</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:lambda:${AWS::Region}:017000801446:layer:AWSLambdaPowertoolsPythonV2:19</span>
<span class="linenos"> 4</span><span class="w">      </span><span class="nt">Environment</span><span class="p">:</span>
<span class="linenos"> 5</span><span class="w">        </span><span class="nt">Variables</span><span class="p">:</span>
<span class="linenos"> 6</span><span class="w">          </span><span class="nt">DYNAMODB_TABLE</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DynamoDBTableTheater</span>
<span class="linenos"> 7</span><span class="w">          </span><span class="nt">POWERTOOLS_SERVICE_NAME</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ExpeDatCancelRunDocument</span>
<span class="linenos"> 8</span><span class="w">          </span><span class="nt">POWERTOOLS_METRICS_NAMESPACE</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ExpeDatCancelRunDocument</span>
<span class="linenos"> 9</span><span class="w">          </span><span class="nt">LOG_LEVEL</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">INFO</span>
<span class="linenos">10</span><span class="w">         </span>
<span class="linenos">11</span><span class="w">      </span><span class="nt">Events</span><span class="p">:</span>
<span class="linenos">12</span><span class="w">        </span><span class="nt">ApiGatewayEndpoint</span><span class="p">:</span>
<span class="linenos">13</span><span class="w">          </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Api</span>
<span class="linenos">14</span><span class="w">          </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">15</span><span class="w">            </span><span class="nt">Path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/cancel</span>
<span class="linenos">16</span><span class="w">            </span><span class="nt">Method</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">post</span>
<span class="linenos">17</span><span class="w">            </span><span class="nt">RestApiId</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ApiGatewayEndpoint</span>
<span class="linenos">18</span><span class="w">            </span><span class="nt">Auth</span><span class="p">:</span>
<span class="linenos">19</span><span class="w">              </span><span class="nt">Authorizer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CustomAuthorizer</span>
<span class="linenos">20</span><span class="w"> </span><span class="w w-Error"> </span><span class="nt">ExpeDatCancelRunDocumentRole</span><span class="p">:</span>
<span class="linenos">21</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::IAM::Role</span>
<span class="linenos">22</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">23</span><span class="w">      </span><span class="nt">RoleName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-ExpeDatCancelRunDocumentRole</span>
<span class="linenos">24</span><span class="w">      </span><span class="nt">Tags</span><span class="p">:</span>
<span class="linenos">25</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Project</span>
<span class="linenos">26</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::StackName</span>
</pre></div>
</div>
</div>
</section>
<section id="ssminstallscriptgenerator">
<h4>SSMInstallScriptGenerator<a class="headerlink" href="#ssminstallscriptgenerator" title="Permalink to this headline"></a></h4>
<p>This section defines the Lambda function that generates the SSM Install Script. This is a public API without any authentication.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><em>CodeUri</em> below is set to a location of SSMInstallScriptGenerator, see <a class="reference internal" href="SSMInstallScriptGenerator.html"><span class="doc">SSMInstallScriptGenerator Documentation</span></a> for more information.</p>
</div>
<div class="literal-block-wrapper docutils container" id="id14">
<div class="code-block-caption"><span class="caption-text">template.yaml - SSMInstallScriptGenerator</span><a class="headerlink" href="#id14" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos"> 2</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos"> 3</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3:PutObject</span>
<span class="linenos"> 4</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3:PutObjectAcl</span>
<span class="linenos"> 5</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3:PutObjectTagging</span>
<span class="linenos"> 6</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3:PutObjectVersionAcl</span>
<span class="linenos"> 7</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3:PutObjectVersionTagging</span>
<span class="linenos"> 8</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:s3:::mum-pr-dcinema-deployments-s3/*</span>
<span class="linenos"> 9</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">10</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">11</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3:ListBucket</span>
<span class="linenos">12</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:s3:::mum-pr-dcinema-deployments-s3</span>
<span class="linenos">13</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">14</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">15</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3:GetObject</span>
<span class="linenos">16</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3:GetObjectAcl</span>
<span class="linenos">17</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3:GetObjectTagging</span>
<span class="linenos">18</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3:GetObjectVersion</span>
<span class="linenos">19</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3:GetObjectVersionAcl</span>
<span class="linenos">20</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3:GetObjectVersionTagging</span>
<span class="linenos">21</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:s3:::mum-pr-dcinema-deployments-s3/*</span>
<span class="linenos">22</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">23</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">24</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloudwatch:PutMetricData</span>
</pre></div>
</div>
</div>
</section>
<section id="dashboardfunction">
<h4>DashboardFunction<a class="headerlink" href="#dashboardfunction" title="Permalink to this headline"></a></h4>
<p>This section defines the Lambda function that gets the status of the SSM Run document, cost and usage to be used by Cloudwatch Dashboard.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><em>CodeUri</em> below is set to a location of DashboardFunction, see <a class="reference internal" href="DashboardFunction.html"><span class="doc">DashboardFunction Documentation</span></a> for more information.</p>
</div>
<div class="literal-block-wrapper docutils container" id="id15">
<div class="code-block-caption"><span class="caption-text">template.yaml - DashboardFunction</span><a class="headerlink" href="#id15" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Project</span>
<span class="linenos"> 2</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::StackName</span>
<span class="linenos"> 3</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Environment</span>
<span class="linenos"> 4</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prod</span>
<span class="linenos"> 5</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Owner</span>
<span class="linenos"> 6</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mondanthody.firos@primefocus.com</span>
<span class="linenos"> 7</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">map-migrated</span>
<span class="linenos"> 8</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">d-server-00c79yzv8q8cvz</span>
<span class="linenos"> 9</span><span class="w">     </span><span class="w w-Error"> </span><span class="nt">AssumeRolePolicyDocument</span><span class="p">:</span>
<span class="linenos">10</span><span class="w">        </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos">11</span><span class="w">        </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">12</span><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="sns-topic">
<h3>SNS Topic<a class="headerlink" href="#sns-topic" title="Permalink to this headline"></a></h3>
<section id="snsnotificationtopic">
<h4>SNSNotificationTopic<a class="headerlink" href="#snsnotificationtopic" title="Permalink to this headline"></a></h4>
<p>This section defines the SNS Topic. The SNS Topic is used to send the SSM Run document status notification.</p>
<div class="literal-block-wrapper docutils container" id="id16">
<div class="code-block-caption"><span class="caption-text">template.yaml - SNSNotificationTopic</span><a class="headerlink" href="#id16" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">          </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos"> 2</span><span class="w">            </span><span class="nt">Path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/ssminstallscriptgenerator</span>
<span class="linenos"> 3</span><span class="w">            </span><span class="nt">Method</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">get</span>
<span class="linenos"> 4</span><span class="w">            </span><span class="nt">RestApiId</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SSMInstallScriptGeneratorApi</span>
<span class="linenos"> 5</span><span class="w"> </span><span class="w w-Error"> </span><span class="nt">SSMInstallScriptGeneratorApi</span><span class="p">:</span>
<span class="linenos"> 6</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Serverless::Api</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos"> 8</span><span class="w">      </span><span class="nt">StageName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prod</span>
<span class="linenos"> 9</span><span class="w">      </span><span class="nt">DefinitionBody</span><span class="p">:</span>
<span class="linenos">10</span><span class="w">        </span><span class="nt">swagger</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2.0&#39;</span>
<span class="linenos">11</span><span class="w">        </span><span class="nt">info</span><span class="p">:</span>
<span class="linenos">12</span><span class="w">          </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2018-11-29T18:24:29Z&#39;</span>
<span class="linenos">13</span><span class="w">          </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-SSMInstallScriptGenerator</span>
<span class="linenos">14</span><span class="w">        </span><span class="nt">paths</span><span class="p">:</span>
<span class="linenos">15</span><span class="w">          </span><span class="nt">/ssminstallscriptgenerator</span><span class="p">:</span>
<span class="linenos">16</span><span class="w">            </span><span class="nt">get</span><span class="p">:</span>
<span class="linenos">17</span><span class="w">              </span><span class="nt">x-amazon-apigateway-integration</span><span class="p">:</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="ssm-document">
<h3>SSM Document<a class="headerlink" href="#ssm-document" title="Permalink to this headline"></a></h3>
<section id="ssmdocument">
<h4>SSMDocument<a class="headerlink" href="#ssmdocument" title="Permalink to this headline"></a></h4>
<p>This section defines the SSM Document. The SSM Document is used to run the SSM Run document.</p>
<div class="literal-block-wrapper docutils container" id="id17">
<div class="code-block-caption"><span class="caption-text">template.yaml - SSMDocument</span><a class="headerlink" href="#id17" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos"> 2</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2012-10-17</span>
<span class="linenos"> 3</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos"> 4</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos"> 5</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos"> 6</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:CreateLogGroup</span>
<span class="linenos"> 7</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:CreateLogStream</span>
<span class="linenos"> 8</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:PutLogEvents</span>
<span class="linenos"> 9</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;*&#39;</span>
<span class="linenos">10</span><span class="w"> </span><span class="w w-Error"> </span><span class="nt">CommonLambdaLayer</span><span class="p">:</span>
<span class="linenos">11</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Serverless::LayerVersion</span>
<span class="linenos">12</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">13</span><span class="w">      </span><span class="nt">CompatibleRuntimes</span><span class="p">:</span>
<span class="linenos">14</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python3.8</span>
<span class="linenos">15</span><span class="w">      </span><span class="nt">ContentUri</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./lambdaLayer</span>
<span class="linenos">16</span><span class="w">      </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SSM Layer with Jinja2 package</span>
<span class="linenos">17</span><span class="w">      </span><span class="nt">LicenseInfo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MIT</span>
<span class="linenos">18</span><span class="w">      </span><span class="nt">RetentionPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Retain</span>
<span class="linenos">19</span><span class="w">      </span><span class="nt">LayerName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-CommonLambdaLayer</span>
<span class="linenos">20</span><span class="w">    </span><span class="nt">Metadata</span><span class="p">:</span>
<span class="linenos">21</span><span class="w">      </span><span class="nt">BuildMethod</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python3.8</span>
<span class="linenos">22</span><span class="w">  </span><span class="nt">ExpeDatSSMRunDocumetRole</span><span class="p">:</span>
<span class="linenos">23</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::IAM::Role</span>
<span class="linenos">24</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">25</span><span class="w">      </span><span class="nt">Tags</span><span class="p">:</span>
<span class="linenos">26</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Project</span>
<span class="linenos">27</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::StackName</span>
<span class="linenos">28</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Environment</span>
<span class="linenos">29</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prod</span>
<span class="linenos">30</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Owner</span>
<span class="linenos">31</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mondanthody.firos@primefocus.com</span>
<span class="linenos">32</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">map-migrated</span>
<span class="linenos">33</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">d-server-00c79yzv8q8cvz</span>
<span class="linenos">34</span><span class="w">      </span><span class="nt">AssumeRolePolicyDocument</span><span class="p">:</span>
<span class="linenos">35</span><span class="w">        </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos">36</span><span class="w">        </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">37</span><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">38</span><span class="w">            </span><span class="nt">Principal</span><span class="p">:</span>
<span class="linenos">39</span><span class="w">              </span><span class="nt">Service</span><span class="p">:</span>
<span class="linenos">40</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lambda.amazonaws.com</span>
<span class="linenos">41</span><span class="w">            </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">42</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sts:AssumeRole</span>
<span class="linenos">43</span><span class="w">      </span><span class="nt">Policies</span><span class="p">:</span>
<span class="linenos">44</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-DynamoDBPolicy</span>
<span class="linenos">45</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos">46</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos">47</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">48</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">49</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">50</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dynamodb:GetItem</span>
<span class="linenos">51</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dynamodb:Scan</span>
<span class="linenos">52</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dynamodb:Query</span>
<span class="linenos">53</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dynamodb:BatchGetItem</span>
<span class="linenos">54</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DynamoDBTableTheater.Arn</span>
<span class="linenos">55</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-SSMRunDocumentPolicy</span>
<span class="linenos">56</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos">57</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos">58</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">59</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="ssm-parameters-store">
<h3>SSM Parameters Store<a class="headerlink" href="#ssm-parameters-store" title="Permalink to this headline"></a></h3>
<section id="expedatuserparametername">
<h4>ExpeDatUserParameterName<a class="headerlink" href="#expedatuserparametername" title="Permalink to this headline"></a></h4>
<p>This section defines the SSM Parameter Store. The SSM Parameter Store is used to store the SSM Run document user parameter name.</p>
<div class="literal-block-wrapper docutils container" id="id18">
<div class="code-block-caption"><span class="caption-text">template.yaml - ExpeDatUserParameterName</span><a class="headerlink" href="#id18" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos"> 2</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:DescribeInstanceInformation</span>
<span class="linenos"> 3</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:SendCommand</span>
<span class="linenos"> 4</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:ListCommands</span>
<span class="linenos"> 5</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:ListCommandInvocations</span>
<span class="linenos"> 6</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:CancelCommand</span>
<span class="linenos"> 7</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:GetCommandInvocation</span>
<span class="linenos"> 8</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:GetConnectionStatus</span>
<span class="linenos"> 9</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;*&#39;</span>
<span class="linenos">10</span><span class="w">       </span><span class="w w-Error"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-CloudWatchLogsPolicy</span>
<span class="linenos">11</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos">12</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos">13</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">14</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
</pre></div>
</div>
</div>
</section>
<section id="expedatpassparametername">
<h4>ExpeDatPassParameterName<a class="headerlink" href="#expedatpassparametername" title="Permalink to this headline"></a></h4>
<p>This section defines the SSM Parameter Store. The SSM Parameter Store is used to store the SSM Run document password parameter name.</p>
<div class="literal-block-wrapper docutils container" id="id19">
<div class="code-block-caption"><span class="caption-text">template.yaml - ExpeDatPassParameterName</span><a class="headerlink" href="#id19" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos"> 2</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:CreateLogGroup</span>
<span class="linenos"> 3</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:CreateLogStream</span>
<span class="linenos"> 4</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:PutLogEvents</span>
<span class="linenos"> 5</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;*&#39;</span>
<span class="linenos"> 6</span><span class="w">       </span><span class="w w-Error"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-IAMPassRolePolicy</span>
<span class="linenos"> 7</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos"> 8</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos"> 9</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">10</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">11</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">12</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">iam:PassRole</span>
<span class="linenos">13</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SSMSNSPublishRole.Arn</span>
<span class="linenos">14</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-IAMPassRolePolicy2</span>
</pre></div>
</div>
</div>
</section>
<section id="expedatserverparametername">
<h4>ExpeDatServerParameterName<a class="headerlink" href="#expedatserverparametername" title="Permalink to this headline"></a></h4>
<p>This section defines the SSM Parameter Store. The SSM Parameter Store is used to store the SSM Run document server parameter name.</p>
<div class="literal-block-wrapper docutils container" id="id20">
<div class="code-block-caption"><span class="caption-text">template.yaml - ExpeDatServerParameterName</span><a class="headerlink" href="#id20" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos"> 2</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos"> 3</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos"> 4</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos"> 5</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos"> 6</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">iam:PassRole</span>
<span class="linenos"> 7</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SSMAgentRole.Arn</span>
<span class="linenos"> 8</span><span class="w">       </span><span class="w w-Error"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-XRayPolicy</span>
<span class="linenos"> 9</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos">10</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos">11</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">12</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">13</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">14</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xray:PutTraceSegments</span>
</pre></div>
</div>
</div>
</section>
<section id="ssmactivationparameter">
<h4>SSMActivationParameter<a class="headerlink" href="#ssmactivationparameter" title="Permalink to this headline"></a></h4>
<p>This section defines the SSM Parameter Store. The SSM Parameter Store is used to store the SSM Activation Code and ID.</p>
<div class="literal-block-wrapper docutils container" id="id21">
<div class="code-block-caption"><span class="caption-text">template.yaml - SSMActivationParameter</span><a class="headerlink" href="#id21" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xray:PutTelemetryRecords</span>
<span class="linenos"> 2</span><span class="w">               </span><span class="w w-Error"> </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;*&#39;</span>
<span class="linenos"> 3</span><span class="w">       </span><span class="w w-Error"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-S3PolicyGetHead</span>
<span class="linenos"> 4</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos"> 5</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos"> 6</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos"> 7</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos"> 8</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos"> 9</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3:ListBucket</span>
<span class="linenos">10</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:s3:::mum-pr-dcinema-deployments-s3</span>
<span class="linenos">11</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">12</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">13</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3:GetObject</span>
<span class="linenos">14</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3:GetObjectAcl</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="dynamodb-table">
<h3>DynamoDB Table<a class="headerlink" href="#dynamodb-table" title="Permalink to this headline"></a></h3>
<section id="dynamodbtabletheater">
<h4>DynamoDBTableTheater<a class="headerlink" href="#dynamodbtabletheater" title="Permalink to this headline"></a></h4>
<p>This section defines the DynamoDB Table. The DynamoDB Table is used to store the theater box metadata.</p>
<div class="literal-block-wrapper docutils container" id="id22">
<div class="code-block-caption"><span class="caption-text">template.yaml - DynamoDBTableTheater</span><a class="headerlink" href="#id22" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">d-server-00c79yzv8q8cvz</span>
<span class="linenos"> 2</span><span class="w">     </span><span class="w w-Error"> </span><span class="nt">AssumeRolePolicyDocument</span><span class="p">:</span>
<span class="linenos"> 3</span><span class="w">        </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos"> 4</span><span class="w">        </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos"> 5</span><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos"> 6</span><span class="w">            </span><span class="nt">Principal</span><span class="p">:</span>
<span class="linenos"> 7</span><span class="w">              </span><span class="nt">Service</span><span class="p">:</span>
<span class="linenos"> 8</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lambda.amazonaws.com</span>
<span class="linenos"> 9</span><span class="w">            </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">10</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sts:AssumeRole</span>
<span class="linenos">11</span><span class="w">      </span><span class="nt">Policies</span><span class="p">:</span>
<span class="linenos">12</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-DynamoDBPolicy</span>
<span class="linenos">13</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos">14</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos">15</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">16</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">17</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">18</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dynamodb:GetItem</span>
<span class="linenos">19</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dynamodb:Scan</span>
<span class="linenos">20</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dynamodb:Query</span>
<span class="linenos">21</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dynamodb:BatchGetItem</span>
<span class="linenos">22</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DynamoDBTableTheater.Arn</span>
<span class="linenos">23</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-SSMRunDocumentPolicy</span>
<span class="linenos">24</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos">25</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos">26</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">27</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">28</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">29</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:DescribeInstanceInformation</span>
<span class="linenos">30</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ec2:DescribeInstances</span>
<span class="linenos">31</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:SendCommand</span>
</pre></div>
</div>
</div>
</section>
<section id="dynamodbtablestatus">
<h4>DynamoDBTableStatus<a class="headerlink" href="#dynamodbtablestatus" title="Permalink to this headline"></a></h4>
<p>This section defines the DynamoDB Table. The DynamoDB Table is used to store the SSM Run document status.</p>
<div class="literal-block-wrapper docutils container" id="id23">
<div class="code-block-caption"><span class="caption-text">template.yaml - DynamoDBTableStatus</span><a class="headerlink" href="#id23" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:ListCommands</span>
<span class="linenos"> 2</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:ListCommandInvocations</span>
<span class="linenos"> 3</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:CancelCommand</span>
<span class="linenos"> 4</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:GetCommandInvocation</span>
<span class="linenos"> 5</span><span class="w">               </span><span class="w w-Error"> </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;*&#39;</span>
<span class="linenos"> 6</span><span class="w">       </span><span class="w w-Error"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-CloudWatchLogsPolicy</span>
<span class="linenos"> 7</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos"> 8</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos"> 9</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">10</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">11</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">12</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:CreateLogGroup</span>
<span class="linenos">13</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:CreateLogStream</span>
<span class="linenos">14</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:PutLogEvents</span>
<span class="linenos">15</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;*&#39;</span>
<span class="linenos">16</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-SNSPublishPolicy</span>
<span class="linenos">17</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos">18</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos">19</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">20</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">21</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">22</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sns:Publish</span>
<span class="linenos">23</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SNSNotificationTopic</span>
<span class="linenos">24</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-XRayPolicy</span>
<span class="linenos">25</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos">26</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos">27</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">28</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">29</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">30</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xray:PutTraceSegments</span>
<span class="linenos">31</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xray:PutTelemetryRecords</span>
<span class="linenos">32</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;*&#39;</span>
<span class="linenos">33</span><span class="w"> </span><span class="w w-Error"> </span><span class="nt">SSMAgentActivationRole</span><span class="p">:</span>
<span class="linenos">34</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::IAM::Role</span>
<span class="linenos">35</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">36</span><span class="w">      </span><span class="nt">Tags</span><span class="p">:</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="cloudwatch-dashboard">
<h3>Cloudwatch Dashboard<a class="headerlink" href="#cloudwatch-dashboard" title="Permalink to this headline"></a></h3>
<section id="cloudwatchdashboard">
<h4>CloudwatchDashboard<a class="headerlink" href="#cloudwatchdashboard" title="Permalink to this headline"></a></h4>
<p>This section defines the Cloudwatch Dashboard. The Cloudwatch Dashboard is used to display the SSM Run document status, cost and usage. API Gateway, Lambda, DynamoDB and SNS metrics are also displayed.</p>
<div class="literal-block-wrapper docutils container" id="id24">
<div class="code-block-caption"><span class="caption-text">template.yaml - CloudwatchDashboard</span><a class="headerlink" href="#id24" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Project</span>
<span class="linenos">  2</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::StackName</span>
<span class="linenos">  3</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Environment</span>
<span class="linenos">  4</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prod</span>
<span class="linenos">  5</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Owner</span>
<span class="linenos">  6</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mondanthody.firos@primefocus.com</span>
<span class="linenos">  7</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">map-migrated</span>
<span class="linenos">  8</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">d-server-00c79yzv8q8cvz</span>
<span class="linenos">  9</span><span class="w">     </span><span class="w w-Error"> </span><span class="nt">AssumeRolePolicyDocument</span><span class="p">:</span>
<span class="linenos"> 10</span><span class="w">        </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos"> 11</span><span class="w">        </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos"> 12</span><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos"> 13</span><span class="w">            </span><span class="nt">Principal</span><span class="p">:</span>
<span class="linenos"> 14</span><span class="w">              </span><span class="nt">Service</span><span class="p">:</span>
<span class="linenos"> 15</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm.amazonaws.com</span>
<span class="linenos"> 16</span><span class="w">            </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos"> 17</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sts:AssumeRole</span>
<span class="linenos"> 18</span><span class="w">      </span><span class="nt">Policies</span><span class="p">:</span>
<span class="linenos"> 19</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-SSMRunDocumentPolicy</span>
<span class="linenos"> 20</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos"> 21</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos"> 22</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos"> 23</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos"> 24</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos"> 25</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:DescribeInstanceInformation</span>
<span class="linenos"> 26</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:DescribeAssociation</span>
<span class="linenos"> 27</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:GetDeployablePatchSnapshotForInstance</span>
<span class="linenos"> 28</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:GetDocument</span>
<span class="linenos"> 29</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:DescribeDocument</span>
<span class="linenos"> 30</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:GetManifest</span>
<span class="linenos"> 31</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:GetParameter</span>
<span class="linenos"> 32</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:GetParameters</span>
<span class="linenos"> 33</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:PutParameter</span>
<span class="linenos"> 34</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:ListAssociations</span>
<span class="linenos"> 35</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:ListInstanceAssociations</span>
<span class="linenos"> 36</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:PutInventory</span>
<span class="linenos"> 37</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:PutComplianceItems</span>
<span class="linenos"> 38</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:PutConfigurePackageResult</span>
<span class="linenos"> 39</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:UpdateAssociationStatus</span>
<span class="linenos"> 40</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:UpdateInstanceAssociationStatus</span>
<span class="linenos"> 41</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:UpdateInstanceInformation</span>
<span class="linenos"> 42</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;*&#39;</span>
<span class="linenos"> 43</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos"> 44</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos"> 45</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssmmessages:CreateControlChannel</span>
<span class="linenos"> 46</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssmmessages:CreateDataChannel</span>
<span class="linenos"> 47</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssmmessages:OpenControlChannel</span>
<span class="linenos"> 48</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssmmessages:OpenDataChannel</span>
<span class="linenos"> 49</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;*&#39;</span>
<span class="linenos"> 50</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos"> 51</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos"> 52</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ec2messages:AcknowledgeMessage</span>
<span class="linenos"> 53</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ec2messages:DeleteMessage</span>
<span class="linenos"> 54</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ec2messages:FailMessage</span>
<span class="linenos"> 55</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ec2messages:GetEndpoint</span>
<span class="linenos"> 56</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ec2messages:GetMessages</span>
<span class="linenos"> 57</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ec2messages:SendReply</span>
<span class="linenos"> 58</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;*&#39;</span>
<span class="linenos"> 59</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-CloudWatchLogsPolicy</span>
<span class="linenos"> 60</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos"> 61</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos"> 62</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos"> 63</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos"> 64</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos"> 65</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:CreateLogGroup</span>
<span class="linenos"> 66</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:CreateLogStream</span>
<span class="linenos"> 67</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:PutLogEvents</span>
<span class="linenos"> 68</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:DescribeLogGroups</span>
<span class="linenos"> 69</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:DescribeLogStreams</span>
<span class="linenos"> 70</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:logs:*:*:*</span>
<span class="linenos"> 71</span><span class="w">                </span><span class="c1"># CloudWatchAgentServerPolicy</span>
<span class="linenos"> 72</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-CloudWatchAgentServerPolicy</span>
<span class="linenos"> 73</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos"> 74</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos"> 75</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos"> 76</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos"> 77</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos"> 78</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloudwatch:PutMetricData</span>
<span class="linenos"> 79</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ec2:DescribeTags</span>
<span class="linenos"> 80</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ec2:DescribeInstances</span>
<span class="linenos"> 81</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ec2:DescribeVolumes</span>
<span class="linenos"> 82</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;*&#39;</span>
<span class="linenos"> 83</span><span class="w"> </span><span class="w w-Error"> </span><span class="nt">SNSNotificationTopic</span><span class="p">:</span>
<span class="linenos"> 84</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::SNS::Topic</span>
<span class="linenos"> 85</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos"> 86</span><span class="w">      </span><span class="nt">TopicName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-ExpeDatSSMRunDocument-NOTIFICATION</span>
<span class="linenos"> 87</span><span class="w">      </span><span class="nt">DisplayName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-ExpeDatSSMRunDocument</span>
<span class="linenos"> 88</span><span class="w">      </span><span class="nt">Tags</span><span class="p">:</span>
<span class="linenos"> 89</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Project</span>
<span class="linenos"> 90</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::StackName</span>
<span class="linenos"> 91</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Environment</span>
<span class="linenos"> 92</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prod</span>
<span class="linenos"> 93</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Owner</span>
<span class="linenos"> 94</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mondanthody.firos@primefocus.com</span>
<span class="linenos"> 95</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">map-migrated</span>
<span class="linenos"> 96</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">d-server-00c79yzv8q8cvz</span>
<span class="linenos"> 97</span><span class="w">      </span><span class="nt">Subscription</span><span class="p">:</span>
<span class="linenos"> 98</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Endpoint</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mondanthody.firos@primefocus.com</span>
<span class="linenos"> 99</span><span class="w">          </span><span class="nt">Protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">email</span>
<span class="linenos">100</span><span class="w">  </span><span class="nt">SSMSNSPublishRole</span><span class="p">:</span>
<span class="linenos">101</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::IAM::Role</span>
<span class="linenos">102</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">103</span><span class="w">      </span><span class="nt">Tags</span><span class="p">:</span>
<span class="linenos">104</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Project</span>
<span class="linenos">105</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::StackName</span>
<span class="linenos">106</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Environment</span>
<span class="linenos">107</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prod</span>
<span class="linenos">108</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Owner</span>
<span class="linenos">109</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mondanthody.firos@primefocus.com</span>
<span class="linenos">110</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">map-migrated</span>
<span class="linenos">111</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">d-server-00c79yzv8q8cvz</span>
<span class="linenos">112</span><span class="w">      </span><span class="nt">AssumeRolePolicyDocument</span><span class="p">:</span>
<span class="linenos">113</span><span class="w">        </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos">114</span><span class="w">        </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">115</span><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">116</span><span class="w">            </span><span class="nt">Principal</span><span class="p">:</span>
<span class="linenos">117</span><span class="w">              </span><span class="nt">Service</span><span class="p">:</span>
<span class="linenos">118</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm.amazonaws.com</span>
<span class="linenos">119</span><span class="w">            </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">120</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sts:AssumeRole</span>
<span class="linenos">121</span><span class="w">      </span><span class="nt">Policies</span><span class="p">:</span>
<span class="linenos">122</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-SSMSNSPublishPolicy</span>
<span class="linenos">123</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos">124</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos">125</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">126</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">127</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">128</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sns:Publish</span>
<span class="linenos">129</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SNSNotificationTopic</span>
<span class="linenos">130</span><span class="w">  </span><span class="nt">SSMDocument</span><span class="p">:</span>
<span class="linenos">131</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::SSM::Document</span>
<span class="linenos">132</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">133</span><span class="w">      </span><span class="nt">Tags</span><span class="p">:</span>
<span class="linenos">134</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Project</span>
<span class="linenos">135</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::StackName</span>
<span class="linenos">136</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Environment</span>
<span class="linenos">137</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prod</span>
<span class="linenos">138</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Owner</span>
<span class="linenos">139</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mondanthody.firos@primefocus.com</span>
<span class="linenos">140</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">map-migrated</span>
<span class="linenos">141</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">d-server-00c79yzv8q8cvz</span>
<span class="linenos">142</span><span class="w">      </span><span class="nt">Content</span><span class="p">:</span>
<span class="linenos">143</span><span class="w">        </span><span class="nt">schemaVersion</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2.2&#39;</span>
<span class="linenos">144</span><span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Command Document ExpeDat Copy</span>
<span class="linenos">145</span><span class="w">        </span><span class="nt">parameters</span><span class="p">:</span>
<span class="linenos">146</span><span class="w">          </span><span class="nt">ClientId</span><span class="p">:</span>
<span class="linenos">147</span><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">String</span>
<span class="linenos">148</span><span class="w">            </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Client ID</span>
<span class="linenos">149</span><span class="w">            </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PVR-0001</span>
<span class="linenos">150</span><span class="w">          </span><span class="nt">SourcePath</span><span class="p">:</span>
<span class="linenos">151</span><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">String</span>
<span class="linenos">152</span><span class="w">            </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">location of the source</span>
<span class="linenos">153</span><span class="w">            </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/caffeine</span>
<span class="linenos">154</span><span class="w">          </span><span class="nt">DestinationPath</span><span class="p">:</span>
<span class="linenos">155</span><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">String</span>
<span class="linenos">156</span><span class="w">            </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">location of the destination Linux</span>
<span class="linenos">157</span><span class="w">            </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/DCinema/downloads</span>
<span class="linenos">158</span><span class="w">          </span><span class="nt">ExpeDatUser</span><span class="p">:</span>
<span class="linenos">159</span><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">String</span>
<span class="linenos">160</span><span class="w">            </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ExpeDat username</span>
<span class="linenos">161</span><span class="w">            </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="s">&#39;{{ssm:${ExpeDatUserParameterName}}}&#39;</span>
<span class="linenos">162</span><span class="w">          </span><span class="nt">ExpeDatPass</span><span class="p">:</span>
<span class="linenos">163</span><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">String</span>
<span class="linenos">164</span><span class="w">            </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ExpeDat password</span>
<span class="linenos">165</span><span class="w">            </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="s">&#39;{{ssm:${ExpeDatPassParameterName}}}&#39;</span>
<span class="linenos">166</span><span class="w">          </span><span class="nt">ExpeDatServer</span><span class="p">:</span>
<span class="linenos">167</span><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">String</span>
<span class="linenos">168</span><span class="w">            </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ExpeDat server IP</span>
<span class="linenos">169</span><span class="w">            </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="s">&#39;{{ssm:${ExpeDatServerParameterName}}}&#39;</span>
<span class="linenos">170</span><span class="w">          </span><span class="nt">ExpeDatPort</span><span class="p">:</span>
<span class="linenos">171</span><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">String</span>
<span class="linenos">172</span><span class="w">            </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ExpeDat server port</span>
<span class="linenos">173</span><span class="w">            </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="s">&#39;{{ssm:${ExpeDatPortParameterName}}}&#39;</span>
<span class="linenos">174</span><span class="w">        </span><span class="nt">mainSteps</span><span class="p">:</span>
<span class="linenos">175</span><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws:runShellScript</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="step-functions">
<h3>Step Functions<a class="headerlink" href="#step-functions" title="Permalink to this headline"></a></h3>
<section id="statemachineexpresssync">
<h4>StateMachineExpressSync<a class="headerlink" href="#statemachineexpresssync" title="Permalink to this headline"></a></h4>
<p>This section defines the Step Functions. The Step Functions is used to run the SSM Run document. This is optional and can be set using Parameters section.</p>
<div class="literal-block-wrapper docutils container" id="id25">
<div class="code-block-caption"><span class="caption-text">template.yaml - StateMachineExpressSync</span><a class="headerlink" href="#id25" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ExpeDat</span>
<span class="linenos"> 2</span><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span>
<span class="linenos"> 3</span><span class="w">              </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">172800</span>
<span class="linenos"> 4</span><span class="w">              </span><span class="nt">runCommand</span><span class="p">:</span>
<span class="linenos"> 5</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;</span><span class="nv"> </span><span class="s">#!/bin/sh&#39;</span>
<span class="linenos"> 6</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;</span><span class="nv"> </span><span class="s">set</span><span class="nv"> </span><span class="s">-e&#39;</span>
<span class="linenos"> 7</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;</span><span class="nv"> </span><span class="s">mkdir</span><span class="nv"> </span><span class="s">-p</span><span class="nv"> </span><span class="s">{{DestinationPath}}</span><span class="nv"> </span><span class="s">&gt;/dev/null</span><span class="nv"> </span><span class="s">2&gt;&amp;1&#39;</span>
<span class="linenos"> 8</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;</span><span class="nv"> </span><span class="s">log_file=&quot;/tmp/movedat.log&quot;&#39;</span>
<span class="linenos"> 9</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;</span><span class="nv"> </span><span class="s">touch</span><span class="nv"> </span><span class="s">&quot;$log_file&quot;&#39;</span>
<span class="linenos">10</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;</span><span class="nv"> </span><span class="s">movedat</span><span class="nv"> </span><span class="s">-h</span><span class="nv"> </span><span class="s">-s</span><span class="nv"> </span><span class="s">-y</span><span class="nv"> </span><span class="s">{{ExpeDatUser}}:{{ExpeDatPass}}@{{ExpeDatServer}}:{{SourcePath}}</span><span class="nv"> </span><span class="s">{{DestinationPath}}</span><span class="nv"> </span><span class="s">&gt;&gt;</span><span class="nv"> </span><span class="s">&quot;$log_file&quot;</span><span class="nv"> </span><span class="s">2&gt;&amp;1&#39;</span>
<span class="linenos">11</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;</span><span class="nv"> </span><span class="s">tail</span><span class="nv"> </span><span class="s">-n</span><span class="nv"> </span><span class="s">4</span><span class="nv"> </span><span class="s">&quot;$log_file&quot;&#39;</span>
<span class="linenos">12</span><span class="w">     </span><span class="w w-Error"> </span><span class="nt">DocumentType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Command</span>
<span class="linenos">13</span><span class="w">      </span><span class="nt">DocumentFormat</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">YAML</span>
<span class="linenos">14</span><span class="w"> </span><span class="w w-Error"> </span><span class="nt">InstallDependency</span><span class="p">:</span>
<span class="linenos">15</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::SSM::Document</span>
<span class="linenos">16</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">17</span><span class="w">      </span><span class="nt">Tags</span><span class="p">:</span>
<span class="linenos">18</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Project</span>
<span class="linenos">19</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::StackName</span>
<span class="linenos">20</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Environment</span>
<span class="linenos">21</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prod</span>
<span class="linenos">22</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Owner</span>
<span class="linenos">23</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mondanthody.firos@primefocus.com</span>
<span class="linenos">24</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">map-migrated</span>
<span class="linenos">25</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">d-server-00c79yzv8q8cvz</span>
<span class="linenos">26</span><span class="w">      </span><span class="nt">Content</span><span class="p">:</span>
<span class="linenos">27</span><span class="w">        </span><span class="nt">schemaVersion</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2.2&#39;</span>
<span class="linenos">28</span><span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Check and install required packages for theater box</span>
<span class="linenos">29</span><span class="w">        </span><span class="nt">parameters</span><span class="p">:</span>
<span class="linenos">30</span><span class="w">          </span><span class="nt">pythonVersion</span><span class="p">:</span>
<span class="linenos">31</span><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">String</span>
<span class="linenos">32</span><span class="w">            </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Python</span><span class="nv"> </span><span class="s">version</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">use</span><span class="nv"> </span><span class="s">(default</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">3.8.10)&quot;</span>
<span class="linenos">33</span><span class="w">            </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3.8.10</span>
<span class="linenos">34</span>
<span class="linenos">35</span><span class="w">        </span><span class="nt">mainSteps</span><span class="p">:</span>
<span class="linenos">36</span><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CheckPython</span>
<span class="linenos">37</span><span class="w">            </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws:runShellScript</span>
<span class="linenos">38</span><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span>
<span class="linenos">39</span><span class="w">              </span><span class="nt">runCommand</span><span class="p">:</span>
<span class="linenos">40</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;#!/bin/sh&quot;</span>
<span class="linenos">41</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;set</span><span class="nv"> </span><span class="s">-e&quot;</span>
<span class="linenos">42</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;python3</span><span class="nv"> </span><span class="s">--version</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">grep</span><span class="nv"> </span><span class="s">{{pythonVersion}}&#39;</span>
<span class="linenos">43</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;if</span><span class="nv"> </span><span class="s">[</span><span class="nv"> </span><span class="s">$?</span><span class="nv"> </span><span class="s">-eq</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">];</span><span class="nv"> </span><span class="s">then</span><span class="nv"> </span><span class="s">echo</span><span class="nv"> </span><span class="s">&quot;Python</span><span class="nv"> </span><span class="s">{{pythonVersion}}</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">already</span><span class="nv"> </span><span class="s">installed&quot;;</span><span class="nv"> </span><span class="s">else</span><span class="nv"> </span><span class="s">apt-get</span><span class="nv"> </span><span class="s">update;</span><span class="nv"> </span><span class="s">apt-get</span><span class="nv"> </span><span class="s">install</span><span class="nv"> </span><span class="s">-y</span><span class="nv"> </span><span class="s">python3</span><span class="nv"> </span><span class="s">python3-pip;</span><span class="nv"> </span><span class="s">fi&#39;</span>
<span class="linenos">44</span><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CheckBoto3</span>
<span class="linenos">45</span><span class="w">            </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws:runShellScript</span>
<span class="linenos">46</span><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span>
<span class="linenos">47</span><span class="w">              </span><span class="nt">runCommand</span><span class="p">:</span>
<span class="linenos">48</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;#!/bin/sh&quot;</span>
<span class="linenos">49</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;set</span><span class="nv"> </span><span class="s">-e&quot;</span>
<span class="linenos">50</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;pip3</span><span class="nv"> </span><span class="s">list</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">grep</span><span class="nv"> </span><span class="s">boto3&#39;</span>
<span class="linenos">51</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;if</span><span class="nv"> </span><span class="s">[</span><span class="nv"> </span><span class="s">$?</span><span class="nv"> </span><span class="s">-eq</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">];</span><span class="nv"> </span><span class="s">then</span><span class="nv"> </span><span class="s">echo</span><span class="nv"> </span><span class="s">&quot;Boto3</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">already</span><span class="nv"> </span><span class="s">installed&quot;;</span><span class="nv"> </span><span class="s">else</span><span class="nv"> </span><span class="s">pip3</span><span class="nv"> </span><span class="s">install</span><span class="nv"> </span><span class="s">boto3;</span><span class="nv"> </span><span class="s">fi&#39;</span>
<span class="linenos">52</span><span class="w">      </span><span class="nt">DocumentType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Command</span>
<span class="linenos">53</span><span class="w">      </span><span class="nt">DocumentFormat</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">YAML</span><span class="w">  </span>
<span class="linenos">54</span><span class="w">  </span><span class="nt">ServerHashGenerator</span><span class="p">:</span>
<span class="linenos">55</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::SSM::Document</span>
<span class="linenos">56</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">57</span><span class="w">      </span><span class="nt">Tags</span><span class="p">:</span>
<span class="linenos">58</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Project</span>
<span class="linenos">59</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::StackName</span>
<span class="linenos">60</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Environment</span>
<span class="linenos">61</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prod</span>
<span class="linenos">62</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Owner</span>
<span class="linenos">63</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mondanthody.firos@primefocus.com</span>
<span class="linenos">64</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">map-migrated</span>
<span class="linenos">65</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">d-server-00c79yzv8q8cvz</span>
<span class="linenos">66</span><span class="w">      </span><span class="nt">Content</span><span class="p">:</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="iam-role">
<h3>IAM Role<a class="headerlink" href="#iam-role" title="Permalink to this headline"></a></h3>
<section id="customauthorizerrole">
<h4>CustomAuthorizerRole<a class="headerlink" href="#customauthorizerrole" title="Permalink to this headline"></a></h4>
<p>This section defines the IAM Role. The IAM Role is used to allow the API Gateway to invoke the Lambda function.</p>
<div class="literal-block-wrapper docutils container" id="id26">
<div class="code-block-caption"><span class="caption-text">template.yaml - CustomAuthorizerRole</span><a class="headerlink" href="#id26" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">      </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Custom Authorizer for API Gateway Endpoints</span>
<span class="linenos"> 2</span><span class="w">      </span><span class="nt">Role</span><span class="p">:</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CustomAuthorizerRole.Arn</span>
<span class="linenos"> 3</span><span class="w">      </span><span class="nt">Layers</span><span class="p">:</span>
<span class="linenos"> 4</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:lambda:${AWS::Region}:017000801446:layer:AWSLambdaPowertoolsPythonV2:19</span>
<span class="linenos"> 5</span><span class="w">      </span><span class="nt">Environment</span><span class="p">:</span>
<span class="linenos"> 6</span><span class="w">        </span><span class="nt">Variables</span><span class="p">:</span>
<span class="linenos"> 7</span><span class="w">          </span><span class="nt">SECRET_ID</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-ApiGatewaySecretKey-${AWS::Region}</span>
<span class="linenos"> 8</span><span class="w"> </span><span class="w w-Error"> </span><span class="nt">CustomAuthorizerRole</span><span class="p">:</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::IAM::Role</span>
<span class="linenos">10</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">11</span><span class="w">      </span><span class="nt">Tags</span><span class="p">:</span>
<span class="linenos">12</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Project</span>
<span class="linenos">13</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::StackName</span>
<span class="linenos">14</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Environment</span>
<span class="linenos">15</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prod</span>
<span class="linenos">16</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Owner</span>
<span class="linenos">17</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mondanthody.firos@primefocus.com</span>
<span class="linenos">18</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">map-migrated</span>
<span class="linenos">19</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">d-server-00c79yzv8q8cvz</span>
<span class="linenos">20</span><span class="w">      </span><span class="nt">AssumeRolePolicyDocument</span><span class="p">:</span>
<span class="linenos">21</span><span class="w">        </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos">22</span><span class="w">        </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">23</span><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">24</span><span class="w">            </span><span class="nt">Principal</span><span class="p">:</span>
<span class="linenos">25</span><span class="w">              </span><span class="nt">Service</span><span class="p">:</span>
<span class="linenos">26</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lambda.amazonaws.com</span>
<span class="linenos">27</span><span class="w">            </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">28</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sts:AssumeRole</span>
<span class="linenos">29</span><span class="w">      </span><span class="nt">Policies</span><span class="p">:</span>
<span class="linenos">30</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CustomAuthorizerPolicy</span>
<span class="linenos">31</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos">32</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos">33</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">34</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">35</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">36</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:CreateLogGroup</span>
</pre></div>
</div>
</div>
</section>
<section id="ssmnotificationrole">
<h4>SSMNotificationRole<a class="headerlink" href="#ssmnotificationrole" title="Permalink to this headline"></a></h4>
<p>This section defines the IAM Role. The IAM Role is used to allow the Lambda function to send the SSM Run document status notification using SES.</p>
<div class="literal-block-wrapper docutils container" id="id27">
<div class="code-block-caption"><span class="caption-text">template.yaml - SSMNotificationRole</span><a class="headerlink" href="#id27" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Environment</span>
<span class="linenos"> 2</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prod</span>
<span class="linenos"> 3</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Owner</span>
<span class="linenos"> 4</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mondanthody.firos@primefocus.com</span>
<span class="linenos"> 5</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">map-migrated</span>
<span class="linenos"> 6</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">d-server-00c79yzv8q8cvz</span>
<span class="linenos"> 7</span><span class="w">     </span><span class="w w-Error"> </span><span class="nt">AssumeRolePolicyDocument</span><span class="p">:</span>
<span class="linenos"> 8</span><span class="w">        </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos"> 9</span><span class="w">        </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">10</span><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">11</span><span class="w">            </span><span class="nt">Principal</span><span class="p">:</span>
<span class="linenos">12</span><span class="w">              </span><span class="nt">Service</span><span class="p">:</span>
<span class="linenos">13</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lambda.amazonaws.com</span>
<span class="linenos">14</span><span class="w">            </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">15</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sts:AssumeRole</span>
<span class="linenos">16</span><span class="w">      </span><span class="nt">Policies</span><span class="p">:</span>
<span class="linenos">17</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-ExpeDatCancelRunDocumentPolicy</span>
<span class="linenos">18</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos">19</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos">20</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">21</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">22</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">23</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:CancelCommand</span>
<span class="linenos">24</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;*&#39;</span>
<span class="linenos">25</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-DynamoDBPolicy</span>
<span class="linenos">26</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos">27</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos">28</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">29</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">30</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">31</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dynamodb:GetItem</span>
<span class="linenos">32</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DynamoDBTableTheater.Arn</span>
<span class="linenos">33</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-CloudWatchLogsPolicy</span>
<span class="linenos">34</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos">35</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos">36</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">37</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">38</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">39</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:CreateLogGroup</span>
<span class="linenos">40</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:CreateLogStream</span>
<span class="linenos">41</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:PutLogEvents</span>
<span class="linenos">42</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;*&#39;</span>
<span class="linenos">43</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-XRayPolicy</span>
<span class="linenos">44</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos">45</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos">46</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">47</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">48</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">49</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xray:PutTraceSegments</span>
<span class="linenos">50</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xray:PutTelemetryRecords</span>
<span class="linenos">51</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;*&#39;</span>
<span class="linenos">52</span><span class="w"> </span><span class="w w-Error"> </span><span class="nt">GeneratedPresignedURL</span><span class="p">:</span>
<span class="linenos">53</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Serverless::Function</span>
<span class="linenos">54</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">55</span><span class="w">      </span><span class="nt">Runtime</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python3.8</span>
<span class="linenos">56</span><span class="w">      </span><span class="nt">CodeUri</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./functions/GeneratedPresignedURL/</span>
<span class="linenos">57</span><span class="w">      </span><span class="nt">Handler</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">index.lambda_handler</span>
<span class="linenos">58</span><span class="w">      </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">This function will generate a presigned URL for the client to upload the hash file to S3 for validation</span>
<span class="linenos">59</span><span class="w">      </span><span class="nt">Role</span><span class="p">:</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GeneratedPresignedURLRole.Arn</span>
<span class="linenos">60</span><span class="w">      </span><span class="nt">Layers</span><span class="p">:</span>
<span class="linenos">61</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:lambda:${AWS::Region}:017000801446:layer:AWSLambdaPowertoolsPythonV2:19</span>
<span class="linenos">62</span><span class="w">      </span><span class="nt">Environment</span><span class="p">:</span>
<span class="linenos">63</span><span class="w">        </span><span class="nt">Variables</span><span class="p">:</span>
<span class="linenos">64</span><span class="w">          </span><span class="nt">DYNAMODB_TABLE</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DynamoDBTableTheater</span>
<span class="linenos">65</span><span class="w">          </span><span class="nt">POWERTOOLS_SERVICE_NAME</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GeneratedPresignedURL</span>
<span class="linenos">66</span><span class="w">          </span><span class="nt">POWERTOOLS_METRICS_NAMESPACE</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GeneratedPresignedURL</span>
<span class="linenos">67</span><span class="w">          </span><span class="nt">LOG_LEVEL</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">INFO</span>
<span class="linenos">68</span><span class="w">          </span><span class="nt">S3_BUCKET</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mum-pr-dcinema-deployments-s3</span>
<span class="linenos">69</span><span class="w">      </span><span class="nt">Events</span><span class="p">:</span>
<span class="linenos">70</span><span class="w">        </span><span class="nt">ApiGatewayS3Verify</span><span class="p">:</span>
<span class="linenos">71</span><span class="w">          </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Api</span>
</pre></div>
</div>
</div>
</section>
<section id="ssminstallscriptgeneratorrole">
<h4>SSMInstallScriptGeneratorRole<a class="headerlink" href="#ssminstallscriptgeneratorrole" title="Permalink to this headline"></a></h4>
<p>This section defines the IAM Role. The IAM Role is used to allow the Lambda function to generate the SSM Install Script.</p>
<div class="literal-block-wrapper docutils container" id="id28">
<div class="code-block-caption"><span class="caption-text">template.yaml - SSMInstallScriptGeneratorRole</span><a class="headerlink" href="#id28" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">        </span><span class="nt">Variables</span><span class="p">:</span>
<span class="linenos"> 2</span><span class="w">          </span><span class="nt">POWERTOOLS_SERVICE_NAME</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ValidateTransfer</span>
<span class="linenos"> 3</span><span class="w">          </span><span class="nt">POWERTOOLS_METRICS_NAMESPACE</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ValidateTransfer</span>
<span class="linenos"> 4</span><span class="w">          </span><span class="nt">LOG_LEVEL</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">INFO</span>
<span class="linenos"> 5</span><span class="w">          </span><span class="nt">S3_BUCKET</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mum-pr-dcinema-deployments-s3</span>
<span class="linenos"> 6</span><span class="w">          </span>
<span class="linenos"> 7</span><span class="w">     </span><span class="w w-Error"> </span><span class="nt">Events</span><span class="p">:</span>
<span class="linenos"> 8</span><span class="w">        </span><span class="nt">ApiGatewayS3Verify</span><span class="p">:</span>
<span class="linenos"> 9</span><span class="w">          </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Api</span>
<span class="linenos">10</span><span class="w">          </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">11</span><span class="w">            </span><span class="nt">Path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/verify</span>
<span class="linenos">12</span><span class="w">            </span><span class="nt">Method</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">post</span>
<span class="linenos">13</span><span class="w">            </span><span class="nt">RestApiId</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ApiGatewayS3Verify</span>
<span class="linenos">14</span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="w"> </span><span class="w w-Error"> </span><span class="nt">ValidateTransferRole</span><span class="p">:</span>
<span class="linenos">17</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::IAM::Role</span>
<span class="linenos">18</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">19</span><span class="w">      </span><span class="nt">Tags</span><span class="p">:</span>
<span class="linenos">20</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Project</span>
<span class="linenos">21</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::StackName</span>
<span class="linenos">22</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Environment</span>
<span class="linenos">23</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prod</span>
<span class="linenos">24</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Owner</span>
<span class="linenos">25</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mondanthody.firos@primefocus.com</span>
<span class="linenos">26</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">map-migrated</span>
<span class="linenos">27</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">d-server-00c79yzv8q8cvz</span>
<span class="linenos">28</span><span class="w">      </span><span class="nt">AssumeRolePolicyDocument</span><span class="p">:</span>
<span class="linenos">29</span><span class="w">        </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos">30</span><span class="w">        </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">31</span><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">32</span><span class="w">            </span><span class="nt">Principal</span><span class="p">:</span>
</pre></div>
</div>
</div>
</section>
<section id="expedatssmrundocumetrole">
<h4>ExpeDatSSMRunDocumetRole<a class="headerlink" href="#expedatssmrundocumetrole" title="Permalink to this headline"></a></h4>
<p>This section defines the IAM Role. The IAM Role is used to allow the Lambda function to run the SSM Run document.</p>
<div class="literal-block-wrapper docutils container" id="id29">
<div class="code-block-caption"><span class="caption-text">template.yaml - ExpeDatSSMRunDocumetRole</span><a class="headerlink" href="#id29" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:s3:::mum-pr-dcinema-deployments-s3</span>
<span class="linenos"> 2</span><span class="w">             </span><span class="w w-Error"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos"> 3</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos"> 4</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3:GetObject</span>
<span class="linenos"> 5</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3:GetObjectAcl</span>
<span class="linenos"> 6</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3:GetObjectTagging</span>
<span class="linenos"> 7</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3:GetObjectVersion</span>
<span class="linenos"> 8</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3:GetObjectVersionAcl</span>
<span class="linenos"> 9</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3:GetObjectVersionTagging</span>
<span class="linenos">10</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:s3:::mum-pr-dcinema-deployments-s3/*</span>
<span class="linenos">11</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">12</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">13</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloudwatch:PutMetricData</span>
<span class="linenos">14</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:CreateLogGroup</span>
<span class="linenos">15</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:CreateLogStream</span>
<span class="linenos">16</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:PutLogEvents</span>
<span class="linenos">17</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;*&#39;</span>
<span class="linenos">18</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">19</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">20</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xray:PutTraceSegments</span>
<span class="linenos">21</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xray:PutTelemetryRecords</span>
<span class="linenos">22</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;*&#39;</span>
<span class="linenos">23</span>
<span class="linenos">24</span><span class="w"> </span><span class="w w-Error"> </span><span class="nt">ApiGatewayS3Verify</span><span class="p">:</span>
<span class="linenos">25</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Serverless::Api</span>
<span class="linenos">26</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">27</span><span class="w">      </span><span class="nt">StageName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prod</span>
<span class="linenos">28</span><span class="w">      </span><span class="nt">Tags</span><span class="p">:</span>
<span class="linenos">29</span><span class="w">        </span><span class="nt">Project</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::StackName</span>
<span class="linenos">30</span><span class="w">        </span><span class="nt">Environment</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prod</span>
<span class="linenos">31</span><span class="w">        </span><span class="nt">Owner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mondanthody.firos@primefocus.com</span>
<span class="linenos">32</span><span class="w">      </span><span class="nt">DefinitionBody</span><span class="p">:</span>
<span class="linenos">33</span><span class="w">        </span><span class="nt">swagger</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2.0&#39;</span>
<span class="linenos">34</span><span class="w">        </span><span class="nt">info</span><span class="p">:</span>
<span class="linenos">35</span><span class="w">          </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2018-11-29T23:30:18Z&#39;</span>
<span class="linenos">36</span><span class="w">          </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-PresignedURL-API</span>
<span class="linenos">37</span><span class="w">        </span><span class="nt">paths</span><span class="p">:</span>
<span class="linenos">38</span><span class="w">          </span><span class="nt">/presignedurl</span><span class="p">:</span>
<span class="linenos">39</span><span class="w">            </span><span class="nt">post</span><span class="p">:</span>
<span class="linenos">40</span><span class="w">              </span><span class="nt">x-amazon-apigateway-integration</span><span class="p">:</span>
<span class="linenos">41</span><span class="w">                </span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GeneratedPresignedURL.Arn}/invocations</span>
<span class="linenos">42</span><span class="w">                </span><span class="nt">passthroughBehavior</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">when_no_match</span>
<span class="linenos">43</span><span class="w">                </span><span class="nt">httpMethod</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POST</span>
<span class="linenos">44</span><span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws_proxy</span>
<span class="linenos">45</span><span class="w">                </span><span class="nt">responses</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span><span class="w">     </span>
<span class="linenos">46</span>
<span class="linenos">47</span><span class="w">          </span><span class="nt">/verify</span><span class="p">:</span>
<span class="linenos">48</span><span class="w">            </span><span class="nt">post</span><span class="p">:</span>
<span class="linenos">49</span><span class="w">              </span><span class="nt">x-amazon-apigateway-integration</span><span class="p">:</span>
<span class="linenos">50</span><span class="w">                </span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ValidateTransfer.Arn}/invocations</span>
<span class="linenos">51</span><span class="w">                </span><span class="nt">passthroughBehavior</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">when_no_match</span>
<span class="linenos">52</span><span class="w">                </span><span class="nt">httpMethod</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POST</span>
<span class="linenos">53</span><span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws_proxy</span>
<span class="linenos">54</span><span class="w">                </span><span class="nt">responses</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="linenos">55</span><span class="w">                </span>
<span class="linenos">56</span>
<span class="linenos">57</span><span class="w">  </span><span class="nt">ExpeDatSSMInvocationQuery</span><span class="p">:</span>
<span class="linenos">58</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Serverless::Function</span>
<span class="linenos">59</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">60</span><span class="w">      </span><span class="nt">Runtime</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python3.8</span>
<span class="linenos">61</span><span class="w">      </span><span class="nt">CodeUri</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./functions/ExpeDatSSMInvocationQuery/</span>
<span class="linenos">62</span><span class="w">      </span><span class="nt">Handler</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">index.lambda_handler</span>
<span class="linenos">63</span><span class="w">      </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">This function will query the SSM Invocation command output and return the status</span>
<span class="linenos">64</span><span class="w">      </span><span class="nt">Role</span><span class="p">:</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ExpeDatSSMInvocationQueryRole.Arn</span>
<span class="linenos">65</span><span class="w">      </span><span class="nt">Layers</span><span class="p">:</span>
<span class="linenos">66</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:lambda:${AWS::Region}:017000801446:layer:AWSLambdaPowertoolsPythonV2:19</span>
<span class="linenos">67</span><span class="w">      </span><span class="nt">Environment</span><span class="p">:</span>
<span class="linenos">68</span><span class="w">        </span><span class="nt">Variables</span><span class="p">:</span>
<span class="linenos">69</span><span class="w">          </span><span class="nt">DYNAMODB_TABLE</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DynamoDBTableTheater</span>
<span class="linenos">70</span><span class="w">          </span><span class="nt">POWERTOOLS_SERVICE_NAME</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ExpeDatSSMInvocationQuery</span>
<span class="linenos">71</span><span class="w">          </span><span class="nt">POWERTOOLS_METRICS_NAMESPACE</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ExpeDatSSMInvocationQuery</span>
<span class="linenos">72</span><span class="w">          </span><span class="nt">LOG_LEVEL</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">INFO</span>
<span class="linenos">73</span><span class="w">      </span><span class="nt">Events</span><span class="p">:</span>
<span class="linenos">74</span><span class="w">        </span><span class="nt">ApiGatewayEndpoint</span><span class="p">:</span>
<span class="linenos">75</span><span class="w">          </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Api</span>
<span class="linenos">76</span><span class="w">          </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">77</span><span class="w">            </span><span class="nt">Path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/query</span>
<span class="linenos">78</span><span class="w">            </span><span class="nt">Method</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">post</span>
<span class="linenos">79</span><span class="w">            </span><span class="nt">RestApiId</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ApiGatewayEndpoint</span>
<span class="linenos">80</span><span class="w">            </span><span class="nt">Auth</span><span class="p">:</span>
<span class="linenos">81</span><span class="w">              </span><span class="nt">Authorizer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CustomAuthorizer</span>
<span class="linenos">82</span><span class="w">  </span><span class="nt">SSMAgentActivation</span><span class="p">:</span>
</pre></div>
</div>
</div>
</section>
<section id="expedatssminvocationqueryrole">
<h4>ExpeDatSSMInvocationQueryRole<a class="headerlink" href="#expedatssminvocationqueryrole" title="Permalink to this headline"></a></h4>
<p>This section defines the IAM Role. The IAM Role is used to allow the Lambda function to query the SSM Run document status.</p>
<div class="literal-block-wrapper docutils container" id="id30">
<div class="code-block-caption"><span class="caption-text">template.yaml - ExpeDatSSMInvocationQueryRole</span><a class="headerlink" href="#id30" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">  </span><span class="nt">SSMAgentActivation</span><span class="p">:</span>
<span class="linenos"> 2</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Serverless::Function</span>
<span class="linenos"> 3</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos"> 4</span><span class="w">      </span><span class="nt">Runtime</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python3.8</span>
<span class="linenos"> 5</span><span class="w">      </span><span class="nt">CodeUri</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./functions/SSMAgentActivation/</span>
<span class="linenos"> 6</span><span class="w">      </span><span class="nt">Handler</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">index.lambda_handler</span>
<span class="linenos"> 7</span><span class="w">      </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">This function will activate the SSM Agent on the client machine</span>
<span class="linenos"> 8</span><span class="w">      </span><span class="nt">Role</span><span class="p">:</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SSMAgentActivationRole.Arn</span>
<span class="linenos"> 9</span><span class="w">      </span><span class="nt">Layers</span><span class="p">:</span>
<span class="linenos">10</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:lambda:${AWS::Region}:017000801446:layer:AWSLambdaPowertoolsPythonV2:19</span>
<span class="linenos">11</span><span class="w">      </span><span class="nt">Environment</span><span class="p">:</span>
<span class="linenos">12</span><span class="w">        </span><span class="nt">Variables</span><span class="p">:</span>
<span class="linenos">13</span><span class="w">          </span><span class="nt">DYNAMODB_TABLE_THEATER</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DynamoDBTableTheater</span>
<span class="linenos">14</span><span class="w">          </span><span class="nt">PROJECT_NAME</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::StackName</span>
<span class="linenos">15</span><span class="w">          </span><span class="nt">SSM_ROLE</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SSMAgentRole</span>
<span class="linenos">16</span><span class="w">          </span><span class="nt">POWERTOOLS_SERVICE_NAME</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SSMAgentActivation</span>
<span class="linenos">17</span><span class="w">          </span><span class="nt">POWERTOOLS_METRICS_NAMESPACE</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SSMAgentActivation</span>
<span class="linenos">18</span><span class="w">          </span><span class="nt">SSM_PARAMETER</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SSMActivationParameter</span>
<span class="linenos">19</span><span class="w">          </span><span class="nt">INSTALL_DEPENDENCIES</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">InstallDependency</span>
<span class="linenos">20</span><span class="w">      </span><span class="nt">Timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">150</span>
<span class="linenos">21</span><span class="w">      </span><span class="nt">Events</span><span class="p">:</span>
<span class="linenos">22</span><span class="w">        </span><span class="nt">SSMActivation</span><span class="p">:</span>
<span class="linenos">23</span><span class="w">          </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Api</span>
<span class="linenos">24</span><span class="w">          </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">25</span><span class="w">            </span><span class="nt">Path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/ssmactivation</span>
<span class="linenos">26</span><span class="w">            </span><span class="nt">Method</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">post</span>
<span class="linenos">27</span><span class="w">            </span><span class="nt">RestApiId</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SSMActivationApi</span>
<span class="linenos">28</span><span class="w">        </span><span class="nt">AddTags</span><span class="p">:</span>
<span class="linenos">29</span><span class="w">          </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Api</span>
<span class="linenos">30</span><span class="w">          </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">31</span><span class="w">            </span><span class="nt">Path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/addtags</span>
<span class="linenos">32</span><span class="w">            </span><span class="nt">Method</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">post</span>
<span class="linenos">33</span><span class="w">            </span><span class="nt">RestApiId</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SSMActivationApi</span>
<span class="linenos">34</span><span class="w">  </span><span class="nt">SSMNotification</span><span class="p">:</span>
<span class="linenos">35</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Serverless::Function</span>
<span class="linenos">36</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">37</span><span class="w">      </span><span class="nt">Runtime</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python3.8</span>
<span class="linenos">38</span><span class="w">      </span><span class="nt">CodeUri</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./functions/SSMNotification/</span>
<span class="linenos">39</span><span class="w">      </span><span class="nt">Handler</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">index.lambda_handler</span>
<span class="linenos">40</span><span class="w">      </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">This function will send Email notification to the user</span>
<span class="linenos">41</span><span class="w">      </span><span class="nt">Role</span><span class="p">:</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SSMNotificationRole.Arn</span>
<span class="linenos">42</span><span class="w">      </span><span class="nt">Layers</span><span class="p">:</span>
<span class="linenos">43</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:lambda:${AWS::Region}:017000801446:layer:AWSLambdaPowertoolsPythonV2:19</span>
<span class="linenos">44</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CommonLambdaLayer</span>
<span class="linenos">45</span><span class="w">      </span><span class="nt">Environment</span><span class="p">:</span>
<span class="linenos">46</span><span class="w">        </span><span class="nt">Variables</span><span class="p">:</span>
<span class="linenos">47</span><span class="w">          </span><span class="nt">POWERTOOLS_SERVICE_NAME</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SSMNotification</span>
<span class="linenos">48</span><span class="w">          </span><span class="nt">POWERTOOLS_METRICS_NAMESPACE</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SSMNotification</span>
<span class="linenos">49</span><span class="w">          </span><span class="nt">LOG_LEVEL</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">INFO</span>
<span class="linenos">50</span><span class="w">          </span><span class="nt">EMAIL_FROM</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NotificationEmailFrom</span>
<span class="linenos">51</span><span class="w">          </span><span class="nt">Role</span><span class="p">:</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SSMSNSPublishRole.Arn</span>
<span class="linenos">52</span><span class="w">          </span><span class="nt">SSM_DOCUMENT_NAME</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SSMDocument</span>
<span class="linenos">53</span><span class="w">          </span><span class="nt">DYNAMODB_TABLE</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DynamoDBTableTheater</span>
<span class="linenos">54</span><span class="w">          </span><span class="nt">STATUS_TABLE</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DynamoDBTableStatus</span>
<span class="linenos">55</span><span class="w">          </span><span class="nt">S3_BUCKET</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mum-pr-dcinema-deployments-s3</span>
<span class="linenos">56</span><span class="w">      </span><span class="nt">Events</span><span class="p">:</span>
<span class="linenos">57</span><span class="w">        </span><span class="nt">SNSNotificationTopic</span><span class="p">:</span>
<span class="linenos">58</span><span class="w">          </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SNS</span>
<span class="linenos">59</span><span class="w">          </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">60</span><span class="w">            </span><span class="nt">Topic</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SNSNotificationTopic</span>
<span class="linenos">61</span><span class="w">  </span><span class="nt">SSMNotificationRole</span><span class="p">:</span>
<span class="linenos">62</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::IAM::Role</span>
<span class="linenos">63</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">64</span><span class="w">      </span><span class="nt">Tags</span><span class="p">:</span>
<span class="linenos">65</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Project</span>
<span class="linenos">66</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::StackName</span>
<span class="linenos">67</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Environment</span>
<span class="linenos">68</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prod</span>
<span class="linenos">69</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Owner</span>
<span class="linenos">70</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mondanthody.firos@primefocus.com</span>
<span class="linenos">71</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">map-migrated</span>
<span class="linenos">72</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">d-server-00c79yzv8q8cvz</span>
<span class="linenos">73</span><span class="w">      </span><span class="nt">RoleName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-SSMNotificationRole</span>
<span class="linenos">74</span><span class="w">      </span><span class="nt">AssumeRolePolicyDocument</span><span class="p">:</span>
<span class="linenos">75</span><span class="w">        </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
</pre></div>
</div>
</div>
</section>
<section id="ssmagentactivationrole">
<h4>SSMAgentActivationRole<a class="headerlink" href="#ssmagentactivationrole" title="Permalink to this headline"></a></h4>
<p>This section defines the IAM Role. The IAM Role is used to allow the Lambda function to activate the SSM Agent.</p>
<div class="literal-block-wrapper docutils container" id="id31">
<div class="code-block-caption"><span class="caption-text">template.yaml - SSMAgentActivationRole</span><a class="headerlink" href="#id31" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">        </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos"> 2</span><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos"> 3</span><span class="w">            </span><span class="nt">Principal</span><span class="p">:</span>
<span class="linenos"> 4</span><span class="w">              </span><span class="nt">Service</span><span class="p">:</span>
<span class="linenos"> 5</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lambda.amazonaws.com</span>
<span class="linenos"> 6</span><span class="w">            </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos"> 7</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sts:AssumeRole</span>
<span class="linenos"> 8</span><span class="w">     </span><span class="w w-Error"> </span><span class="nt">Policies</span><span class="p">:</span>
<span class="linenos"> 9</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-CloudWatchLogsRolePolicy</span>
<span class="linenos">10</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos">11</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos">12</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">13</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">14</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">15</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:CreateLogGroup</span>
<span class="linenos">16</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:CreateLogStream</span>
<span class="linenos">17</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:PutLogEvents</span>
<span class="linenos">18</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;*&#39;</span>
<span class="linenos">19</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-SESRolePolicy</span>
<span class="linenos">20</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos">21</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos">22</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">23</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">24</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">25</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ses:SendEmail</span>
<span class="linenos">26</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ses:SendRawEmail</span>
<span class="linenos">27</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ses:ListIdentities</span>
<span class="linenos">28</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ses:VerifyEmailIdentity</span>
<span class="linenos">29</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ses:DeleteIdentity</span>
<span class="linenos">30</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ses:SendTemplatedEmail</span>
<span class="linenos">31</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ses:GetIdentityVerificationAttributes</span>
<span class="linenos">32</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;*&#39;</span>
<span class="linenos">33</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-SSMRolesPolicy</span>
<span class="linenos">34</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos">35</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos">36</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">37</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">38</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">39</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:GetCommandInvocation</span>
<span class="linenos">40</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;*&#39;</span>
<span class="linenos">41</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-DynamoDBRolePolicy</span>
<span class="linenos">42</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos">43</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos">44</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">45</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">46</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">47</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dynamodb:Query</span>
<span class="linenos">48</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dynamodb:Scan</span>
<span class="linenos">49</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dynamodb:GetItem</span>
<span class="linenos">50</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span>
<span class="linenos">51</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${DynamoDBTableTheater}*/*</span>
<span class="linenos">52</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">53</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">54</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dynamodb:PutItem</span>
<span class="linenos">55</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span>
<span class="linenos">56</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DynamoDBTableStatus.Arn</span>
<span class="linenos">57</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-XRayRolePolicy</span>
<span class="linenos">58</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos">59</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos">60</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
</pre></div>
</div>
</div>
</section>
<section id="ssmagentrole">
<h4>SSMAgentRole<a class="headerlink" href="#ssmagentrole" title="Permalink to this headline"></a></h4>
<p>This section defines the IAM Role. The IAM Role is used to allow the Lambda function to run the SSM Run document on managed instance.</p>
<div class="literal-block-wrapper docutils container" id="id32">
<div class="code-block-caption"><span class="caption-text">template.yaml - SSMAgentRole</span><a class="headerlink" href="#id32" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos"> 2</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos"> 3</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xray:PutTraceSegments</span>
<span class="linenos"> 4</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xray:PutTelemetryRecords</span>
<span class="linenos"> 5</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;*&#39;</span>
<span class="linenos"> 6</span><span class="w">       </span><span class="w w-Error"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-S3RolePolicy</span>
<span class="linenos"> 7</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos"> 8</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos"> 9</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">10</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">11</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">12</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3:ListBucket</span>
<span class="linenos">13</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:s3:::mum-pr-dcinema-deployments-s3</span>
<span class="linenos">14</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">15</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">16</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3:GetObject</span>
<span class="linenos">17</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3:GetObjectAcl</span>
<span class="linenos">18</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3:GetObjectTagging</span>
<span class="linenos">19</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3:GetObjectVersion</span>
<span class="linenos">20</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3:GetObjectVersionAcl</span>
<span class="linenos">21</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3:GetObjectVersionTagging</span>
<span class="linenos">22</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:s3:::mum-pr-dcinema-deployments-s3/*</span>
<span class="linenos">23</span><span class="w"> </span><span class="w w-Error"> </span><span class="nt">SSMActivationApi</span><span class="p">:</span>
<span class="linenos">24</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Serverless::Api</span>
<span class="linenos">25</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">26</span><span class="w">      </span><span class="nt">StageName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prod</span>
<span class="linenos">27</span><span class="w">      </span><span class="nt">DefinitionBody</span><span class="p">:</span>
<span class="linenos">28</span><span class="w">        </span><span class="nt">swagger</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2.0&#39;</span>
<span class="linenos">29</span><span class="w">        </span><span class="nt">info</span><span class="p">:</span>
<span class="linenos">30</span><span class="w">          </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2018-11-29T18:24:29Z&#39;</span>
<span class="linenos">31</span><span class="w">          </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-SSMActivation</span>
<span class="linenos">32</span><span class="w">        </span><span class="nt">paths</span><span class="p">:</span>
<span class="linenos">33</span><span class="w">          </span><span class="nt">/ssmactivation</span><span class="p">:</span>
<span class="linenos">34</span><span class="w">            </span><span class="nt">post</span><span class="p">:</span>
<span class="linenos">35</span><span class="w">              </span><span class="nt">x-amazon-apigateway-integration</span><span class="p">:</span>
<span class="linenos">36</span><span class="w">                </span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${SSMAgentActivation.Arn}/invocations</span>
<span class="linenos">37</span><span class="w">                </span><span class="nt">passthroughBehavior</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">when_no_match</span>
<span class="linenos">38</span><span class="w">                </span><span class="nt">httpMethod</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POST</span>
<span class="linenos">39</span><span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws_proxy</span>
<span class="linenos">40</span><span class="w">              </span><span class="nt">responses</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="linenos">41</span><span class="w">              </span><span class="nt">security</span><span class="p">:</span>
<span class="linenos">42</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ApiKeyAuth</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="linenos">43</span><span class="w">          </span><span class="nt">/addtags</span><span class="p">:</span>
<span class="linenos">44</span><span class="w">            </span><span class="nt">post</span><span class="p">:</span>
<span class="linenos">45</span><span class="w">              </span><span class="nt">x-amazon-apigateway-integration</span><span class="p">:</span>
<span class="linenos">46</span><span class="w">                </span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${SSMAgentActivation.Arn}/invocations</span>
<span class="linenos">47</span><span class="w">                </span><span class="nt">passthroughBehavior</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">when_no_match</span>
<span class="linenos">48</span><span class="w">                </span><span class="nt">httpMethod</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POST</span>
<span class="linenos">49</span><span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws_proxy</span>
<span class="linenos">50</span><span class="w">              </span><span class="nt">responses</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="linenos">51</span><span class="w">              </span><span class="nt">security</span><span class="p">:</span>
<span class="linenos">52</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ApiKeyAuth</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="linenos">53</span><span class="w">  </span><span class="nt">SSMInstallScriptGenerator</span><span class="p">:</span>
<span class="linenos">54</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Serverless::Function</span>
<span class="linenos">55</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">56</span><span class="w">      </span><span class="nt">CodeUri</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./functions/SSMInstallScriptGenerator/</span>
<span class="linenos">57</span><span class="w">      </span><span class="nt">Handler</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">index.lambda_handler</span>
<span class="linenos">58</span><span class="w">      </span><span class="nt">Runtime</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python3.8</span>
<span class="linenos">59</span><span class="w">      </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Generates SSM agent Install Script for Linux</span>
<span class="linenos">60</span><span class="w">      </span><span class="nt">Role</span><span class="p">:</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SSMInstallScriptGeneratorRole.Arn</span>
<span class="linenos">61</span><span class="w">      </span><span class="nt">Layers</span><span class="p">:</span>
<span class="linenos">62</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CommonLambdaLayer</span>
<span class="linenos">63</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:lambda:${AWS::Region}:017000801446:layer:AWSLambdaPowertoolsPythonV2:19</span>
<span class="linenos">64</span><span class="w">      </span><span class="nt">Environment</span><span class="p">:</span>
<span class="linenos">65</span><span class="w">        </span><span class="nt">Variables</span><span class="p">:</span>
<span class="linenos">66</span><span class="w">          </span><span class="nt">ONBOARD_TENANT_URL</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://${SSMActivationApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/ssmactivation</span>
<span class="linenos">67</span><span class="w">          </span><span class="nt">SAVE_ACTIVATION_URL</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://${SSMActivationApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/addtags</span>
<span class="linenos">68</span><span class="w">          </span><span class="nt">POWERTOOLS_SERVICE_NAME</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SSMInstallScriptGenerator</span>
<span class="linenos">69</span><span class="w">          </span><span class="nt">POWERTOOLS_METRICS_NAMESPACE</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SSMInstallScriptGenerator</span>
<span class="linenos">70</span><span class="w">          </span><span class="nt">LOG_LEVEL</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">INFO</span>
<span class="linenos">71</span><span class="w">      </span><span class="nt">Events</span><span class="p">:</span>
<span class="linenos">72</span><span class="w">        </span><span class="nt">SSMInstallScriptApi</span><span class="p">:</span>
<span class="linenos">73</span><span class="w">          </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Api</span>
</pre></div>
</div>
</div>
</section>
<section id="ssmsnspublishrole">
<h4>SSMSNSPublishRole<a class="headerlink" href="#ssmsnspublishrole" title="Permalink to this headline"></a></h4>
<p>This section defines the IAM Role. The IAM Role is used to allow the Lambda function to publish the SSM Run document status to SNS.</p>
<div class="literal-block-wrapper docutils container" id="id33">
<div class="code-block-caption"><span class="caption-text">template.yaml - SSMSNSPublishRole</span><a class="headerlink" href="#id33" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">                </span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${SSMInstallScriptGenerator.Arn}/invocations</span>
<span class="linenos"> 2</span><span class="w">                </span><span class="nt">passthroughBehavior</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">when_no_match</span>
<span class="linenos"> 3</span><span class="w">                </span><span class="nt">httpMethod</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POST</span>
<span class="linenos"> 4</span><span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws_proxy</span>
<span class="linenos"> 5</span><span class="w">             </span><span class="w w-Error"> </span><span class="nt">responses</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="linenos"> 6</span><span class="w">              </span><span class="nt">security</span><span class="p">:</span>
<span class="linenos"> 7</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ApiKeyAuth</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="linenos"> 8</span><span class="w"> </span><span class="w w-Error"> </span><span class="nt">SSMInstallScriptGeneratorRole</span><span class="p">:</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::IAM::Role</span>
<span class="linenos">10</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">11</span><span class="w">      </span><span class="nt">Tags</span><span class="p">:</span>
<span class="linenos">12</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Project</span>
<span class="linenos">13</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::StackName</span>
<span class="linenos">14</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Environment</span>
<span class="linenos">15</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prod</span>
<span class="linenos">16</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Owner</span>
<span class="linenos">17</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mondanthody.firos@primefocus.com</span>
<span class="linenos">18</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">map-migrated</span>
<span class="linenos">19</span><span class="w">          </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">d-server-00c79yzv8q8cvz</span>
<span class="linenos">20</span><span class="w">      </span><span class="nt">AssumeRolePolicyDocument</span><span class="p">:</span>
<span class="linenos">21</span><span class="w">        </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2012-10-17</span>
<span class="linenos">22</span><span class="w">        </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">23</span><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">24</span><span class="w">            </span><span class="nt">Principal</span><span class="p">:</span>
<span class="linenos">25</span><span class="w">              </span><span class="nt">Service</span><span class="p">:</span>
<span class="linenos">26</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lambda.amazonaws.com</span>
<span class="linenos">27</span><span class="w">            </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">28</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sts:AssumeRole</span>
<span class="linenos">29</span><span class="w">      </span><span class="nt">Policies</span><span class="p">:</span>
<span class="linenos">30</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-SSMInstallScriptGeneratorRolePolicy</span>
</pre></div>
</div>
</div>
</section>
<section id="dashboardfunctionrole">
<h4>DashboardFunctionRole<a class="headerlink" href="#dashboardfunctionrole" title="Permalink to this headline"></a></h4>
<p>This section defines the IAM Role. The IAM Role is used to allow the Lambda function to query the SSM run commands, Cost and usage.</p>
<div class="literal-block-wrapper docutils container" id="id34">
<div class="code-block-caption"><span class="caption-text">template.yaml - DashboardFunctionRole</span><a class="headerlink" href="#id34" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">            </span><span class="nt">Principal</span><span class="p">:</span>
<span class="linenos"> 2</span><span class="w">              </span><span class="nt">Service</span><span class="p">:</span>
<span class="linenos"> 3</span><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lambda.amazonaws.com</span>
<span class="linenos"> 4</span><span class="w">            </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos"> 5</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sts:AssumeRole</span>
<span class="linenos"> 6</span><span class="w">     </span><span class="w w-Error"> </span><span class="nt">Policies</span><span class="p">:</span>
<span class="linenos"> 7</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-DynamoDBPolicy</span>
<span class="linenos"> 8</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos"> 9</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos">10</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">11</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">12</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">13</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dynamodb:PutItem</span>
<span class="linenos">14</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span>
<span class="linenos">15</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DynamoDBTableTheater.Arn</span>
<span class="linenos">16</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-CloudWatchLogsPolicy</span>
<span class="linenos">17</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos">18</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos">19</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">20</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">21</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">22</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:CreateLogGroup</span>
<span class="linenos">23</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:CreateLogStream</span>
<span class="linenos">24</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs:PutLogEvents</span>
<span class="linenos">25</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;*&#39;</span>
<span class="linenos">26</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-IAMPassRolePolicy</span>
<span class="linenos">27</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos">28</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos">29</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">30</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">31</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">32</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">iam:PassRole</span>
<span class="linenos">33</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SSMAgentRole.Arn</span>
<span class="linenos">34</span><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AWS::StackName}-SSMRunDocumentPolicy</span>
<span class="linenos">35</span><span class="w">          </span><span class="nt">PolicyDocument</span><span class="p">:</span>
<span class="linenos">36</span><span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span>
<span class="linenos">37</span><span class="w">            </span><span class="nt">Statement</span><span class="p">:</span>
<span class="linenos">38</span><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
<span class="linenos">39</span><span class="w">                </span><span class="nt">Action</span><span class="p">:</span>
<span class="linenos">40</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:CreateActivation</span>
<span class="linenos">41</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:AddTagsToResource</span>
<span class="linenos">42</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:PutParameter</span>
<span class="linenos">43</span><span class="w">                  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ssm:GetParameter</span>
<span class="linenos">44</span><span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;*&#39;</span>
<span class="linenos">45</span><span class="w"> </span><span class="w w-Error"> </span><span class="nt">SSMAgentRole</span><span class="p">:</span>
<span class="linenos">46</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::IAM::Role</span>
<span class="linenos">47</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">48</span><span class="w">      </span><span class="nt">Tags</span><span class="p">:</span>
</pre></div>
</div>
</div>
</section>
<section id="statemachineapirole">
<h4>StateMachineApiRole<a class="headerlink" href="#statemachineapirole" title="Permalink to this headline"></a></h4>
<p>This section defines the IAM Role. The IAM Role is used to allow the Step Functions to invoke the Lambda function.</p>
<div class="literal-block-wrapper docutils container" id="id35">
<div class="code-block-caption"><span class="caption-text">template.yaml - StateMachineApiRole</span><a class="headerlink" href="#id35" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::SSM::Parameter</span>
<span class="linenos"> 2</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos"> 3</span><span class="w">      </span><span class="nt">Tags</span><span class="p">:</span>
<span class="linenos"> 4</span><span class="w">        </span><span class="nt">Project</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::StackName</span>
<span class="linenos"> 5</span><span class="w">        </span><span class="nt">Environment</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prod</span>
<span class="linenos"> 6</span><span class="w">        </span><span class="nt">Owner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mondanthody.firos@primefocus.com</span>
<span class="linenos"> 7</span><span class="w">        </span><span class="nt">Usage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Port</span>
<span class="linenos"> 8</span><span class="w">        </span><span class="nt">map-migrated</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">d-server-00c79yzv8q8cvz</span>
<span class="linenos"> 9</span><span class="w">      </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/${AWS::StackName}/expedat/port</span>
<span class="linenos">10</span><span class="w">      </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">String</span>
<span class="linenos">11</span><span class="w">      </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ExpedatPort</span>
<span class="linenos">12</span><span class="w">      </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Expedat Port</span>
<span class="linenos">13</span><span class="w">      </span><span class="nt">Tier</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Standard</span>
<span class="linenos">14</span><span class="w"> </span><span class="w w-Error"> </span><span class="nt">SSMActivationParameter</span><span class="p">:</span>
<span class="linenos">15</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::SSM::Parameter</span>
<span class="linenos">16</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">17</span><span class="w">      </span><span class="nt">Tags</span><span class="p">:</span>
<span class="linenos">18</span><span class="w">        </span><span class="nt">Project</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::StackName</span>
<span class="linenos">19</span><span class="w">        </span><span class="nt">Environment</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prod</span>
<span class="linenos">20</span><span class="w">        </span><span class="nt">Owner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mondanthody.firos@primefocus.com</span>
<span class="linenos">21</span><span class="w">        </span><span class="nt">Usage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Port</span>
<span class="linenos">22</span><span class="w">        </span><span class="nt">map-migrated</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">d-server-00c79yzv8q8cvz</span>
<span class="linenos">23</span><span class="w">      </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/${AWS::StackName}/ssm/activation</span>
</pre></div>
</div>
</div>
</section>
</section>
</section>
<section id="outputs">
<h2>Outputs<a class="headerlink" href="#outputs" title="Permalink to this headline"></a></h2>
<p>This section defines the Outputs. The Outputs is used to display the API Gateway URL, Dashboard URL and Installation script URL.</p>
<div class="literal-block-wrapper docutils container" id="id36">
<div class="code-block-caption"><span class="caption-text">template.yaml - Outputs</span><a class="headerlink" href="#id36" title="Permalink to this code"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">      </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">String</span>
<span class="linenos"> 2</span><span class="w">      </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{</span><span class="nv"> </span><span class="s">&quot;Expiration&quot;:</span><span class="nv"> </span><span class="s">&quot;2021-12-31&quot;,</span><span class="nv"> </span><span class="s">&quot;RegistrationLimit&quot;:</span><span class="nv"> </span><span class="s">200,</span><span class="nv"> </span><span class="s">&quot;ActiveCount&quot;:</span><span class="nv"> </span><span class="s">200,</span><span class="nv"> </span><span class="s">&quot;ActivationId&quot;:</span><span class="nv"> </span><span class="s">&quot;placeholder&quot;,</span><span class="nv"> </span><span class="s">&quot;ActivationCode&quot;:</span><span class="nv"> </span><span class="s">&quot;placeholder&quot;</span><span class="nv">  </span><span class="s">}&#39;</span>
<span class="linenos"> 3</span><span class="w">      </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SSM Activation Details</span>
<span class="linenos"> 4</span><span class="w">      </span><span class="nt">Tier</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Standard</span>
<span class="linenos"> 5</span><span class="w">   </span><span class="w w-Error"> </span><span class="nt">UpdateReplacePolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Retain</span>
<span class="linenos"> 6</span><span class="w">    </span><span class="nt">DeletionPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Retain</span>
<span class="linenos"> 7</span><span class="w"> </span><span class="w w-Error"> </span><span class="nt">LogParserParameter</span><span class="p">:</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::SSM::Parameter</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="linenos">10</span><span class="w">      </span><span class="nt">Tags</span><span class="p">:</span>
<span class="linenos">11</span><span class="w">        </span><span class="nt">Project</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::StackName</span>
<span class="linenos">12</span><span class="w">        </span><span class="nt">Environment</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prod</span>
<span class="linenos">13</span><span class="w">        </span><span class="nt">Owner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mondanthody.firos@primefocus.com</span>
<span class="linenos">14</span><span class="w">        </span><span class="nt">Usage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LogParser</span>
<span class="linenos">15</span><span class="w">        </span><span class="nt">map-migrated</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">d-server-00c79yzv8q8cvz</span>
<span class="linenos">16</span><span class="w">      </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/${AWS::StackName}/logparser</span>
<span class="linenos">17</span><span class="w">      </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">String</span>
</pre></div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Welcome to DCinema Distribution AWS documentation!" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="modules.html" class="btn btn-neutral float-right" title="Lambda Function" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Prime Focus.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>